index.jsx:
import React from 'react';
import ReactDOM from 'react-dom/client';
import './index.css';
import App from './App.jsx';
import { HashRouter } from 'react-router-dom';
import reportWebVitals from './reportWebVitals';

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <React.StrictMode>
    <HashRouter>
      <App />
    </HashRouter>
  </React.StrictMode>
);

reportWebVitals();


index.css:
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;700&display=swap');

* {
  font-family: 'Plus Jakarta Sans', sans-serif;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

code {
  font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
    monospace;
}


Operador.jsx:
import "./Operador.css";
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import DatosAutoSalida from './DatosAutoSalida/DatosAutoSalida';
import DatosPago from './DatosPago/DatosPago';
import DatosAutoEntrada from './DatosAutoEntrada/DatosAutoEntrada';

function Operador({ ticketPendiente, onAbrirBarreraSalida, setTicketPendiente, autoFocusSalida = true }) {
  const [vehiculoLocal, setVehiculoLocal] = useState(null);
  const [resetInput, setResetInput] = useState(false);
  const [error, setError] = useState(null);
  const [tarifaCalculada, setTarifaCalculada] = useState(null);
  const [user, setUser] = useState(null);
  const [timestamp, setTimestamp] = useState(Date.now());
  const navigate = useNavigate();

  // --- Perfil de usuario (una sola vez, sin duplicar lÃ³gica) ---
  const fetchUser = async () => {
    const token = localStorage.getItem('token');
    if (!token) {
      navigate('/login');
      return null;
    }
    try {
      const response = await fetch('http://localhost:5000/api/auth/profile', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
        credentials: 'include'
      });
      const data = await response.json();
      if (response.ok) return data;
      throw new Error(data.message || 'Failed to fetch user');
    } catch (error) {
      console.error('Error:', error);
      localStorage.removeItem('token');
      navigate('/login');
      return null;
    }
  };

  useEffect(() => {
    const loadUser = async () => {
      const userData = await fetchUser();
      if (userData) setUser(userData);
    };
    loadUser();
  }, [navigate]);

  // --- Refresco de timestamp para foto de entrada en lateral ---
  useEffect(() => {
    const interval = setInterval(() => setTimestamp(Date.now()), 5000);
    return () => clearInterval(interval);
  }, []);

  const limpiarVehiculo = () => {
    setVehiculoLocal(null);
    setError(null);
    setResetInput(prev => !prev);
    setTarifaCalculada(null);
  };

  const buscarVehiculo = async (patente) => {
    try {
      const patenteMayuscula = patente.toUpperCase();
      const response = await fetch(`http://localhost:5000/api/vehiculos/${patenteMayuscula}`);
      if (!response.ok) throw new Error("VehÃ­culo no encontrado");
      const data = await response.json();
      setVehiculoLocal(data);
      setError(null);
    } catch (err) {
      setVehiculoLocal(null);
      setError(err.message);
    }
  };

  return (
    <div className="contenidoCentral">
      <div className="izquierda">
        <DatosAutoEntrada
          user={user}
          ticketPendiente={ticketPendiente}
          onClose={() => setTicketPendiente(null)}
          setTicketPendiente={setTicketPendiente}
          timestamp={timestamp}
          // âš ï¸ En el panel lateral NO autoenfocamos nada
        />
      </div>

      <div className="derecha">
        <DatosAutoSalida
          buscarVehiculo={buscarVehiculo}
          error={error}
          vehiculoLocal={vehiculoLocal}
          limpiarInputTrigger={resetInput}
          onActualizarVehiculoLocal={setVehiculoLocal}
          onTarifaCalculada={setTarifaCalculada}
          // â¬‡ï¸ autofocus controlado por Interfaz (false si hay modal)
          autoFocusActivo={autoFocusSalida}
        />
        <DatosPago
          vehiculoLocal={vehiculoLocal}
          tarifaCalculada={tarifaCalculada}
          limpiarVehiculo={limpiarVehiculo}
          user={user}
          onAbrirBarreraSalida={onAbrirBarreraSalida}
        />
      </div>
    </div>
  );
}

export default Operador;


Operador.css:
.contenidoCentral {
  display: flex;
  height: calc(100vh - 60px); 
  width: 100%;
  max-width: 100%;
  max-height: 100%;
  box-sizing: border-box;
  align-items: center;
}
.contenidoCentral > *:first-child {
  position: relative;
}
.contenidoCentral > *:first-child::after {
  content: "";
  position: absolute;
  right: -1px;
  top: 0;
  bottom: 0;
  width: 2px;
  background-color: #2a2a38; /* o probÃ¡ con #39414f */
  height: 98%;
}
.contenidoCentral img {
  width: 100%;
}

.izquierda {
  flex: 1;
  padding: 6px 10px 10px 10px;
}
.derecha {
  flex: 1.5;
  padding: 6.6px 10px 10px 10px;
}

DatosPago.jsx:
// src/Operador/Operador/DatosPago/DatosPago.jsx
import React, { useState, useEffect, useRef } from "react";
import "./DatosPago.css";
import ModalMensaje from "../../ModalMensaje/ModalMensaje";
import { useTarifasData, calcularAmbosPrecios, armarParametrosTiempo } from "../../../hooks/tarifasService";

const BASE_URL = "http://localhost:5000";
const PROMOS_POLL_MS = 180000; // 3 min

// ===== DEBUG helpers =====
const DBG = true;
const log = (...args) => DBG && console.log("[DatosPago]", ...args);
const group = (title) => DBG && console.group("[DatosPago]", title);
const groupEnd = () => DBG && console.groupEnd();

function DatosPago({
  vehiculoLocal,
  limpiarVehiculo,
  tarifaCalculada,
  user,
  onAbrirBarreraSalida,
}) {
  // â¬‡ï¸ ahora SIN default
  const [metodoPago, setMetodoPago] = useState(null); // "Efectivo" | "Transferencia" | "DÃ©bito" | "CrÃ©dito" | "QR" | null
  const [factura, setFactura] = useState(null);       // "CC" | "A" | "Final" | null

  const [promos, setPromos] = useState([]);
  const [promoSeleccionada, setPromoSeleccionada] = useState(null);
  const [tiempoEstadiaHoras, setTiempoEstadiaHoras] = useState(0);

  const [costoTotal, setCostoTotal] = useState(0);
  const [totalConDescuento, setTotalConDescuento] = useState(0);
  const [tarifaAplicada, setTarifaAplicada] = useState(null);
  const [horaSalida, setHoraSalida] = useState(null);

  // catÃ¡logo para fallback
  const { tarifas, preciosEfectivo, preciosOtros, parametros } = useTarifasData();

  // â¬…ï¸ para que el fallback corra una sola vez como â€œparcheâ€
  const didFallbackCalcRef = useRef(false);

  // ---- DEBUG: montaje/desmontaje
  useEffect(() => {
    group("MOUNT");
    log("montado");
    groupEnd();
    return () => {
      group("UNMOUNT");
      log("desmontado");
      groupEnd();
    };
  }, []);

  // ---- DEBUG: props
  useEffect(() => {
    group("PROP change: tarifaCalculada");
    log("tarifaCalculada recibida:", JSON.stringify(tarifaCalculada));
    groupEnd();

    if (tarifaCalculada?.salida) setHoraSalida(tarifaCalculada.salida);
    if (tarifaCalculada?.tarifa) setTarifaAplicada(tarifaCalculada.tarifa);

    // si llegÃ³ algo usable, no correr mÃ¡s el fallback
    if (tarifaCalculada && (
      tarifaCalculada.costo != null ||
      tarifaCalculada.costoEfectivo != null ||
      tarifaCalculada.costoOtros != null
    )) {
      didFallbackCalcRef.current = true;
    }
  }, [tarifaCalculada]);

  useEffect(() => {
    group("PROP change: vehiculoLocal");
    log("vehiculoLocal:", vehiculoLocal);
    log("estadiaActual:", vehiculoLocal?.estadiaActual);
    log("estadiaActual.costoTotal:", vehiculoLocal?.estadiaActual?.costoTotal);
    groupEnd();
  }, [vehiculoLocal]);

  // ====== Carga y auto-refresh de promos ======
  useEffect(() => {
    let timer = null;

    const loadPromos = async () => {
      try {
        const res = await fetch(`${BASE_URL}/api/promos`, { cache: "no-store" });
        if (!res.ok) throw new Error("Promos fetch failed");
        const data = await res.json();
        setPromos(Array.isArray(data) ? data : []);
        if (promoSeleccionada && !data.find(p => p._id === promoSeleccionada._id)) {
          setPromoSeleccionada(null);
        }
      } catch (err) {
        console.error("Error cargando promociones", err);
      }
    };

    loadPromos();
    timer = setInterval(loadPromos, PROMOS_POLL_MS);

    const onVis = () => document.visibilityState === "visible" && loadPromos();
    const onOnline = () => loadPromos();
    document.addEventListener("visibilitychange", onVis);
    window.addEventListener("online", onOnline);

    return () => {
      if (timer) clearInterval(timer);
      document.removeEventListener("visibilitychange", onVis);
      window.removeEventListener("online", onOnline);
    };
  }, [promoSeleccionada]);

  // âœ… al cambiar la promo recalculamos el total con descuento
  useEffect(() => {
    group("RECALC por promo/costoTotal");
    log("promoSeleccionada:", promoSeleccionada);
    log("costoTotal base:", costoTotal);
    if (promoSeleccionada) {
      const descuento = promoSeleccionada.descuento || 0;
      const nuevoTotal = (costoTotal || 0) * (1 - descuento / 100);
      log("â†’ descuento %:", descuento, "â†’ totalConDescuento:", nuevoTotal);
      setTotalConDescuento(nuevoTotal);
    } else {
      log("â†’ sin promo, totalConDescuento = costoTotal");
      setTotalConDescuento(costoTotal || 0);
    }
    groupEnd();
  }, [promoSeleccionada, costoTotal]);

  const handleSeleccionPromo = (e) => {
    const idSeleccionado = e.target.value;
    const promo = promos.find((p) => p._id === idSeleccionado);
    log("Seleccion promo:", idSeleccionado, "â†’", promo);
    setPromoSeleccionada(promo || null);
  };

  // ðŸ” Fallback: si NO llega tarifaCalculada usable, calculo yo (SOLO UNA VEZ)
  useEffect(() => {
    const entrada = vehiculoLocal?.estadiaActual?.entrada;
    const salida = vehiculoLocal?.estadiaActual?.salida;
    if (!vehiculoLocal || !entrada || !salida) return;

    const noHayTarifa =
      !tarifaCalculada ||
      (
        tarifaCalculada.costo == null &&
        tarifaCalculada.costoEfectivo == null &&
        tarifaCalculada.costoOtros == null
      );

    if (!noHayTarifa) return;            // ya hay algo
    if (didFallbackCalcRef.current) return; // ya lo hicimos

    (async () => {
      group("FALLBACK CALC en DatosPago (no llegÃ³ tarifaCalculada)");
      try {
        const { dias, horasFormateadas } = armarParametrosTiempo(entrada, salida);
        log("params:", { dias, horasFormateadas });

        const { costoEfectivo, costoOtros } = await calcularAmbosPrecios({
          tipoVehiculo: vehiculoLocal.tipoVehiculo,
          inicio: new Date(entrada).toISOString(),
          dias,
          hora: horasFormateadas,
          tarifas,
          preciosEfectivo,
          preciosOtros,
          parametros,
        });

        didFallbackCalcRef.current = true;

        // â¬‡ï¸ si no hay mÃ©todo seleccionado, NO fijamos costo todavÃ­a
        if (!metodoPago) {
          log("Sin mÃ©todo seleccionado â†’ no seteo costoTotal en fallback (queda 0 hasta elegir)");
        } else {
          const elegido = metodoPago === "Efectivo" ? costoEfectivo : costoOtros;
          log("resultado fallback â†’ elegido:", elegido);
          setCostoTotal(elegido || 0);
        }
      } catch (e) {
        console.error("fallback cÃ¡lculo DatosPago:", e.message);
      } finally {
        groupEnd();
      }
    })();
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [vehiculoLocal, tarifas, preciosEfectivo, preciosOtros, parametros, metodoPago]);

  // Helper: bucket de mÃ©todo
  const metodoEsEfectivo = (m) => m === "Efectivo";
  const metodoEsOtros = (m) => m && m !== "Efectivo";

  // NUEVO: precio = 0 hasta elegir mÃ©todo
  useEffect(() => {
    group("RECALC por mÃ©todo/tarifa/vehiculo");
    log("metodoPago:", metodoPago);

    // â›” Si NO eligiÃ³ mÃ©todo â†’ mostrar 0 siempre
    if (!metodoPago) {
      log("Sin mÃ©todo â†’ costoTotal = 0");
      setCostoTotal(0);
      groupEnd();
      return;
    }

    // âœ” Si eligiÃ³ mÃ©todo â†’ usar la tarifa que vino
    let elegido = null;

    if (metodoEsEfectivo(metodoPago)) {
      elegido = tarifaCalculada?.costoEfectivo ?? tarifaCalculada?.costo ?? 0;
    } else {
      elegido = tarifaCalculada?.costoOtros ?? tarifaCalculada?.costo ?? 0;
    }

    log("â†’ base que se setea en costoTotal:", elegido);
    setCostoTotal(elegido);

    groupEnd();
  }, [metodoPago, tarifaCalculada, vehiculoLocal]);

  // ====== Tiempo de estadÃ­a y compat SIN pisar selecciÃ³n ======
  useEffect(() => {
    if (!vehiculoLocal) return;
    group("RECALC tiempo estadÃ­a / compat");

    const estadia = vehiculoLocal.estadiaActual;
    if (!estadia || !estadia.entrada) {
      log("â†’ sin estadia/entrada; horas = 0");
      setTiempoEstadiaHoras(0);
      groupEnd();
      return;
    }

    const entrada = new Date(estadia.entrada);
    const salida = horaSalida ? new Date(horaSalida) : new Date();
    const diffMs = salida - entrada;

    if (diffMs <= 0) {
      log("â†’ diffMs <= 0; horas = 0");
      setTiempoEstadiaHoras(0);
      groupEnd();
      return;
    }

    const horas = Math.max(Math.ceil(diffMs / (1000 * 60 * 60)), 1);
    setTiempoEstadiaHoras(horas);
    log("entrada:", entrada.toISOString(), "salida:", salida.toISOString(), "horas redondeadas:", horas);

    // â›” NO pisar si ya tenemos tarifaCalculada Ãºtil
    const hayTarifaUtil = !!tarifaCalculada && (
      tarifaCalculada.costo != null ||
      tarifaCalculada.costoEfectivo != null ||
      tarifaCalculada.costoOtros != null
    );

    if (!hayTarifaUtil && estadia.costoTotal != null && metodoPago) {
      log("Compat: arrastro costoTotal de estadia:", estadia.costoTotal);
      setCostoTotal(estadia.costoTotal);
    }

    setTarifaAplicada(estadia.tarifa || null);
    groupEnd();
  }, [vehiculoLocal, horaSalida, tarifaCalculada, metodoPago]);

  useEffect(() => { log("ðŸš— vehiculoLocal en DatosPago:", vehiculoLocal); }, [vehiculoLocal]);

  // Reset al limpiar
  useEffect(() => {
    if (!vehiculoLocal) {
      group("RESET por vehiculoLocal=null");
      log("Reseteando campos de pago, webcam y mensajes");
      groupEnd();

      resetCamposPago();
      setPromoFoto(null);
      setCapturaTemporal(null);

      // âœ” NO BORRAR EL MODAL INMEDIATO â†’ dejarlo vivir si fue reciÃ©n disparado
      setTimeout(() => {
        setMensajeModal(null);
      }, 50);

      if (modalCamAbierto) cerrarModalCam();
    }
  }, [vehiculoLocal]);

  const handleSelectMetodoPago = (metodo) => { log("Click mÃ©todo de pago:", metodo); setMetodoPago(metodo); };
  const handleSelectFactura = (opcion)   => { log("Click factura:", opcion); setFactura(opcion); };

  const resetCamposPago = () => {
    log("resetCamposPago()");
    setMetodoPago(null);
    setFactura(null);
    setPromoSeleccionada(null);
    setTiempoEstadiaHoras(0);
    setCostoTotal(0);
    setTarifaAplicada(null);
    setHoraSalida(null);
    setTotalConDescuento(0);
  };

  // ====== Webcam ======
  const [modalCamAbierto, setModalCamAbierto] = useState(false);
  const [videoStream, setVideoStream] = useState(null);
  const [capturaTemporal, setCapturaTemporal] = useState(null);
  const [promoFoto, setPromoFoto] = useState(null);
  const videoRef = React.useRef(null);

  const [selectedDeviceId, setSelectedDeviceId] = useState(null);
  const [mensajeModal, setMensajeModal] = useState(null);

  useEffect(() => {
    (async () => {
      try {
        const r = await fetch(`${BASE_URL}/api/webcam`);
        if (r.ok) {
          const data = await r.json();
          if (data?.webcam) {
            log("webcam device desde API:", data.webcam);
            setSelectedDeviceId(data.webcam);
            localStorage.setItem("webcamDeviceId", data.webcam);
            return;
          }
        }
      } catch (_) { /* ignore */ }
      const ls = localStorage.getItem("webcamDeviceId");
      if (ls) {
        log("webcam device desde localStorage:", ls);
        setSelectedDeviceId(ls);
      }
    })();
  }, []);

  const getStream = async () => {
    const tryList = [
      selectedDeviceId ? { video: { deviceId: { exact: selectedDeviceId } } } : null,
      { video: { facingMode: { ideal: "environment" } } },
      { video: true },
    ].filter(Boolean);

    let lastErr = null;
    for (const constraints of tryList) {
      try { return await navigator.mediaDevices.getUserMedia(constraints); }
      catch (e) { lastErr = e; }
    }
    throw lastErr || new Error("No se pudo abrir ninguna cÃ¡mara");
  };

  // ==== NUEVO: helper para imprimir ticket de salida ====
  const imprimirTicketSalida = async (salidaFinalISO, ticketPago) => {
    try {
      const payload = {
        ticketNumero: vehiculoLocal?.estadiaActual?.ticket,
        ingreso: vehiculoLocal?.estadiaActual?.entrada,
        egreso: salidaFinalISO,
        totalConDescuento,
        patente: vehiculoLocal?.patente,
        tipoVehiculo: vehiculoLocal?.tipoVehiculo,
        ticketPago
      };

      log("POST /api/tickets/imprimir-salida payload:", payload);

      // =============== ðŸ”¥ 1Â° impresiÃ³n ===============
      let r1 = await fetch(`${BASE_URL}/api/tickets/imprimir-salida`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!r1.ok) {
        console.error("âŒ Error en primer ticket:");
        console.error(await r1.text().catch(() => ""));
        return false;
      }

      // =============== ðŸ”¥ 2Â° impresiÃ³n ===============
      let r2 = await fetch(`${BASE_URL}/api/tickets/imprimir-salida`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!r2.ok) {
        console.error("âŒ Error en segundo ticket:");
        console.error(await r2.text().catch(() => ""));
        return false;
      }

      return true;
    } catch (e) {
      console.error("âŒ ExcepciÃ³n al imprimir ticket de salida:", e);
      return false;
    }
  };

  const registrarMovimiento = () => {
    if (!vehiculoLocal?.patente) return;

    // â›” Validaciones duras: requiere mÃ©todo y factura
    if (!metodoPago || !factura) {
      setMensajeModal({
        tipo: "error",
        titulo: "Faltan datos",
        mensaje: !metodoPago && !factura
          ? "SeleccionÃ¡ un mÃ©todo de pago y un tipo de factura."
          : !metodoPago
          ? "SeleccionÃ¡ un mÃ©todo de pago."
          : "SeleccionÃ¡ un tipo de factura.",
      });
      return;
    }

    const token = localStorage.getItem("token") || "";

    // Tiempos (MISMA salida para todo el flujo)
    const entradaFinalISO = vehiculoLocal?.estadiaActual?.entrada
      ? new Date(vehiculoLocal.estadiaActual.entrada).toISOString()
      : null;

    const salidaFinalISO =
      horaSalida
        ? new Date(horaSalida).toISOString()
        : vehiculoLocal?.estadiaActual?.salida
        ? new Date(vehiculoLocal.estadiaActual.salida).toISOString()
        : new Date().toISOString();

    // Texto
    const horas = tiempoEstadiaHoras || 1;
    const descripcion = `Pago por ${horas} Hora${horas > 1 ? "s" : ""}`;

    const fotoMovimiento = vehiculoLocal?.estadiaActual?.fotoUrl || null;

    group("REGISTRAR MOVIMIENTO payload (via registrarSalida)");
    log("metodoPago:", metodoPago, "factura:", factura);
    log("monto final (con promos):", totalConDescuento);
    log("tarifaAplicada:", tarifaAplicada);
    log("tiempoHoras:", horas);
    log("entradaFinalISO:", entradaFinalISO, "salidaFinalISO:", salidaFinalISO);
    groupEnd();

    // ðŸ”¥ 1) Registrar salida EN EL BACK (que adentro crea el movimiento)
    fetch(`${BASE_URL}/api/vehiculos/${vehiculoLocal.patente}/registrarSalida`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        ...(token ? { Authorization: `Bearer ${token}` } : {}),
      },
      body: JSON.stringify({
        salida: salidaFinalISO,
        costo: totalConDescuento,
        tarifa: tarifaAplicada || null,
        tiempoHoras: horas,

        metodoPago,
        factura,
        tipoTarifa: "hora",
        descripcion,
        fotoUrl: fotoMovimiento || null,

        // ðŸ”¥ AGREGO ESTO
        operador: {
          username: user?.username,
          nombre: user?.nombre,
          apellido: user?.apellido,
          email: user?.email,
          _id: user?._id || user?.id,
        },
        operadorUsername: user?.username,
        operadorId: user?._id || user?.id,

        promo: promoSeleccionada
          ? {
              _id: promoSeleccionada._id,
              nombre: promoSeleccionada.nombre,
              descuento: promoSeleccionada.descuento,
              ...(promoFoto ? { fotoUrl: promoFoto } : {}),
            }
          : undefined,
      })
    })
      .then(async (res) => {
        const json = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(json?.msg || "Error al registrar salida");
        return json; // { msg, estadia, movimiento, turnoUsado, vehiculo }
      })
      .then(async (resp) => {
        const mov = resp?.movimiento || null;

        if (!mov) {
          throw new Error("Salida registrada pero no se generÃ³ movimiento.");
        }

        // 2) Imprimir ticket usando la MISMA salida
        await imprimirTicketSalida(salidaFinalISO, mov.ticketPago);

        setMensajeModal({
          tipo: "exito",
          titulo: "Movimiento registrado",
          mensaje: `âœ… Movimiento registrado para ${vehiculoLocal.patente}`,
        });

        limpiarVehiculo?.();
        resetCamposPago();
        setPromoFoto(null);
        setCapturaTemporal(null);
        if (onAbrirBarreraSalida) onAbrirBarreraSalida();
      })
      .catch((err) => {
        console.error("âŒ Error en salida/movimiento:", err);
        setMensajeModal({
          tipo: "error",
          titulo: "Error",
          mensaje: err?.message || "No se pudo completar la operaciÃ³n.",
        });
      });
  };

  // ====== CÃ¡mara (modal) â€“ SOLO para FOTO DE PROMO ======
  const abrirModalCam = async () => {
    setCapturaTemporal(null);
    try {
      const stream = await getStream();
      setVideoStream(stream);
      setModalCamAbierto(true);
    } catch {
      setVideoStream(null);
      setMensajeModal({ tipo: "error", titulo: "Error de cÃ¡mara", mensaje: "No se pudo acceder a la webcam." });
    }
  };

  const tomarFoto = () => {
    if (!videoRef.current) return;
    const canvas = document.createElement("canvas");
    canvas.width = videoRef.current.videoWidth;
    canvas.height = videoRef.current.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(videoRef.current, 0, 0, canvas.width, canvas.height);
    setCapturaTemporal(canvas.toDataURL("image/png"));
  };

  const reintentarFoto = async () => {
    setCapturaTemporal(null);
    try {
      if (videoStream) return;
      const stream = await getStream();
      setVideoStream(stream);
    } catch {
      setVideoStream(null);
      setMensajeModal({ tipo: "error", titulo: "Error de cÃ¡mara", mensaje: "No se pudo acceder a la webcam." });
    }
  };

  const aceptarFotoPromo = () => { if (capturaTemporal) { setPromoFoto(capturaTemporal); cerrarModalCam(); } };

  useEffect(() => { if (videoRef.current && videoStream) videoRef.current.srcObject = videoStream; }, [videoStream]);

  const cerrarModalCam = () => {
    setModalCamAbierto(false);
    if (videoStream) {
      videoStream.getTracks().forEach((track) => track.stop());
      setVideoStream(null);
    }
    setCapturaTemporal(null);
  };

  useEffect(() => {
    return () => { if (videoStream) videoStream.getTracks().forEach((t) => t.stop()); };
  }, [videoStream]);

  return (
    <div className="datosPago">
      {/* === AHORA ARRIBA: MÃ‰TODO DE PAGO + FACTURA === */}
      <div className="precioEspecificaciones">
        <div>
          <div className="title">MÃ©todo de Pago</div>
          <div className="metodoDePago">
            {["Efectivo", "Transferencia", "DÃ©bito", "CrÃ©dito", "QR"].map((metodo) => (
              <div
                key={metodo}
                className={`metodoOption ${metodoPago === metodo ? "selected" : ""}`}
                onClick={() => handleSelectMetodoPago(metodo)}
              >
                {metodo}
              </div>
            ))}
          </div>
        </div>

        <div>
          <div className="title">Factura</div>
          <div className="factura">
            {["CC", "A", "Final"].map((opcion) => (
              <div
                key={opcion}
                className={`facturaOption ${factura === opcion ? "selected" : ""}`}
                onClick={() => handleSelectFactura(opcion)}
              >
                {opcion}
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* === AHORA ABAJO: PRECIO FINAL + PROMO + FOTO === */}
      <div className="precioTotal">
        <div className="precioContainer">
          ${totalConDescuento.toLocaleString("es-AR")}
        </div>
        <div className="promo">
          <select className="promoSelect" value={promoSeleccionada?._id || "none"} onChange={handleSeleccionPromo}>
            <option value="none">SeleccionÃ¡ una Promo</option>
            {promos?.map((promo) => (
              <option key={promo._id} value={promo._id}>
                {promo.nombre} ({promo.descuento}%)
              </option>
            ))}
          </select>

          <button
            type="button"
            className={`iconContainer ${promoFoto ? "withPhoto" : ""}`}
            onClick={abrirModalCam}
            title={promoFoto ? "Foto de promo cargada" : "Tomar foto para promo"}
          >
            {!promoFoto ? (
              <img src="https://www.svgrepo.com/show/904/photo-camera.svg" alt="" className="camIcon" />
            ) : (
              <span className="promoCheck">âœ”</span>
            )}
          </button>
        </div>
      </div>

      <button className="btn-salida" onClick={registrarMovimiento}>â¬† SALIDA</button>

      {mensajeModal && (
        <ModalMensaje
          tipo={mensajeModal.tipo}
          titulo={mensajeModal.titulo}
          mensaje={mensajeModal.mensaje}
          onClose={() => setMensajeModal(null)}
        />
      )}

      {modalCamAbierto && (
        <ModalMensaje titulo="Webcam" mensaje="Foto para Promo" onClose={cerrarModalCam}>
          <div style={{ textAlign: "center" }}>
            {!capturaTemporal ? (
              <>
                <video ref={videoRef} autoPlay style={{ width: "320px", height: "240px", borderRadius: "6px", background: "#222" }} />
                <button className="guardarWebcamBtn" style={{ marginTop: "1rem" }} onClick={tomarFoto}>Tomar Foto</button>
              </>
            ) : (
              <>
                <img src={capturaTemporal} alt="Foto tomada" style={{ width: "320px", borderRadius: "6px" }} />
                <div style={{ marginTop: "1rem", display: "flex", gap: "10px", justifyContent: "center" }}>
                  <button className="guardarWebcamBtn" onClick={reintentarFoto}>Reintentar</button>
                  <button className="guardarWebcamBtn aceptarBtn" onClick={aceptarFotoPromo}>Aceptar</button>
                </div>
              </>
            )}
          </div>
        </ModalMensaje>
      )}
    </div>
  );
}

export default DatosPago;

DatosPago.css:
.datosPago {
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow-y: auto;
  background-color: #1f1f28;
}

.precioTotal {
  display: flex;
  align-items: center;
  font-size: 50px;
  font-weight: bold;
  color: white;
  width: 100%;
  max-width: 600px;
  padding: 10px 0px;
}

.precioContainer {
  padding-right: 15px;
}

.precioEspecificaciones {
  display: flex;
  flex-direction: row;
  text-align: left;
  font-size: 16px;
  gap: 30px;
  color: #cfd8dc;
}

.metodoDePago, .factura {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 10px;
}

.title {
  font-size: 15px;
  font-weight: bold;
  color: #e7f3ff;
  margin-bottom: 10px;
  position: relative;
}

.title::after {
  content: '';
  position: absolute;
  bottom: -5px;
  left: 0%;
  width: 80%;
  height: 2px;
  background-color: rgba(90, 153, 215, 0.53);
  border-radius: 2px;
}

.promo {
  display: flex;
  align-items: center;
  gap: 10px;
}

.promoSelect {
  background-color: #2a2a38;
  border: 2px solid #444a5a;
  padding: 8px;
  border-radius: 5px;
  font-size: 16px;
  cursor: pointer;
  color: white;
}

.iconContainer {
  background-color: #eee;
  border: 2px solid #ccc;
  border-radius: 200px;
  padding: 3px;
  display: flex;
  justify-content: center;
  align-items: center;
  width: 37px;
  height: 37px;
}

.iconContainer.withPhoto {
  background-color: #2e7d32; /* verde */
  border-color: #2e7d32;
}

.promoCheck {
  font-size: 20px;
  color: #fff;
  line-height: 1;
}

.camIcon {
  width: 25px;
  height: 25px;
}

.btn-salida {
  padding: 10px 100px;
  background-color: #2196f3;
  color: white;
  font-size: 18px;
  border-radius: 5px;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease;
}

.btn-salida:hover {
  background-color: #1976d2;
}

.btn-salida:active {
  background-color: #1565c0;
  transform: scale(1);
}

/* Opciones individuales */
.metodoOption, .facturaOption {
  padding: 7px 12px;
  border-radius: 8px;
  background-color: #444a5a;
  color: white;
  font-weight: bold;
  transition: all 0.3s ease;
  text-align: center;
  cursor: pointer;
  border: 1px solid transparent;
}

.metodoOption:hover, .facturaOption:hover {
  background-color: #5a6073;
}

.metodoOption.selected, .facturaOption.selected {
  background-color: #2a2a38;
  color: white;
  border-color: rgba(109, 109, 109, 0.21);
}

.guardarWebcamBtn {
  background-color: #444a5a;
  color: white;
  border: none;
  padding: 0.6rem 1rem;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
  transition: background-color 0.3s ease, transform 0.2s ease;
}

.guardarWebcamBtn:hover {
  background-color: #5a6175;
  transform: scale(1.05);
}

.guardarWebcamBtn.aceptarBtn {
  background-color: #2e7d32;
}

.guardarWebcamBtn.aceptarBtn:hover {
  background-color: #1b5e20;
}

DatosAutoSalida.jsx:
import React, { useState, useEffect, useRef } from "react";
import "./DatosAutoSalida.css";
import {
  useTarifasData,
  calcularAmbosPrecios,
  armarParametrosTiempo,
} from "../../../hooks/tarifasService";
import ModalMensaje from "../../ModalMensaje/ModalMensaje";
import AutoPlaceHolder from "../../../../public/images/placeholder.png";
import AutoPlaceHolderNoimage from "../../../../public/images/placeholderNoimage.png";
import { HiArrowRight, HiX } from "react-icons/hi";

// ===== DEBUG helpers =====
const DBG = true;
const log = (...a) => DBG && console.log("[Salida]", ...a);
const group = (t) => DBG && console.group("[Salida]", t);
const groupEnd = () => DBG && console.groupEnd();

function DatosAutoSalida({
  buscarVehiculo,
  vehiculoLocal,
  error,
  limpiarInputTrigger,
  onActualizarVehiculoLocal,
  onTarifaCalculada,
  onSalidaCalculada,
  autoFocusActivo = true,
}) {
  const [inputPatente, setInputPatente] = useState("");

  // CatÃ¡logo completo (efectivo + otros)
  const { tarifas, preciosEfectivo, preciosOtros, parametros } = useTarifasData();

  const yaActualizado = useRef(false);
  const inputRef = useRef(null);
  const lastInputTime = useRef(0);
  const inputTimer = useRef(null);
  const isScanning = useRef(false);

  const [modalMensaje, setModalMensaje] = useState("");
  const [modalTitulo, setModalTitulo] = useState("AtenciÃ³n");
  const [imgSrc, setImgSrc] = useState(AutoPlaceHolder);

  useEffect(() => {
    if (autoFocusActivo) {
      const t = setTimeout(() => inputRef.current?.focus({ preventScroll: true }), 0);
      return () => clearTimeout(t);
    }
  }, [autoFocusActivo]);

  useEffect(() => {
    if (limpiarInputTrigger) setInputPatente("");
  }, [limpiarInputTrigger]);

  useEffect(() => {
    if (!vehiculoLocal) setInputPatente("");
  }, [vehiculoLocal]);

  useEffect(() => {
    if (!vehiculoLocal) {
      setImgSrc(AutoPlaceHolder);
      return;
    }
    const fotoUrl = vehiculoLocal.estadiaActual?.fotoUrl;
    if (fotoUrl) setImgSrc(/^https?:\/\//i.test(fotoUrl) ? fotoUrl : `http://localhost:5000${fotoUrl}`);
    else setImgSrc(AutoPlaceHolderNoimage);
  }, [vehiculoLocal]);

  // ---- lector rÃ¡pido de tickets (igual que antes) ----
  useEffect(() => {
    const handleInput = (e) => {
      const currentTime = Date.now();
      const value = e.target.value;

      if (currentTime - lastInputTime.current < 100 && value.length === 10 && /^\d+$/.test(value)) {
        clearTimeout(inputTimer.current);
        isScanning.current = true;
        handleTicketScan(value);
      }

      lastInputTime.current = currentTime;

      if (value.length === 10 && /^\d+$/.test(value)) {
        clearTimeout(inputTimer.current);
        isScanning.current = true;
        inputTimer.current = setTimeout(() => handleTicketScan(value), 200);
      }
    };

    const inputElement = inputRef.current;
    inputElement?.addEventListener("input", handleInput);
    return () => {
      inputElement?.removeEventListener("input", handleInput);
      clearTimeout(inputTimer.current);
    };
  }, []);

  const handleTicketScan = async (ticketNumber) => {
    try {
      const ticketNum = parseInt(ticketNumber, 10);
      if (isNaN(ticketNum)) {
        setModalTitulo("Error");
        setModalMensaje("Ticket invÃ¡lido");
        isScanning.current = false;
        return;
      }

      const response = await fetch(`http://localhost:5000/api/vehiculos/ticket/${ticketNum}`);
      if (!response.ok) {
        const errorData = await response.json();
        console.error("Error:", errorData.msg);
        setModalTitulo("Error");
        setModalMensaje(`No se encontrÃ³ vehÃ­culo con ticket ${ticketNum}`);
        isScanning.current = false;
        return;
      }

      const data = await response.json();
      await procesarVehiculoEncontrado(data);

      if (data.patente) {
        setInputPatente(data.patente);
        setTimeout(() => {
          const enterEvent = new KeyboardEvent("keydown", { key: "Enter", code: "Enter", keyCode: 13, which: 13, bubbles: true });
          inputRef.current?.dispatchEvent(enterEvent);
          isScanning.current = false;
        }, 100);
      }
    } catch (err) {
      console.error("Error al buscar por ticket:", err);
      setModalTitulo("Error");
      setModalMensaje("Error al procesar el ticket escaneado");
      isScanning.current = false;
    }
  };

  const procesarVehiculoEncontrado = async (data) => {
    if (!data.estadiaActual || !data.estadiaActual.entrada) {
      setModalTitulo("Error");
      setModalMensaje("El vehÃ­culo no tiene estadÃ­a en curso.");
      return;
    }

    const tieneEntrada = !!data.estadiaActual.entrada;
    const yaTieneSalida = !!data.estadiaActual.salida;
    const salidaTemporal = new Date().toISOString();

    if (tieneEntrada && !yaTieneSalida) {
      if (data.abonado) return await procesarSalidaAbonado(data, salidaTemporal);
      if (data.turno)   return await procesarSalidaTurno(data, salidaTemporal);
    }

    const actualizado = {
      ...data,
      estadiaActual: { ...data.estadiaActual, salida: salidaTemporal },
    };

    if (onSalidaCalculada && !yaTieneSalida) onSalidaCalculada(salidaTemporal);
    onActualizarVehiculoLocal(actualizado);
  };

  const procesarSalidaAbonado = async (vehiculo, salida) => {
    const resSalida = await fetch(
      `http://localhost:5000/api/vehiculos/${vehiculo.patente}/registrarSalida`,
      { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ salida, costo: 0, tarifa: null }) }
    );
    if (!resSalida.ok) {
      const errorData = await resSalida.json();
      setModalTitulo("Error");
      setModalMensaje(errorData.msg || "Error al registrar salida automÃ¡tica");
      return;
    }
    setModalTitulo("Ã‰xito");
    setModalMensaje(`âœ… VehÃ­culo ${vehiculo.patente} (abonado) saliÃ³ automÃ¡ticamente.`);
    setInputPatente("");
  };

  const procesarSalidaTurno = async (vehiculo, salida) => {
    const resSalida = await fetch(
      `http://localhost:5000/api/vehiculos/${vehiculo.patente}/registrarSalida`,
      { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ salida, costo: 0, tarifa: null }) }
    );
    if (!resSalida.ok) {
      setModalTitulo("Error");
      setModalMensaje("Error al registrar salida automÃ¡tica");
      return;
    }

    const resDesactivarTurno = await fetch(
      `http://localhost:5000/api/turnos/desactivar-por-patente/${vehiculo.patente}`,
      { method: "PATCH", headers: { "Content-Type": "application/json" } }
    );
    if (!resDesactivarTurno.ok) {
      setModalTitulo("Error");
      setModalMensaje("Error al desactivar turno");
      return;
    }

    setModalTitulo("Ã‰xito");
    setModalMensaje(`âœ… VehÃ­culo ${vehiculo.patente} con turno saliÃ³ automÃ¡ticamente.`);
    setInputPatente("");
  };

  const submitPatente = async () => {
    if (isScanning.current) return;
    const patenteBuscada = inputPatente.trim().toUpperCase();
    if (!patenteBuscada) return;

    try {
      const response = await fetch(`http://localhost:5000/api/vehiculos/${patenteBuscada}`);
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.msg || "VehÃ­culo no encontrado");
      }
      const data = await response.json();
      await procesarVehiculoEncontrado(data);
    } catch (err) {
      console.error("Error en la operaciÃ³n:", err);
      setModalTitulo("Error");
      setModalMensaje(err.message || "Error al procesar la salida.");
    }
  };

  const handleKeyDown = async (e) => {
    if (e.key === "Enter" && !isScanning.current) submitPatente();
  };

  /** ========= CÃLCULO CENTRAL ========= */
  useEffect(() => {
    const entrada = vehiculoLocal?.estadiaActual?.entrada;
    const salida = vehiculoLocal?.estadiaActual?.salida;
    const costoTotal = vehiculoLocal?.estadiaActual?.costoTotal;

    if (!entrada || !salida) return;

    const calc = async () => {
      group("CALC con salida seteada");
      log("entrada:", entrada, "salida:", salida, "costoTotal actual:", costoTotal);

      try {
        const { dias, horasFormateadas } = armarParametrosTiempo(entrada, salida);
        log("â†’ params:", { dias, horasFormateadas });

        const { costoEfectivo, costoOtros } = await calcularAmbosPrecios({
          tipoVehiculo: vehiculoLocal.tipoVehiculo,
          inicio: new Date(entrada).toISOString(),
          dias,
          hora: horasFormateadas,
          tarifas,
          preciosEfectivo,
          preciosOtros,
          parametros,
        });

        log("totales calculados â†’ efectivo:", costoEfectivo, "otros:", costoOtros);

        // â¬…ï¸ COMPAT: mando tambiÃ©n `costo` = costoEfectivo
        onTarifaCalculada?.({ salida, costo: costoEfectivo, costoEfectivo, costoOtros, tarifa: null });

        // persistimos al back SOLO si costoTotal no existe/0
        const necesitaPersistir = (costoTotal === 0 || costoTotal === undefined) && typeof costoEfectivo === "number";
        log("necesitaPersistir:", necesitaPersistir);

        if (necesitaPersistir && vehiculoLocal?.patente) {
          const resActualizar = await fetch(
            `http://localhost:5000/api/vehiculos/${vehiculoLocal.patente}/costoTotal`,
            { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ costoTotal: costoEfectivo }) }
          );

          if (resActualizar.ok) {
            const actualizado = await resActualizar.json();
            yaActualizado.current = true;
            onActualizarVehiculoLocal({
              ...actualizado.vehiculo,
              costoTotal: costoEfectivo,
              estadiaActual: { ...actualizado.vehiculo.estadiaActual, costoTotal: costoEfectivo },
            });
            log("persistido costoTotal en back:", costoEfectivo);
          } else {
            const errorJson = await resActualizar.json();
            console.error("Error al actualizar costoTotal:", errorJson.msg);
          }
        }
      } catch (error) {
        console.error("Error al calcular tarifa:", error.message);
      } finally {
        groupEnd();
      }
    };

    calc();
  }, [vehiculoLocal, tarifas, preciosEfectivo, preciosOtros, parametros, onActualizarVehiculoLocal, onTarifaCalculada]);

  /** CÃ¡lculo temporal si NO hay salida aÃºn (preview) */
  useEffect(() => {
    const entrada = vehiculoLocal?.estadiaActual?.entrada;
    if (!entrada || vehiculoLocal?.estadiaActual?.salida) return;

    const calcTemp = async () => {
      group("CALC temporal (sin salida)");
      try {
        const salida = new Date();
        const { dias, horasFormateadas } = armarParametrosTiempo(entrada, salida.toISOString());
        log("â†’ params:", { dias, horasFormateadas });

        const { costoEfectivo, costoOtros } = await calcularAmbosPrecios({
          tipoVehiculo: vehiculoLocal.tipoVehiculo,
          inicio: new Date(entrada).toISOString(),
          dias,
          hora: horasFormateadas,
          tarifas,
          preciosEfectivo,
          preciosOtros,
          parametros,
        });

        log("PREVIEW â†’ efectivo:", costoEfectivo, "otros:", costoOtros);

        // â¬…ï¸ COMPAT: mando `costo` = costoEfectivo
        onTarifaCalculada?.({
          costo: costoEfectivo,
          salida: salida.toISOString(),
          tarifa: null,
          costoEfectivo,
          costoOtros,
        });

        onActualizarVehiculoLocal({
          ...vehiculoLocal,
          estadiaActual: {
            ...vehiculoLocal.estadiaActual,
            salida: salida.toISOString(),
            costoTotal: costoEfectivo, // preview con efectivo
          },
        });
      } catch (e) {
        console.error("Error preview cÃ¡lculo:", e.message);
      } finally {
        groupEnd();
      }
    };

    calcTemp();
  }, [vehiculoLocal, tarifas, preciosEfectivo, preciosOtros, parametros, onActualizarVehiculoLocal, onTarifaCalculada]);

  const entradaDate = vehiculoLocal?.estadiaActual?.entrada ? new Date(vehiculoLocal.estadiaActual.entrada) : null;
  const salidaDate  = vehiculoLocal?.estadiaActual?.salida  ? new Date(vehiculoLocal.estadiaActual.salida)  : null;

  const handleBorrar = () => {
    setInputPatente("");
    yaActualizado.current = false;
    setImgSrc(AutoPlaceHolder);
    onActualizarVehiculoLocal?.(null);
    onTarifaCalculada?.(null);
    onSalidaCalculada?.(null);
    inputRef.current?.focus();
  };

  const handleAceptar = () => submitPatente();

  return (
    <>
      <div className="datosAutoSalida">
        <div className="fotoAutoSalida">
          <img
            src={imgSrc}
            alt="Auto"
            className="foto-vehiculo"
            onError={() => setImgSrc(AutoPlaceHolderNoimage)}
          />
        </div>

        <div className="detalleAutoSalida">
          <div className="patenteYTipo">
            <div className="patente">
              <input
                ref={inputRef}
                type="text"
                className="input-patente"
                placeholder="IngresÃ¡ la patente o escaneÃ¡ el ticket"
                value={inputPatente}
                onChange={(e) => setInputPatente(e.target.value.toUpperCase())}
                onKeyDown={handleKeyDown}
              />
            </div>

            <div className="tipoYAcciones">
              <div className="tipoVehiculo">
                {vehiculoLocal?.tipoVehiculo
                  ? vehiculoLocal.tipoVehiculo.charAt(0).toUpperCase() + vehiculoLocal.tipoVehiculo.slice(1)
                  : "Sin datos"}
              </div>

              <div className="accionesInput">
                <button type="button" className="btnCuadrado btnBorrar" title="Borrar" aria-label="Borrar" onClick={handleBorrar}>
                  <HiX size={22} />
                </button>
                <button type="button" className="btnCuadrado btnAceptar" title="Aceptar" aria-label="Aceptar" onClick={handleAceptar}>
                  <HiArrowRight size={22} />
                </button>
              </div>
            </div>
          </div>

          <div className="horarios">
            <div className="container"><div>â¬†</div><div>{entradaDate ? entradaDate.toLocaleString() : "Sin Datos"}</div></div>
            <div className="container"><div>â¬‡</div><div>{salidaDate  ? salidaDate.toLocaleString()  : "Sin Datos"}</div></div>
          </div>

          {error && <div className="error">{error}</div>}
        </div>
      </div>

      <ModalMensaje titulo={modalTitulo} mensaje={modalMensaje} onClose={() => setModalMensaje("")} />
    </>
  );
}

export default DatosAutoSalida;


DatosAUtoSalida.css:
/* DATOS DE AUTO SALIDA */
.datosAutoSalida {
  display: flex; 
  align-items: stretch; 
  color: white;
}

.fotoAutoSalida {
  display: flex;
  width: 463px; 
  height: 309px; 
  margin-bottom: 27px;
  overflow: hidden; 
  background-color: #2a2a38; 
}

.fotoAutoSalida img {
  width: 100%;
  height: 100%;
  object-fit: cover; 
  object-position: center; 
}

.detalleAutoSalida {
  display: flex; 
  flex-direction: column;
  margin-left: 15px;
  flex-grow: 1; 
}

.patenteYTipo {
  display: flex;
  flex-direction: column;
  color: white;
  padding-bottom: 15%;
}
.patente {
  font-size: 40px;
  font-weight: bold;
  padding-bottom: 3px;
}
.patente input {
  width: 185px;
  height: 40px;
  font-size: 22px;
  border-radius: 5px;
  padding: 5px 10px;
  background-color: #2a2a38;
  color: white;
  border: 2px solid #444a5a;
}
.patente input:focus {
  outline: none;
  box-shadow: none;
  border-color: #444a5a; /* mismo color que el estado normal */
}

.horarios {
  display: flex;
  flex-direction: column;
  gap: 10px;
  font-size: 15px;
}

.container {
  display: flex;
  background-color: #2a2a38; 
  align-items: center;
  justify-content: flex-start; 
  color: white; 
  padding: 8px 15px; 
  border-radius: 5px;
  max-width: 280px; 
  width: 80%;
  border: 1px solid #3a3f50;
}
.container div {
  margin-right: 10px; /* Espaciado entre el Ã­cono y el texto */
}

/* === NUEVOS ESTILOS: fila con tipo + acciones === */
.tipoYAcciones {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;         
  margin: 6px 15px 0px 5px;
  max-width: 420px;       
}

/* Reutiliza tu .tipoVehiculo existente (no lo toco). 
   Si querÃ©s asegurar altura consistente con los botones: */
.tipoVehiculo {
  line-height: 40px;       /* alinea vertical con botones de 40px */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Contenedor de botones a la derecha */
.accionesInput {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* BotÃ³n cuadrado base */
.btnCuadrado {
  width: 40px;
  height: 40px;
  min-width: 40px;
  min-height: 40px;
  border-radius: 6px;
  background-color: #2a2a38;      /* consistente con tus inputs */
  color: #ffffff;
  border: 2px solid #444a5a;      /* consistente con tus inputs */
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform 0.06s ease, background-color 0.15s ease, border-color 0.15s ease;
}

.btnCuadrado:hover {
  background-color: #323245;
  border-color: #4e5466;
}

.btnCuadrado:active {
  transform: scale(0.98);
}

/* Variantes sutiles (si querÃ©s diferenciarlas visualmente) */
.btnBorrar:hover {
  background-color: #3a2a2a;
  border-color: #6b4a4a;
}

.btnAceptar:hover {
  background-color: #2a3a2a;
  border-color: #4a6b4a;
}

/* A11y: foco accesible */
.btnCuadrado:focus {
  outline: 2px solid #6b8cff;
  outline-offset: 2px;
}


DatosAUtoEntrada.jsx:
import React, { useState, useEffect, useRef, useCallback } from "react";
import "./DatosAutoEntrada.css";
import ModalMensaje from "../../ModalMensaje/ModalMensaje";
import AutoPlaceHolder from "../../../../public/images/placeholder.png";
import AutoPlaceHolderNoimage from "../../../../public/images/placeholderNoimage.png";

const BASE_URL = "http://localhost:5000";
const CATALOG_POLL_MS = 180000; // 3 min
const CATALOG_VERSION_KEY = "catalogVersion";
const BC_NAME = "catalog-updated";

let bc;
try { bc = new BroadcastChannel(BC_NAME); } catch {}

/* ---------- Utils ---------- */
const hash = (obj) => {
  const s = JSON.stringify(obj);
  let h = 5381;
  for (let i = 0; i < s.length; i++) h = ((h << 5) + h) ^ s.charCodeAt(i);
  return (h >>> 0).toString(36);
};

const norm = (s) =>
  (s || "")
    .toString()
    .trim()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");

const makeAbsolute = (url) => {
  if (!url) return null;
  if (/^https?:\/\//i.test(url)) return url;
  if (url.startsWith("/")) return `${BASE_URL}${url}`;
  return url;
};

const isPriceValid = (v) => typeof v === "number" && isFinite(v) && v > 0;

/* ===========================================================
   Componente
=========================================================== */
function DatosAutoEntrada({
  user,
  ticketPendiente,
  onClose,
  timestamp,
  setTicketPendiente = () => {},
  autoFocusOnMount = false,
  onEntradaConfirmada = () => {},
}) {
  const [patente, setPatente] = useState("");
  const [tipoVehiculo, setTipoVehiculo] = useState("");

  // CatÃ¡logos crudos
  const [precios, setPrecios] = useState({});
  const [tiposVehiculoApi, setTiposVehiculoApi] = useState([]);

  // Nombres de tarifas que son de tipo "hora" (normalizados)
  const [tarifasHoraKeys, setTarifasHoraKeys] = useState([]);

  // Derivado: opciones filtradas para el select
  const [tiposVehiculoDisponibles, setTiposVehiculoDisponibles] = useState([]);

  // Modal de mensajes
  const [modalMensaje, setModalMensaje] = useState("");
  const [modalTitulo, setModalTitulo] = useState("AtenciÃ³n");
  const [mostrarModal, setMostrarModal] = useState(false);

  const [fotoUrl, setFotoUrl] = useState(AutoPlaceHolder);
  // âœ… NUEVO: bandera de â€œfoto resueltaâ€ (captura.jpg o placeholderNoImage)
  const [fotoResuelta, setFotoResuelta] = useState(false);

  const abortRef = useRef(null);
  const lastHashesRef = useRef({ precios: "", tipos: "", tarifasHora: "" });
  const patenteRef = useRef(null);

  // âœ… Autoenfoque SOLO si el componente estÃ¡ en modal
  useEffect(() => {
    if (autoFocusOnMount) {
      const t = setTimeout(() => patenteRef.current?.focus({ preventScroll: true }), 0);
      return () => clearTimeout(t);
    }
  }, [autoFocusOnMount]);

  const setIfChanged = (setter, key, data) => {
    const h = hash(data);
    if (h !== lastHashesRef.current[key]) {
      lastHashesRef.current[key] = h;
      setter(data);
    }
  };

  const mostrarMensaje = (titulo, mensaje) => {
    setModalTitulo(titulo);
    setModalMensaje(mensaje);
    setMostrarModal(true);
  };

  /* ---------- Fetchers ---------- */
  const fetchPrecios = useCallback(async () => {
    try {
      let data = null;

      // 1) intento estÃ¡ndar
      try {
        const res = await fetch(`${BASE_URL}/api/precios`, { cache: "no-store" });
        if (!res.ok) throw new Error(`GET /api/precios -> ${res.status}`);
        data = await res.json();
        console.log("[Entrada] precios OK via /api/precios");
      } catch (e1) {
        console.warn("[Entrada] /api/precios fallÃ³, probando fallback /api/precios?metodo=efectivo", e1?.message);
        // 2) fallback efectivo
        const res2 = await fetch(`${BASE_URL}/api/precios?metodo=efectivo`, { cache: "no-store" });
        if (!res2.ok) throw new Error(`GET /api/precios?metodo=efectivo -> ${res2.status}`);
        data = await res2.json();
        console.log("[Entrada] precios OK via /api/precios?metodo=efectivo");
      }

      setIfChanged(setPrecios, "precios", data || {});
    } catch (error) {
      console.error("Error al obtener los precios (ambos intentos):", error);
      // SÃ³lo muestro modal si NO tengo nada actualmente
      if (!precios || Object.keys(precios).length === 0) {
        mostrarMensaje("Error", "No se pudieron cargar los precios.");
      }
    }
  }, [precios]);

  const fetchTiposVehiculo = useCallback(async () => {
    try {
      const res = await fetch(`${BASE_URL}/api/tipos-vehiculo`, { cache: "no-store" });
      if (!res.ok) throw new Error("No se pudieron cargar los tipos de vehÃ­culo");
      const data = await res.json();
      setIfChanged(setTiposVehiculoApi, "tipos", Array.isArray(data) ? data : []);
    } catch (error) {
      mostrarMensaje("Error", "No se pudieron cargar los tipos de vehÃ­culo.");
      console.error("Error al obtener los tipos de vehÃ­culo:", error);
    }
  }, []);

  const fetchTarifasHora = useCallback(async () => {
    try {
      const res = await fetch(`${BASE_URL}/api/tarifas`, { cache: "no-store" });
      if (!res.ok) throw new Error("No se pudieron cargar las tarifas");
      const all = await res.json();
      const keys = (Array.isArray(all) ? all : [])
        .filter(t => norm(t.tipo) === "hora")
        .map(t => norm(t.nombre))
        .filter((v, i, a) => a.indexOf(v) === i);
      setIfChanged(setTarifasHoraKeys, "tarifasHora", keys);
    } catch (error) {
      mostrarMensaje("Error", "No se pudieron cargar las tarifas.");
      console.error("Error al obtener las tarifas:", error);
    }
  }, []);

  const loadAll = useCallback(async () => {
    try {
      abortRef.current?.abort?.();
      const controller = new AbortController();
      abortRef.current = controller;
      await Promise.all([fetchPrecios(), fetchTiposVehiculo(), fetchTarifasHora()]);
    } catch {}
  }, [fetchPrecios, fetchTiposVehiculo, fetchTarifasHora]);

  /* ---------- Ciclo de vida: carga y refresco ---------- */
  useEffect(() => {
    let timer = null;
    loadAll();

    timer = setInterval(loadAll, CATALOG_POLL_MS);

    const onVis = () => document.visibilityState === "visible" && loadAll();
    const onFocus = () => loadAll();
    const onOnline = () => loadAll();

    document.addEventListener("visibilitychange", onVis);
    window.addEventListener("focus", onFocus);
    window.addEventListener("online", onOnline);

    const onStorage = (ev) => {
      if (ev.key === CATALOG_VERSION_KEY) loadAll();
    };
    window.addEventListener("storage", onStorage);

    if (bc) {
      bc.onmessage = (msg) => {
        if (msg?.data?.type === "catalog-version") loadAll();
      };
    }

    return () => {
      abortRef.current?.abort?.();
      if (timer) clearInterval(timer);
      document.removeEventListener("visibilitychange", onVis);
      window.removeEventListener("focus", onFocus);
      window.removeEventListener("online", onOnline);
      window.removeEventListener("storage", onStorage);
      if (bc) bc.onmessage = null;
    };
  }, [loadAll]);

  /* ---------- Foto del ticket/captura ---------- */
  useEffect(() => {
    const verificarFoto = async () => {
      if (ticketPendiente) {
        const candidate = ticketPendiente.fotoUrl
          ? makeAbsolute(ticketPendiente.fotoUrl)
          : `${BASE_URL}/api/camara/captura.jpg`;
        const url = `${candidate}?t=${timestamp}`;
        try {
          const res = await fetch(url, { method: "HEAD" });
          if (res.ok) {
            setFotoUrl(url);
            setFotoResuelta(true); // âœ… captura.jpg disponible
          } else {
            setFotoUrl(AutoPlaceHolderNoimage);
            setFotoResuelta(true); // âœ… placeholderNoImage
          }
        } catch {
          setFotoUrl(AutoPlaceHolderNoimage);
          setFotoResuelta(true);   // âœ… placeholderNoImage por error
        }
      } else {
        setFotoUrl(AutoPlaceHolder);
        setFotoResuelta(false);     // â›” sin ticket -> no resuelta
      }
    };
    verificarFoto();
  }, [ticketPendiente, timestamp]);

  /* ---------- Filtrado: SOLO tipos con hora === true y precio 'hora' > 0 ---------- */
  useEffect(() => {
    if (!Array.isArray(tiposVehiculoApi) || tiposVehiculoApi.length === 0) {
      setTiposVehiculoDisponibles([]);
      return;
    }
    if (!precios || typeof precios !== "object") {
      setTiposVehiculoDisponibles([]);
      return;
    }

    const preciosNormPorTipo = {};
    for (const [tipo, mapa] of Object.entries(precios)) {
      const inner = {};
      if (mapa && typeof mapa === "object") {
        for (const [k, v] of Object.entries(mapa)) inner[norm(k)] = v;
      }
      preciosNormPorTipo[norm(tipo)] = inner;
    }

    const filtrados = tiposVehiculoApi.filter(({ nombre, hora }) => {
      if (!hora) return false;
      const tipoN = norm(nombre);
      const mapa = preciosNormPorTipo[tipoN];
      if (!mapa) return false;
      const precioHora = mapa["hora"];
      return isPriceValid(precioHora);
    });

    setTiposVehiculoDisponibles(filtrados);
  }, [tiposVehiculoApi, precios]);

  /* ---------- Acciones ---------- */
  const eliminarFotoTemporal = async () => {
    try {
      await fetch(`${BASE_URL}/api/vehiculos/eliminar-foto-temporal`, { method: "DELETE" });
    } catch (error) {
      console.error("Error al eliminar foto temporal:", error);
    }
  };

  const resetearEstadoCompleto = () => {
    setPatente("");
    setTipoVehiculo("");
    setFotoUrl(AutoPlaceHolder);
    setFotoResuelta(false); // âœ… volvemos a â€œno resueltaâ€
    setTicketPendiente(null);
  };

  const handleCerrarModal = () => {
    setMostrarModal(false);
    setModalMensaje("");
    if (modalTitulo === "Ã‰xito") {
      resetearEstadoCompleto();
      if (typeof onClose === "function") onClose();
      if (typeof setTicketPendiente === "function") setTicketPendiente(null);
    }
  };

  const handleEntrada = async () => {
    if (!user) return mostrarMensaje("AtenciÃ³n", "No estÃ¡s logueado.");
    if (!ticketPendiente) return mostrarMensaje("AtenciÃ³n", "Primero generÃ¡ un ticket con BOT.");

    // ðŸ”“ Sin validaciÃ³n de formato; solo que no estÃ© vacÃ­o y haya tipo
    if (!patente || !tipoVehiculo) {
      return mostrarMensaje("Faltan datos", "Patente y tipo de vehÃ­culo.");
    }

    const sigueSiendoValido = tiposVehiculoDisponibles.some(t => norm(t.nombre) === norm(tipoVehiculo));
    if (!sigueSiendoValido) return mostrarMensaje("Sin precios vÃ¡lidos", "El tipo de vehÃ­culo seleccionado ya no es vÃ¡lido.");

    try {
      const fotoUrlActual = ticketPendiente.fotoUrl
        ? makeAbsolute(ticketPendiente.fotoUrl)
        : `${BASE_URL}/camara/sacarfoto/captura.jpg`;

      // Asociar datos al ticket
      const resAsociar = await fetch(
        `${BASE_URL}/api/tickets/${ticketPendiente._id}/asociar`,
        {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            patente,
            tipoVehiculo,
            operadorNombre: user.nombre,
            fotoUrl: fotoUrlActual,
          }),
        }
      );
      const dataAsociar = await resAsociar.json();
      if (!resAsociar.ok) throw new Error(dataAsociar.msg || "Error al asociar ticket");

      // Registrar entrada
      // Registrar entrada
      const checkResponse = await fetch(`${BASE_URL}/api/vehiculos/${patente}`);
      let esAbonado = false;

      const precioHora =
      precios[norm(tipoVehiculo)]?.hora ??
      precios[norm(tipoVehiculo)]?.["hora"] ??
      null;

      if (checkResponse.ok) {
        const vehiculoExistente = await checkResponse.json();
        esAbonado = vehiculoExistente?.abonado === true;

        const entradaResponse = await fetch(
          `${BASE_URL}/api/vehiculos/${patente}/registrarEntrada`,
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              operador: user.nombre,
              metodoPago: "Efectivo",
              monto: precioHora,
              ticket: ticketPendiente.ticket,
              entrada: ticketPendiente.creadoEn,
              fotoUrl: fotoUrlActual,
            }),
          }
        );
        if (!entradaResponse.ok) throw new Error("Error al registrar entrada");
      } else {
        const vehiculoResponse = await fetch(`${BASE_URL}/api/vehiculos`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            patente,
            tipoVehiculo,
            abonado: false,
            operador: user.nombre,
            ticket: ticketPendiente.ticket,
            entrada: ticketPendiente.creadoEn,
            fotoUrl: fotoUrlActual,
          }),
        });
        if (!vehiculoResponse.ok) throw new Error("Error al registrar vehÃ­culo");
      }

      await eliminarFotoTemporal();

      // ðŸ–¨ï¸ Imprimir SOLO si NO es abonado
      if (!esAbonado) {
        try {
          const ticketNumFormateado = String(ticketPendiente.ticket).padStart(6, '0');
          await fetch(`${BASE_URL}/api/ticket/imprimir`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              texto: ticketNumFormateado,
              ticketNumero: ticketNumFormateado,
              valorHora: (precioHora != null
                ? `$${Number(precioHora).toLocaleString('es-AR')}`
                : `${tipoVehiculo || ''}`),
              patente: patente,
              tipoVehiculo: tipoVehiculo
            }),
          });
        } catch (e) {
          console.warn("ImpresiÃ³n con meta fallÃ³, se ignora:", e);
        }
      } else {
        console.log(`[Entrada] VehÃ­culo abonado (${patente}) â†’ no se imprime ticket`);
      }

      // Aviso al padre para cancelar el fallback de 20s
      try { onEntradaConfirmada(); } catch {}

      // UI
      setPatente("");
      setTipoVehiculo("");
      setFotoUrl(AutoPlaceHolder);
      setFotoResuelta(false);
      mostrarMensaje("Ã‰xito", `Entrada registrada para ${patente}.`);
    } catch (error) {
      console.error("Error:", error.message);
      mostrarMensaje("Error", error.message || "OcurriÃ³ un error");
    }
  };

  // ðŸ”§ Input libre: mayÃºsculas y lÃ­mite 10, sin regex de restricciÃ³n
  const handlePatenteChange = (e) => {
    const valor = (e.target.value || "").toUpperCase().slice(0, 10);
    setPatente(valor);
  };

  /* ---------- Render ---------- */
  return (
    <div className="datosAutoEntrada">
      <div className="fotoAutoEntrada">
        <img
          src={fotoUrl}
          alt="Foto auto"
          className="foto-vehiculo"
          onError={(e) => {
            e.target.onerror = null;
            e.target.src = AutoPlaceHolderNoimage;
            setFotoResuelta(true); // âœ… si falla carga, queda como â€œsin imagenâ€
          }}
        />
      </div>

      <div className="formularioAuto">
        <label htmlFor="patente">Patente</label>
        <input
          id="patente"
          ref={patenteRef}
          type="text"
          placeholder="Ingrese la patente"
          value={patente}
          onChange={handlePatenteChange}
          className="inputPatente"
          maxLength={10}
        />

        <label htmlFor="tipoVehiculo">Tipo de VehÃ­culo</label>
        <select
          id="tipoVehiculo"
          value={tipoVehiculo}
          onChange={(e) => setTipoVehiculo(e.target.value)}
          className="selectVehiculo"
        >
          <option value="">Seleccione un tipo</option>
          {tiposVehiculoDisponibles.map(({ nombre }) => (
            <option key={nombre} value={nombre}>
              {nombre.charAt(0).toUpperCase() + nombre.slice(1)}
            </option>
          ))}
        </select>

        <button
          className="btn-entrada"
          onClick={handleEntrada}
          disabled={!fotoResuelta}
          style={{
            opacity: fotoResuelta ? 1 : 0.6,
            cursor: fotoResuelta ? "pointer" : "not-allowed",
          }}
        >
          Registrar Entrada
        </button>
      </div>

      <ModalMensaje
        titulo={modalTitulo}
        mensaje={modalMensaje}
        onClose={handleCerrarModal}
        mostrar={mostrarModal}
      />
    </div>
  );
}

export default DatosAutoEntrada;


DatosAutoEntrada.css:
.datosAutoEntrada {
  display: flex;
  flex: 1;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.fotoAutoEntrada {
  display: flex;
  justify-content: center;
  width: 463px; 
  height: 309px; 
  margin-bottom: 26px;
  overflow: hidden; 
  background-color: #2a2a38;
}

.foto-vehiculo {
  width: 100%;
  height: 100%;
  object-fit: cover; 
  object-position: center; 
  transition: transform 0.3s ease; 
}

/* Resto del CSS permanece igual */
.formularioAuto {
  display: flex;
  flex-direction: column;
  gap: 10px;
  width: 90%;
  text-align: left;
}

label {
  font-size: 14px;
  color: white;
  font-weight: bold;
}

.inputPatente {
  padding: 8px;
  border-radius: 5px;
  border: none;
  background-color: #444a5a;
  color: white;
  font-size: 16px;
  text-transform: uppercase;
  outline: none;
}

.selectVehiculo {
  padding: 8px;
  border-radius: 5px;
  border: none;
  background-color: #444a5a;
  color: white;
  font-size: 16px;
  cursor: pointer;
}

/* Estilo para el botÃ³n de "Registrar Entrada" */
.btn-entrada {
  padding: 10px 20px;
  background-color: #4caf50;
  color: white;
  font-size: 18px;
  border-radius: 5px;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease;
}

.btn-entrada:hover {
  background-color: #0056b3;
}

.btn-entrada:active {
  background-color: #004085;
  transform: scale(1);
}



ModalMensaje.jsx

import React from 'react';
import './ModalMensaje.css'; // tu CSS actual

function ModalMensaje({ titulo = "Mensaje", mensaje, onClose, children }) {
  if (!mensaje) return null;

  return (
    <div className="modal-backdrop" onClick={onClose}>
      <div className="modal-contenedor" onClick={e => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{titulo}</h2>
          <button className="modal-cerrar" onClick={onClose}>Ã—</button>
        </div>

        <div className="modal-body">

          {/* ðŸ‘‡ðŸ‘‡ FIX DEFINITIVO de salto de lÃ­nea y legibilidad ðŸ‘‡ðŸ‘‡ */}
          <div
            className="modal-mensaje-texto"
            style={{
              whiteSpace: "pre-wrap",
              lineHeight: "1.35",
              marginBottom: "0.8rem",
              display: "flex",
              flexDirection: "column",
              gap: "0.35rem",
            }}
          >
            {String(mensaje || "")
              .split("\n")
              .map((line, idx) => (
                <div key={idx}>{line}</div>
              ))}
          </div>
          {/* â˜ï¸ reemplaza al viejo <p>{mensaje}</p> */}

          {/* Renderizar aquÃ­ los children */}
          {children}
        </div>
      </div>
    </div>
  );
}

export default ModalMensaje;



ModalMensaje.css:

.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

.modal-contenedor {
  background: #2a2a38;
  border: 1px solid #1c1c26;
  padding: 5px 20px 20px 20px;
  border-radius: 12px;
  width: 400px;
  max-width: 90%;
  box-shadow: 0 0 12px rgba(0, 0, 0, 0.5);
  animation: fadeIn 0.2s ease-out;
  color: white;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-cerrar {
  background: none;
  border: none;
  font-size: 20px;
  color: white;
  cursor: pointer;
}

.modal-body {
  margin-top: 10px;
}

.modal-input {
  background-color: #1f1f28;
  border: 1px solid #444a5a;
  border-radius: 4px;
  padding: 0.4rem 0.5rem;
  color: white;
  width: 100%;
  outline: none;
  margin-bottom: 1rem;
  transition: border-color 0.3s;
}

/* Fade-in suave */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.96);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}


Interfaz.jsx:
import './Interfaz.css';
import React, { useState, useEffect, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import Header from './Header/Header';
import PanelDerecho from './PanelDerecho/PanelDerecho';
import Operador from '../Operador/Operador';
import VehiculosDentro from '../VehiculosDentro/VehiculosDentro';
import Clientes from '../Clientes/Clientes';
import DetalleClienteCajero from '../Clientes/DetalleClienteCajero';
import Background from '../Background/Background';
import Abono from '../Abono/Abono';
import Turnos from '../Turnos/Turnos';
import ModalHeader from './Header/ModalHeader/ModalHeader';
import ModalMensaje from '../ModalMensaje/ModalMensaje';
import Config from '../Config/Config';

const TOKEN_KEY = 'token';
const OPERADOR_KEY = 'operador';

// ===== Helpers operador (double-parse & validaciÃ³n) =====
const readOperador = () => {
  const raw = localStorage.getItem(OPERADOR_KEY);
  if (!raw) return null;
  try {
    const first = JSON.parse(raw);
    if (first && typeof first === 'object') return first;
    if (typeof first === 'string') {
      try { const second = JSON.parse(first); return second && typeof second === 'object' ? second : null; }
      catch { return null; }
    }
    return null;
  } catch { return null; }
};
const isOperadorValido = (op) => !!(op && (op.username || op.nombre));

// Formatea con separadores de miles (.)
const formatearVisualmente = (valor) => {
  if (!valor && valor !== 0) return '';
  const s = valor.toString();
  if (!s) return '';
  return s.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
};
// Deja solo dÃ­gitos (elimina todo lo que no sea 0-9)
const limpiarNumero = (valor) => (valor || '').replace(/[^\d]/g, '');
// Bloquea teclas no numÃ©ricas (permite navegaciÃ³n/ediciÃ³n)
const handleNumericKeyDown = (e) => {
  const permitidas = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'];
  if (e.ctrlKey || e.metaKey) return;
  if (permitidas.includes(e.key)) return;
  if (!/^\d$/.test(e.key)) e.preventDefault();
};

// ================================
// ðŸ‘¤ RESOLUCIÃ“N CANÃ“NICA DE OPERADOR
// ================================
const buildOperadorIndex = (usuarios = []) => {
  const byId = new Map();
  const byUsername = new Map();
  const byNombre = new Map();

  usuarios.forEach(u => {
    if (u._id) byId.set(String(u._id), u);
    if (u.username) byUsername.set(u.username.toLowerCase(), u);
    if (u.nombre) byNombre.set(u.nombre.toLowerCase(), u);
  });

  return { byId, byUsername, byNombre };
};

const resolveOperador = (item, operadorIndex) => {
  if (!item || !operadorIndex) return null;

  // operadorId explÃ­cito
  if (item.operadorId && operadorIndex.byId.has(String(item.operadorId))) {
    return operadorIndex.byId.get(String(item.operadorId));
  }

  const raw = item.operadorNombre || item.operador;
  if (!raw) return null;

  const key = String(raw).toLowerCase();
  if (operadorIndex.byUsername.has(key)) return operadorIndex.byUsername.get(key);
  if (operadorIndex.byNombre.has(key)) return operadorIndex.byNombre.get(key);

  return null;
};

function Interfaz() {
  const [vistaActual, setVistaActual] = useState('operador');
  const [modalActivo, setModalActivo] = useState(null);
  const [clienteSeleccionado, setClienteSeleccionado] = useState(null);
  const [ticketPendiente, setTicketPendiente] = useState(null);

    // Cierre de Caja
  const [recaudado, setRecaudado] = useState('');
  const [enCaja, setEnCaja] = useState('');
  const [confirmandoCaja, setConfirmandoCaja] = useState(false);

  // âœ… CÃ¡lculo de caja (sistema)
  const [calculoCaja, setCalculoCaja] = useState(null); // number | null
  const [calculoCajaLoading, setCalculoCajaLoading] = useState(false);


  // Cierre Parcial
  const [montoParcial, setMontoParcial] = useState('');
  const [nombreParcial, setNombreParcial] = useState('');
  const [textoParcial, setTextoParcial] = useState('');

  // Incidente
  const [incidente, setIncidente] = useState('');

  const [mostrarOverlay, setMostrarOverlay] = useState(false);
  const [barreraIzqAbierta, setBarreraIzqAbierta] = useState(false);
  const [barreraDerAbierta, setBarreraDerAbierta] = useState(false);
  const [user, setUser] = useState(null);
  const [mensajeModal, setMensajeModal] = useState(null);
  const [timestamp, setTimestamp] = useState(Date.now());

  // â¬‡ï¸ Estado levantado desde Header: modal de Registrar Entrada
  const [modalEntradaAbierto, setModalEntradaAbierto] = useState(false);

  const navigate = useNavigate();

  // -------------------- AUTOFOCUS Refs para MODALES --------------------
  const recaudadoRef = useRef(null);
  const enCajaRef = useRef(null);
  const montoParcialRef = useRef(null);
  const incidenteRef = useRef(null);

  useEffect(() => {
    if (modalActivo === 'cierredecaja' && !confirmandoCaja) {
      const t = setTimeout(() => recaudadoRef.current?.focus({ preventScroll: true }), 0);
      return () => clearTimeout(t);
    }
  }, [modalActivo, confirmandoCaja]);

  useEffect(() => {
    if (modalActivo === 'cierreparcial') {
      const t = setTimeout(() => montoParcialRef.current?.focus({ preventScroll: true }), 0);
      return () => clearTimeout(t);
    }
  }, [modalActivo]);

  useEffect(() => {
    if (modalActivo === 'incidente') {
      const t = setTimeout(() => incidenteRef.current?.focus({ preventScroll: true }), 0);
      return () => clearTimeout(t);
    }
  }, [modalActivo]);
  // --------------------------------------------------------------------

  // ðŸ” Guard de entrada: si no hay operador vÃ¡lido, desloguea; si es cargaMensuales, redirige.
  useEffect(() => {
    const op = readOperador();
    if (!isOperadorValido(op)) {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(OPERADOR_KEY);
      navigate('/login', { replace: true });
      return;
    }
    if (op.role === 'cargaMensuales') {
      navigate('/carga-mensuales', { replace: true });
      return;
    }
    setUser(op);
  }, [navigate]);

  // ðŸ”„ Refresca perfil; si falla o viene invÃ¡lido, desloguea. Si rol es cargaMensuales, redirige.
  useEffect(() => {
    const fetchUser = async () => {
      const token = localStorage.getItem(TOKEN_KEY);
      if (!token) {
        navigate('/login', { replace: true });
        return;
      }
      try {
        const response = await fetch('http://localhost:5000/api/auth/profile', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
          credentials: 'include'
        });
        if (!response.ok) throw new Error('Failed to fetch user');
        const data = await response.json();

        if (data && (data.username || data.nombre)) {
          localStorage.setItem(OPERADOR_KEY, JSON.stringify(data));
          if (data.role === 'cargaMensuales') {
            navigate('/carga-mensuales', { replace: true });
            return;
          }
          setUser(data);
        } else {
          throw new Error('Perfil invÃ¡lido');
        }
      } catch (error) {
        console.error('Error al obtener usuario:', error);
        localStorage.removeItem(TOKEN_KEY);
        localStorage.removeItem(OPERADOR_KEY);
        navigate('/login', { replace: true });
      }
    };
    fetchUser();
  }, [navigate]);

  const manejarSeleccionCliente = (idCliente) => {
    setClienteSeleccionado(idCliente);
    setVistaActual('detalleCliente');
  };

  const forzarLimpiarTicket = () => {
    setTicketPendiente(null);
    setTimestamp(Date.now());
  };

  const volverAClientes = () => {
    setClienteSeleccionado(null);
    setVistaActual('clientes');
  };

  const cerrarModal = () => {
    setModalActivo(null);
    setRecaudado('');
    setEnCaja('');
    setMontoParcial('');
    setNombreParcial('');
    setTextoParcial('');
    setIncidente('');
    setConfirmandoCaja(false);
  };

  const isCajaValida = () => {
    const rec = parseFloat(limpiarNumero(recaudado));
    const caja = parseFloat(limpiarNumero(enCaja));
    return !isNaN(rec) && !isNaN(caja) && rec >= 0 && caja >= 0;
  };

  const isMontoParcialValido = () => {
    const m = parseFloat(limpiarNumero(montoParcial));
    return !isNaN(m) && m >= 0;
  };

  const getFechaHora = () => {
    const ahora = new Date();
    const fecha = ahora.toISOString().split('T')[0];
    const hora = ahora.toTimeString().slice(0, 5);
    return { fecha, hora };
  };

    // ================================
    // âœ… CÃLCULO DE CAJA (Total Sistema en el modal)
    // Regla: dejoEnCaja del Ãºltimo cierre global
    //      + efectivo del operador actual desde ese cierre
    //      - parciales del operador actual desde ese cierre
    // ================================

    const normalizarOperadorStr = (op) => {
    if (!op) return '';
    if (typeof op === 'string') return op.trim();
    if (typeof op === 'object') {
      return String(
        op.username ||
        op.nombre ||
        op.name ||
        op.email ||
        op._id ||
        ''
      ).trim();
    }
    return String(op).trim();
  };

  // âœ… Timestamp robusto: prioriza createdAt (server) y cae a fecha/hora si no existe
  const tsItem = (item) => {
    if (!item) return -Infinity;

    // 1) createdAt/updatedAt (server UTC) = la referencia mÃ¡s estable
    const src = item.createdAt || item.updatedAt;
    const t1 = src ? new Date(src).getTime() : NaN;
    if (Number.isFinite(t1)) return t1;

    // 2) fallback: fecha + hora (local) si vino legacy sin createdAt
    const fecha = item.fecha;
    const hora  = item.hora;
    if (fecha && hora) {
      const [y, m, d] = String(fecha).split('-').map(Number);
      const [hh, mm] = String(hora).split(':').map(Number);
      if ([y, m, d, hh, mm].every(Number.isFinite)) {
        const t2 = new Date(y, m - 1, d, hh, mm, 0, 0).getTime();
        if (Number.isFinite(t2)) return t2;
      }
    }

    // 3) Ãºltimo fallback: campo fecha
    const t3 = item.fecha ? new Date(item.fecha).getTime() : NaN;
    return Number.isFinite(t3) ? t3 : -Infinity;
  };

  // âœ… Movimientos: el movimiento puede venir envuelto o plano; usamos createdAt/fecha del movimiento
  const tsMov = (mov) => {
    if (!mov) return -Infinity;
    const src = mov.createdAt || mov.fecha;
    const t = src ? new Date(src).getTime() : NaN;
    return Number.isFinite(t) ? t : -Infinity;
  };


  const formatARS = (n) => {
    const num = Number(n) || 0;
    return num.toLocaleString('es-AR');
  };

  useEffect(() => {
    const calcularCaja = async () => {
      if (modalActivo !== 'cierredecaja') return;

      setCalculoCajaLoading(true);
      setCalculoCaja(null);

      const token = localStorage.getItem(TOKEN_KEY) || '';
      const headers = token ? { Authorization: `Bearer ${token}` } : {};

      try {
        const REMOTE_API = 'https://api2.garageia.com';

        const [cierresRes, movsRes, parcRes] = await Promise.all([
          fetch(`${REMOTE_API}/api/cierresdecaja`, { headers }),
          fetch(`${REMOTE_API}/api/movimientos`, { headers }),
          fetch(`${REMOTE_API}/api/cierresdecaja/parcial`, { headers }),
        ]);

        if (!cierresRes.ok || !movsRes.ok || !parcRes.ok) {
          throw new Error('Error al obtener datos');
        }

        const cierres = await cierresRes.json();
        const movimientosRaw = await movsRes.json();
        const parciales = await parcRes.json();

        // ðŸ§± 1. Ãšltimo cierre de caja (GLOBAL)
        const ultimoCierre = [...cierres]
          .filter(c => c.createdAt)
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];

        const hayCierre = Boolean(ultimoCierre);

        const corte = hayCierre
          ? new Date(ultimoCierre.createdAt)
          : new Date(0); // â¬…ï¸ inicio del tiempo

        const dejoEnCaja = hayCierre
          ? Number(ultimoCierre.dejoEnCaja) || 0
          : 0;

        // ðŸ§± 2. Movimientos en EFECTIVO posteriores al cierre
        const movimientosUnicos = new Map();

        movimientosRaw.forEach(item => {
          const m = item.movimiento || item;
          if (!m || !m.idemBucket2s) return;

          // Si ya existe, NO lo volvemos a contar
          if (!movimientosUnicos.has(m.idemBucket2s)) {
            movimientosUnicos.set(m.idemBucket2s, m);
          }
        });

        const movimientos = [...movimientosUnicos.values()]
          .filter(m =>
            m.createdAt &&
            m.metodoPago === 'Efectivo' &&
            new Date(m.createdAt) >= corte
          );

        const totalEfectivo = movimientos.reduce(
          (acc, m) => acc + (Number(m.monto) || 0),
          0
        );

        // ðŸ§± 3. Cierres parciales posteriores al cierre
        const totalParciales = parciales
          .filter(p =>
            p.createdAt &&
            new Date(p.createdAt) > corte
          )
          .reduce((acc, p) => acc + (Number(p.monto) || 0), 0);

        // ðŸ§® 4. CÃ¡lculo final
        const calculoFinal = dejoEnCaja + totalEfectivo - totalParciales;

        console.log('ðŸ§® CÃLCULO CAJA', {
          hayCierre,
          corte: corte.toISOString(),
          dejoEnCaja,
          totalEfectivo,
          totalParciales,
          calculoFinal,
        });

        setCalculoCaja(calculoFinal);

      } catch (err) {
        console.error('Error cÃ¡lculo caja:', err);
        setCalculoCaja(null);
      } finally {
        setCalculoCajaLoading(false);
      }
    };

    calcularCaja();
  }, [modalActivo]);


  const abrirBarreraSalida = () => {
    setBarreraDerAbierta(true);
    setTimeout(() => setBarreraDerAbierta(false), 10000);
  };

  // ðŸ‘‰ sigue existiendo para parcial/incidente (guardÃ¡s objeto ahÃ­)
  const operadorPayload = () => {
    if (!user) return null;
    const { _id, username, nombre, apellido, role } = user;
    return { _id, username, nombre, apellido, role };
  };

  // âœ… NUEVO: para CIERRE DE CAJA mandamos SOLO el _id a la API de cierres
  const getOperadorId = () => {
    return user?._id || readOperador()?._id || null;
  };

  // ============ NUEVO: soltar ticket (impresiÃ³n) como el BOT pero para cierres ============
  const imprimirCierre = async (payload) => {
    try {
      // Solo disparamos, sin bloquear el flujo de la UI (similar al BOT)
      fetch('http://localhost:5000/api/tickets/imprimir-cierredecaja', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${localStorage.getItem(TOKEN_KEY) || ''}`,
        },
        body: JSON.stringify(payload),
      }).catch(() => {});
    } catch (e) {
      // No bloqueamos nada si falla
      console.error('No se pudo disparar impresiÃ³n de cierre:', e);
    }
  };
  // =========================================================================================

  const enviarCierreDeCaja = async () => {
    const operadorId = getOperadorId();
    if (!operadorId) return;

    const { fecha, hora } = getFechaHora();
    const totalRecaudado = parseFloat(limpiarNumero(recaudado));
    const efectivoEnCaja = parseFloat(limpiarNumero(enCaja));
    const totalRendido = totalRecaudado - efectivoEnCaja;

    const data = {
      fecha,
      hora,
      totalRecaudado,
      dejoEnCaja: efectivoEnCaja,
      totalRendido,
      operador: operadorId, // ðŸ‘ˆ SOLO el ObjectId en la colecciÃ³n de cierres
    };

    try {
      const res = await fetch('http://localhost:5000/api/cierresDeCaja', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${localStorage.getItem(TOKEN_KEY)}`,
        },
        body: JSON.stringify(data),
      });

      const content = await res.json();

      if (res.ok) {
        // ðŸ”” Disparamos impresiÃ³n ANTES de limpiar token, usando datos locales + operador legible
        const opHuman = operadorPayload();
        imprimirCierre({
          tipo: 'cierreDeCaja',
          cierre: {
            fecha,
            hora,
            totalRecaudado,
            dejoEnCaja: efectivoEnCaja,
            totalRendido,
          },
          operador: opHuman, // para imprimir nombre/usuario
          _idCierre: content?._id || null
        });

        // Deslogueo
        localStorage.removeItem(TOKEN_KEY);
        localStorage.removeItem(OPERADOR_KEY);

        if (localStorage.getItem(TOKEN_KEY)) {
          setMensajeModal({
            titulo: 'Error',
            mensaje: 'No se pudo desloguear, no se realizÃ³ el cierre de caja.',
            onClose: () => setMensajeModal(null)
          });
          return;
        }

        setMensajeModal({
          titulo: 'Ã‰xito',
          mensaje: 'Â¡Caja rendida correctamente! Has sido deslogueado.',
          onClose: () => {
            setMensajeModal(null);
            cerrarModal();
            navigate('/login', { replace: true });
          }
        });
      } else {
        console.error('Error al rendir caja:', content);
        setMensajeModal({
          titulo: 'Error',
          mensaje: 'Error al rendir caja: ' + (content?.message || JSON.stringify(content)),
          onClose: () => setMensajeModal(null)
        });
      }
    } catch (err) {
      console.error(err);
      setMensajeModal({
        titulo: 'Error',
        mensaje: 'Error en la conexiÃ³n.',
        onClose: () => setMensajeModal(null)
      });
    }
  };

  const enviarCierreParcial = async () => {
    const op = operadorPayload();
    if (!op) return;

    const { fecha, hora } = getFechaHora();
    const monto = parseFloat(limpiarNumero(montoParcial));

    const dataCierreParcial = {
      fecha,
      hora,
      monto,
      nombre: nombreParcial || '',
      texto: textoParcial || '',
      operador: op,
    };

    try {
      const resCierreParcial = await fetch('http://localhost:5000/api/cierresDeCaja/parcial', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${localStorage.getItem(TOKEN_KEY)}`,
        },
        body: JSON.stringify(dataCierreParcial),
      });

      if (!resCierreParcial.ok) {
        setMensajeModal({
          titulo: 'Error',
          mensaje: 'Error al registrar cierre parcial.',
          onClose: () => setMensajeModal(null)
        });
        return;
      }

      const { fecha: f2, hora: h2 } = getFechaHora();
      const dataAlerta = {
        fecha: f2,
        hora: h2,
        tipoDeAlerta: `Cierre Parcial ($${monto.toLocaleString('es-AR')})`,
        operador: op,
      };

      const resAlerta = await fetch('http://localhost:5000/api/alertas/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${localStorage.getItem(TOKEN_KEY)}`,
        },
        body: JSON.stringify(dataAlerta),
      });

      if (!resAlerta.ok) {
        setMensajeModal({
          titulo: 'Error',
          mensaje: 'Error al crear la alerta del cierre parcial.',
          onClose: () => setMensajeModal(null)
        });
        return;
      }

      // ðŸ”” Disparamos impresiÃ³n del CIERRE PARCIAL (sin descripciÃ³n, solo monto y nombre si hay)
      imprimirCierre({
        tipo: 'cierreParcial',
        parcial: {
          fecha,
          hora,
          monto,
          nombre: nombreParcial || ''
        },
        operador: op
      });

      setMensajeModal({
        titulo: 'Ã‰xito',
        mensaje: 'Cierre parcial registrado y alerta creada.',
        onClose: () => {
          setMensajeModal(null);
          cerrarModal();
        }
      });
    } catch (err) {
      console.error(err);
      setMensajeModal({
        titulo: 'Error',
        mensaje: 'Error en la conexiÃ³n.',
        onClose: () => setMensajeModal(null)
      });
    }
  };

  const enviarIncidente = async () => {
    const op = operadorPayload();
    if (!op) return;

    const { fecha, hora } = getFechaHora();

    const data = {
      fecha,
      hora,
      texto: incidente,
      operador: op,
    };

    try {
      const res = await fetch('http://localhost:5000/api/incidentes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${localStorage.getItem(TOKEN_KEY)}`,
        },
        body: JSON.stringify(data),
      });

      const content = await res.json();
      if (res.ok) {
        setMensajeModal({
          titulo: 'Ã‰xito',
          mensaje: 'Incidente registrado.',
          onClose: () => {
            setMensajeModal(null);
            cerrarModal();
          }
        });
      } else {
        console.error('Error al registrar incidente:', content);
        setMensajeModal({
          titulo: 'Error',
          mensaje: 'Error al registrar incidente: ' + (content.message || JSON.stringify(content)),
          onClose: () => setMensajeModal(null)
        });
      }
    } catch (err) {
      console.error(err);
      setMensajeModal({
        titulo: 'Error',
        mensaje: 'Error en la conexiÃ³n.',
        onClose: () => setMensajeModal(null)
      });
    }
  };

  const ejecutarBot = async () => {
    let capturaFallida = false;
    let fotoUrlTemporal = null;

    const capturaPromise = (async () => {
      try {
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), 3500);
        const res = await fetch('http://localhost:5000/api/camara/sacarfoto', { signal: controller.signal });
        clearTimeout(t);
        const json = await res.json().catch(() => ({}));
        if (json?.exito) {
          const bust = Date.now();
          const staticUrl = `http://localhost:5000/camara/sacarfoto/captura.jpg?t=${bust}`;
          await new Promise(r => setTimeout(r, 900));
          const head = await fetch(staticUrl, { method: 'HEAD' });
          if (head.ok) {
            fotoUrlTemporal = '/camara/sacarfoto/captura.jpg';
            return true;
          }
        }
        capturaFallida = true;
        return false;
      } catch (err) {
        capturaFallida = true;
        return false;
      }
    })();

    const ticketPromise = (async () => {
      const res = await fetch('http://localhost:5000/api/tickets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      return res.json();
    })();

    let ticketCreado = null;
    try {
      const [_, ticketJson] = await Promise.allSettled([capturaPromise, ticketPromise]);
      ticketCreado = ticketJson.status === 'fulfilled' ? ticketJson.value : null;
    } catch {}

    if (ticketCreado?.ticket?._id && fotoUrlTemporal) {
      try {
        const putRes = await fetch(`http://localhost:5000/api/tickets/${ticketCreado.ticket._id}/foto`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fotoUrl: fotoUrlTemporal })
        });
        if (putRes.ok) {
          const updated = await putRes.json().catch(() => null);
          if (updated?.ticket) ticketCreado.ticket = updated.ticket;
        }
      } catch {}
    }

    if (ticketCreado?.ticket) {
      setTicketPendiente({
        ...ticketCreado.ticket,
        capturaFallida: Boolean(capturaFallida),
        fotoUrl: fotoUrlTemporal || ticketCreado.ticket.fotoUrl || null,
      });
    }

    setTimeout(() => {
      setBarreraIzqAbierta(true);
      setTimeout(() => setBarreraIzqAbierta(false), 10000);
    }, 1500);
  };

  const totalRendidoPreview = () => {
    const rec = parseFloat(limpiarNumero(recaudado));
    const caja = parseFloat(limpiarNumero(enCaja));
    const resta = (!isNaN(rec) ? rec : 0) - (!isNaN(caja) ? caja : 0);
    return formatearVisualmente(String(resta));
  };

  const hayModalBloqueante =
    Boolean(modalActivo) || Boolean(mensajeModal) || Boolean(modalEntradaAbierto);

  return (
    <div className="interfaz">
      <Background />
      <Header
        cambiarVista={setVistaActual}
        vistaActiva={vistaActual}
        abrirModal={setModalActivo}
        setMostrarOverlay={setMostrarOverlay}
        modalActivo={modalActivo}
        onEjecutarBot={ejecutarBot}
        user={user}
        ticketPendiente={ticketPendiente}
        setTicketPendiente={setTicketPendiente}
        mostrarModalEntrada={modalEntradaAbierto}
        setMostrarModalEntrada={setModalEntradaAbierto}
      />
      <div className="content">
        {vistaActual === 'operador' && (
          <Operador 
            ticketPendiente={ticketPendiente} 
            onAbrirBarreraSalida={abrirBarreraSalida}
            setTicketPendiente={forzarLimpiarTicket}
            autoFocusSalida={!hayModalBloqueante}
          />
        )}
        {vistaActual === 'vehiculos' && <VehiculosDentro />}
        {vistaActual === 'turnos' && <Turnos />}
        {vistaActual === 'abono' && <Abono />}
        {vistaActual === 'clientes' && <Clientes onSeleccionarCliente={manejarSeleccionCliente} />}
        {vistaActual === 'detalleCliente' && clienteSeleccionado && (
          <DetalleClienteCajero 
            clienteId={clienteSeleccionado} 
            volver={volverAClientes} 
          />
        )}
        {vistaActual === 'config' && <Config />}
        <PanelDerecho 
          barreraIzquierdaAbierta={barreraIzqAbierta} 
          barreraDerechaAbierta={barreraDerAbierta} 
        />
      </div>

            {modalActivo === 'cierredecaja' && (
        <ModalHeader titulo="Cierre de Caja" onClose={cerrarModal}>

          {/* âœ… CÃ¡lculo de caja del sistema */}
          <div
            style={{
              marginTop: 6,
              marginBottom: 12,
              padding: '10px 12px',
              background: 'transparent',   // ðŸ‘ˆ
              border: 'none',              // opcional
              borderRadius: 0,
              color: 'white',
              fontWeight: 700
            }}
          >
            {calculoCajaLoading ? (
              <span>CÃ¡lculo de Caja: calculando...</span>
            ) : (
              <span>
                CÃ¡lculo de Caja: ${formatARS(calculoCaja)}
              </span>
            )}
          </div>

          {!confirmandoCaja ? (
            <>
              <label>Total en Caja</label>
              <input
                ref={recaudadoRef}
                type="text"
                inputMode="numeric"
                pattern="[0-9]*"
                onKeyDown={handleNumericKeyDown}
                className="modal-input"
                placeholder="Total en Caja"
                value={formatearVisualmente(recaudado)}
                onChange={(e) => setRecaudado(limpiarNumero(e.target.value))}
              />

              <label>Queda en Caja</label>
              <input
                ref={enCajaRef}
                type="text"
                inputMode="numeric"
                pattern="[0-9]*"
                onKeyDown={handleNumericKeyDown}
                className="modal-input"
                placeholder="Queda en Caja"
                value={formatearVisualmente(enCaja)}
                onChange={(e) => setEnCaja(limpiarNumero(e.target.value))}
              />

              <button className="modal-btn" disabled={!isCajaValida()} onClick={() => setConfirmandoCaja(true)}>
                Confirmar
              </button>
            </>
          ) : (
            <>
              <p>Total en Caja: ${formatearVisualmente(recaudado)}</p>
              <p>Queda en Caja: ${formatearVisualmente(enCaja)}</p>
              <p>Total Rendido: ${totalRendidoPreview()}</p>
              <button className="modal-btn" onClick={() => setConfirmandoCaja(false)}>Modificar</button>
              <button className="modal-btn" onClick={enviarCierreDeCaja}>Confirmar</button>
            </>
          )}
        </ModalHeader>
      )}

      {modalActivo === 'cierreparcial' && (
        <ModalHeader titulo="Cierre Parcial" onClose={cerrarModal}>
          <label>Monto</label>
          <input
            ref={montoParcialRef}
            type="text"
            inputMode="numeric"
            pattern="[0-9]*"
            onKeyDown={handleNumericKeyDown}
            className="modal-input"
            placeholder="Monto"
            value={formatearVisualmente(montoParcial)}
            onChange={(e) => setMontoParcial(limpiarNumero(e.target.value))}
          />

          <label>Nombre (opcional)</label>
          <input
            type="text"
            className="modal-input"
            placeholder="Nombre (opcional)"
            value={nombreParcial}
            onChange={(e) => setNombreParcial(e.target.value)}
            maxLength={60}
          />

          <label>Texto (opcional)</label>
          <textarea
            rows={3}
            className="modal-input"
            placeholder="Texto (opcional, mÃ¡x. 300)"
            value={textoParcial}
            onChange={(e) => setTextoParcial(e.target.value)}
            maxLength={300}
          />

          <button className="modal-btn" disabled={!isMontoParcialValido()} onClick={enviarCierreParcial}>
            Confirmar
          </button>
        </ModalHeader>
      )}

      {modalActivo === 'incidente' && (
        <ModalHeader titulo="Incidente" onClose={cerrarModal}>
          <label>DescripciÃ³n del Incidente</label>
          <textarea
            ref={incidenteRef}
            maxLength={300}
            rows={4}
            className="modal-input"
            placeholder="DescribÃ­ el incidente (mÃ¡x. 300 caracteres)"
            value={incidente}
            onChange={(e) => setIncidente(e.target.value)}
          />
          <button className="modal-btn" onClick={enviarIncidente}>Enviar</button>
        </ModalHeader>
      )}

      {mensajeModal && (
        <ModalMensaje
          titulo={mensajeModal.titulo}
          mensaje={mensajeModal.mensaje}
          onClose={mensajeModal.onClose}
        />
      )}
    </div>
  );
}

export default Interfaz;



Interfaz.css:
.interfaz {
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

.content {
  display: flex;
  height: 100%;
}

/* ---------- INPUTS ---------- */

.modal-input {
  width: 100%;
  padding: 0.6rem;
  margin-bottom: 0.8rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem;
  box-sizing: border-box;
  resize: none; /* evita que se agrande el textarea */
}

/* Quita flechas de los inputs tipo number */
.modal-input[type="number"]::-webkit-inner-spin-button,
.modal-input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.modal-input[type="number"] {
  -moz-appearance: textfield; /* Firefox */
}

/* ---------- BOTONES ---------- */

.modal-btn {
  background-color: #444a5a;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 6px;
  margin: 0.4rem 0.3rem;
  cursor: pointer;
  font-weight: bold;
  font-size: 1rem;
  transition: background-color 0.2s ease-in-out;
}

.modal-btn:hover {
  background-color: #5a6275;
}

.modal-btn:disabled {
  background-color: #999;
  cursor: not-allowed;
}

.overlay-submenu {
  position: absolute;
  top: 4.2rem; /* debajo del header */
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 9000;
}

Tabs.jsx:
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import './Tabs.css'; 

function Tabs({ toggleEntradaSalida }) {
  const navigate = useNavigate();

  const handleButtonClick = (route) => {
    navigate(route);
  };

  const handleAdminRedirect = () => {
    window.location.href = 'https://admin.garageia.com/';
  };


  return (
    <div className="tabs">
      <div className="upper-buttons">
        <button 
          className="tab-button" 
          onClick={() => handleButtonClick('/')}
        >
          Operador
        </button>
        <button 
          className="tab-button" 
          onClick={() => handleButtonClick('/caja')}
        >
          Caja
        </button>
      </div>
      <div className="lower-buttons">
        <button 
          className="tab-button" 
          onClick={toggleEntradaSalida}
        >
          Entr/Sal
        </button>
        <button 
          className="tab-button" 
          onClick={handleAdminRedirect}
        >
          Admin
        </button>
      </div>
    </div>
  );
}

export default Tabs;

Tabs.css:
.tabs {
  display: flex;
  flex-direction: column;
  justify-content: center;
  background-color: rgb(12, 26, 34);
  width: 100px;
  padding: 10px;
}

.upper-buttons {
  display: flex;
  flex-direction: column;
  margin-bottom: 100px;
}
.lower-buttons {
  display: flex;
  flex-direction: column;
  margin-top: 100px;
}

.tab-button {
  background-color: rgb(39, 106, 145);
  color: white;
  padding: 10px;
  margin: 5px 0;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-align: center;
}

.tab-button:hover {
  background-color: rgb(27, 75, 102);
}


Header.jsx:
import React, { useState, useEffect, useRef } from 'react';
import './Header.css';
import ModalHeader from './ModalHeader/ModalHeader';
import DatosAutoEntrada from '../../Operador/DatosAutoEntrada/DatosAutoEntrada';
import { FaUserCircle } from 'react-icons/fa';
import { useNavigate } from 'react-router-dom';

const TOKEN_KEY = 'token';
const OPERADOR_KEY = 'operador';

function Header({
  cambiarVista,
  vistaActiva,
  abrirModal,
  setMostrarOverlay,
  modalActivo,
  onEjecutarBot,
  user,
  ticketPendiente,
  setTicketPendiente,
  mostrarModalEntrada,
  setMostrarModalEntrada
}) {
  const [mostrarSubmenu, setMostrarSubmenu] = useState(false);
  const [timestamp, setTimestamp] = useState(Date.now());
  const menuRef = useRef();
  const navigate = useNavigate();

  // â­ NUEVO: menÃº usuario
  const [menuUsuarioVisible, setMenuUsuarioVisible] = useState(false);
  const userMenuRef = useRef();

  const autoPrintTimerRef = useRef(null);

  const handleLogout = async () => {
    try {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(OPERADOR_KEY);
      navigate('/login', { replace: true });
    } catch (err) {
      console.error('Error al desloguearse:', err);
    }
  };

  // Cerrar SubmenÃº al hacer click afuera
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (menuRef.current && !menuRef.current.contains(event.target)) {
        setMostrarSubmenu(false);
        setMostrarOverlay(false);
      }
      // â­ NUEVO: cierre menÃº usuario
      if (userMenuRef.current && !userMenuRef.current.contains(event.target)) {
        setMenuUsuarioVisible(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [setMostrarOverlay]);

  const manejarCambioVista = (vista) => {
    cambiarVista(vista);
    setMostrarSubmenu(false);
    setMostrarOverlay(false);
  };

  const handleAbonoClick = () => {
    if (modalActivo !== null) return;
    const nuevoEstado = !mostrarSubmenu;
    setMostrarSubmenu(nuevoEstado);
    setMostrarOverlay(nuevoEstado);
  };

  const handleAbrirModal = (modal) => {
    if (mostrarSubmenu) {
      setMostrarSubmenu(false);
      setMostrarOverlay(false);
    }
    abrirModal(modal);
  };

  const getButtonClass = (boton) => {
    if (modalActivo !== null) {
      switch (modalActivo) {
        case 'cierredecaja': return boton === 'cierredecaja' ? 'boton-activo' : '';
        case 'cierreparcial': return boton === 'cierreparcial' ? 'boton-activo' : '';
        case 'incidente': return boton === 'incidente' ? 'boton-activo' : '';
        case 'config': return !mostrarSubmenu && vistaActiva === 'config' ? 'boton-activo' : '';
        default: return '';
      }
    }
    switch (boton) {
      case 'operador':
      case 'vehiculos':
      case 'turnos':
        return !mostrarSubmenu && vistaActiva === boton ? 'boton-activo' : '';
      case 'abono':
        return (mostrarSubmenu || vistaActiva === 'abono' || vistaActiva === 'clientes' || vistaActiva === 'detalleCliente') ? 'boton-activo' : '';
      default:
        return '';
    }
  };

  const handleEjecutarBot = () => {
    setMostrarModalEntrada(true);
    setTimestamp(Date.now());
    Promise.resolve(onEjecutarBot()).catch(() => {});
  };

  const cancelarAutoImpresion = () => {
    if (autoPrintTimerRef.current) {
      clearTimeout(autoPrintTimerRef.current);
      autoPrintTimerRef.current = null;
    }
  };

  const handleEntradaConfirmada = () => {
    cancelarAutoImpresion();
  };

  return (
    <header className="topbar">
      <h1>Parking</h1>
      <div className="menu" ref={menuRef}>
        
        <button className={getButtonClass('operador')} onClick={() => manejarCambioVista('operador')} disabled={modalActivo !== null}>Operador</button>
        <button className={getButtonClass('vehiculos')} onClick={() => manejarCambioVista('vehiculos')} disabled={modalActivo !== null}>AuditorÃ­a</button>
        <button className={getButtonClass('turnos')} onClick={() => manejarCambioVista('turnos')} disabled={modalActivo !== null}>Anticipados</button>
        <button className={getButtonClass('abono')} onClick={handleAbonoClick} disabled={modalActivo !== null && !mostrarSubmenu}>Abono</button>

        {mostrarSubmenu && (
          <div className="submenu">
            <button onClick={() => manejarCambioVista('abono')}>Nuevo</button>
            <button onClick={() => manejarCambioVista('clientes')}>Renovar/Editar</button>
          </div>
        )}

        <button className={getButtonClass('cierredecaja')} onClick={() => handleAbrirModal('cierredecaja')}>Cierre de Caja</button>
        <button className={getButtonClass('cierreparcial')} onClick={() => handleAbrirModal('cierreparcial')}>Cierre Parcial</button>
        <button className={getButtonClass('incidente')} onClick={() => handleAbrirModal('incidente')}>Incidente</button>
        <button className={getButtonClass('config')} onClick={() => manejarCambioVista('config')} disabled={modalActivo !== null}>Config</button>
        <button className="boton-bot" onClick={handleEjecutarBot} disabled={modalActivo !== null}>BOT</button>

        {/* â­ NUEVO: ICONO USUARIO */}
        <div className="user-wrapper" ref={userMenuRef}>
          <div
            className="user-circle"
            onClick={() => setMenuUsuarioVisible((v) => !v)}
          >
            <FaUserCircle size={22} />
          </div>

          {menuUsuarioVisible && (
            <div className="user-menu">
              <div className="user-menu-nombre">
                {user?.username} 
              </div>
              <button className="cerrar-sesion" onClick={handleLogout}>
                Cerrar SesiÃ³n
              </button>
            </div>
          )}
        </div>

      </div>

      {mostrarModalEntrada && (
        <ModalHeader titulo="Registrar Entrada" onClose={() => {
          cancelarAutoImpresion();
          setMostrarModalEntrada(false);
        }}>
          <DatosAutoEntrada
            user={user}
            ticketPendiente={ticketPendiente}
            onClose={() => {
              cancelarAutoImpresion();
              setMostrarModalEntrada(false);
              setTicketPendiente(null);
            }}
            timestamp={timestamp}
            setTicketPendiente={setTicketPendiente}
            autoFocusOnMount
            onEntradaConfirmada={handleEntradaConfirmada}
          />
        </ModalHeader>
      )}
    </header>
  );
}

export default Header;


Header.css:
/* Header.css */
.topbar {
  background-color: #2a2a38;
  display: flex;
  justify-content: space-between;
  padding: 1rem 2rem;
  align-items: center;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  position: relative;
  z-index: 9999;
}

.topbar h1 {
  font-size: 1.8rem;
  margin: 0;
  color: white;
}

.menu {
  display: flex;
}

.menu button, .menu a {
  margin-left: 1rem;
  background-color: #444a5a;
  color: white;
  border: none;
  padding: 0.6rem 1rem;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease;
}

.menu button:hover, .menu a:hover {
  background-color: #00adb5;
  transform: scale(1.05);
}

.menu-button {
  text-decoration: none;
  background-color: #444a5a;
  padding: 0.6rem 1rem;
  border-radius: 5px;
  color: white;
  transition: background-color 0.3s ease, transform 0.2s ease;
}

.menu-button:hover {
  background-color: #00adb5;
  transform: scale(1.05);
}

.menu button.boton-activo {
  background-color: #00adb5;
  transform: scale(1.05);
}

.submenu-wrapper {
  position: relative;
}

.submenu {
  position: absolute;
  top: 90%;
  left: calc(27rem + 11.6rem);
  display: flex;
  z-index: 99999;
}

.menu .submenu button, .menu a {
  margin-left: 1rem !important;
}

.submenu button {
  background-color: #444a5a;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease;
}

.submenu button:hover {
  background-color: #00adb5;
  transform: scale(1.05);
}

/* ===========================
   Avatar Usuario (react-icons)
   =========================== */
.user-wrapper {
  position: relative;
  margin-left: 1.2rem; 
  display: flex;
  align-items: center;
}

/* CÃ­rculo contenedor */
.user-circle {
  width: 28px;
  height: 28px;
  background: #2f3542;
  border: 2px solid #00acb557;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: white;
  transition: background 0.2s ease, transform 0.15s ease, border-color 0.2s ease;
}

.user-circle:hover {
  background: #00acb56c;
  color: black;
  border-color: #00deea5e;
  transform: scale(1.01);
}

/* MenÃº desplegable */
.user-menu {
  position: absolute;
  right: 0;
  top: 110%;
  background: #2f3543;
  border: 1px solid #00acb571;
  border-radius: 8px;
  padding: 0.7rem 0;
  min-width: 170px;
  display: flex;
  flex-direction: column;
  z-index: 999999;
  box-shadow: 0px 4px 12px rgba(0,0,0,0.35);
  animation: fadeInUserMenu 0.12s ease-out;
}

@keyframes fadeInUserMenu {
  from { opacity: 0; transform: translateY(-4px); }
  to   { opacity: 1; transform: translateY(0); }
}

.user-menu-nombre {
  padding: 0.6rem 1rem;
  color: #cfd6e3;
  font-size: 0.95rem;
}

.user-menu-btn {
  background: transparent;
  color: #ff6b6b;
  border: none;
  text-align: left;
  padding: 0.7rem 1rem;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.2s ease;
}

.user-menu-btn:hover {
  background: rgba(255, 107, 107, 0.15);
}

.cerrar-sesion {
  margin: 0px 15px !important;
  padding: 7px 0px !important;
}

ModalHeader.jsx:
// ModalHeader.jsx
import React, { useRef, useEffect } from 'react';
import './ModalHeader.css';

function ModalHeader({ titulo, onClose, children }) {
  const contenedorRef = useRef();

  useEffect(() => {
    const handleClickOutside = (e) => {
      if (contenedorRef.current && !contenedorRef.current.contains(e.target)) {
        onClose();
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [onClose]);

  return (
    <div className="modal-backdrop">
      <div className="modal-contenedor" ref={contenedorRef}>
        <div className="modal-header">
          <h2>{titulo}</h2>
          <button className="modal-cerrar" onClick={onClose}>X</button>
        </div>
        <div className="modal-body">{children}</div>
      </div>
    </div>
  );
}

export default ModalHeader;


ModalHeader.css:
.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

.modal-contenedor {
  background: #2a2a38;
  border: 1px solid #1c1c26;
  padding: 5px 20px 20px 20px;
  border-radius: 12px;
  width: 400px;
  max-width: 90%;
  box-shadow: 0 0 12px rgba(0, 0, 0, 0.5);
  animation: fadeIn 0.2s ease-out;
  color: white;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-cerrar {
  background: none;
  border: none;
  font-size: 20px;
  color: white;
  cursor: pointer;
}

.modal-body {
  margin-top: 10px;
}

.modal-input {
  background-color: #1f1f28;
  border: 1px solid #444a5a;
  border-radius: 4px;
  padding: 0.4rem 0.5rem;
  color: white;
  width: 100%;
  outline: none;
  margin-bottom: 1rem;
  transition: border-color 0.3s;
}

/* Fade-in suave */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.96);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}



PanelDerecho.jsx:
import React from 'react';
import './PanelDerecho.css';

import barrierIcon from '../../../../public/images/parking-barrier.svg';

function PanelDerecho({ barreraIzquierdaAbierta, barreraDerechaAbierta }) {
  const getColorFilter = (abierta) =>
    abierta
      ? 'brightness(0) saturate(100%) invert(58%) sepia(25%) saturate(980%) hue-rotate(72deg) brightness(92%) contrast(93%)' // Verde intermedio
      : 'brightness(0) saturate(100%) invert(18%) sepia(80%) saturate(4100%) hue-rotate(342deg) brightness(90%) contrast(97%)'; // Rojo menos naranja

  return (
    <div className="right-side">
      <div className="barreras-superior">
        <div className="barrera-container">
          <img
            src={barrierIcon}
            alt="Barrera Entrada"
            className="barrera-img"
            style={{
              filter: getColorFilter(barreraIzquierdaAbierta),
              transform: barreraIzquierdaAbierta ? 'rotate(-45deg)' : 'rotate(0deg)',
            }}
          />
          <span className="barrera-label">Entr.</span>
        </div>

        <div className="barrera-container">
          <img
            src={barrierIcon}
            alt="Barrera Salida"
            className="barrera-img"
            style={{
              filter: getColorFilter(barreraDerechaAbierta),
              transform: barreraDerechaAbierta ? 'rotate(-45deg)' : 'rotate(0deg)',
            }}
          />
          <span className="barrera-label">Sal.</span>
        </div>
      </div>
    </div>
  );
}

export default PanelDerecho;

PanelDerecho.css:
.right-side {
  display: flex;
  background-color: rgba(0, 0, 0, 0.31);
  width: 125px;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  padding: 10px 0;
}

.barreras-superior {
  display: flex;
  flex-direction: row;
  gap: 12px;
  align-items: center;
  justify-content: center;
  margin-top: 20px;
}

.barrera-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.barrera-img {
  width: 48px;
  height: 48px;
  transition: filter 0.3s ease, transform 0.4s ease;
}

.barrera-label {
  color: white;
  font-weight: bold;
  margin-top: 4px;
  font-size: 12px;
  text-align: center;
}


Background.jsx:
import React from 'react';
import './Background.css';

function Background() {
    return <div className="background"></div>;
  }
  
export default Background;


Background.css:
.background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: #1f1f28;  
  /* background-image: url('https://www.misabogados.com/hubfs/egor-myznik-rCZQCbUAQvg-unsplash%20(1)-2.webp'); */
  background-size: cover;
  background-position: center;
  z-index: -100;
  }



Login.jsx:
import "./Login.css";
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';

const TOKEN_KEY = 'token';
const REDIRECT_KEY = 'redirectAfterLogin';
const OPERADOR_KEY = 'operador';

// helper para normalizar el operador (por si viene doblemente serializado)
function normalizeOperador(opCandidate) {
  if (!opCandidate) return null;
  if (typeof opCandidate === 'object') return opCandidate;
  if (typeof opCandidate === 'string') {
    try {
      const p1 = JSON.parse(opCandidate);
      if (p1 && typeof p1 === 'object') return p1;
    } catch {}
  }
  return null;
}

function Login() {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);
  const navigate = useNavigate();

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError(null);
    setLoading(true);

    try {
      const response = await fetch('http://localhost:5000/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password }),
      });

      const data = await response.json();

      if (response.ok) {
        localStorage.setItem(TOKEN_KEY, data.token);

        // normalizamos operador (sea data.operador, data.user o string) y guardamos BIEN
        const rawOp = data.operador ?? data.user ?? null;
        const op = normalizeOperador(rawOp) ?? (typeof rawOp === 'object' ? rawOp : null);
        if (op) {
          localStorage.setItem(OPERADOR_KEY, JSON.stringify(op));
        } else {
          // si vino mal, limpiamos para forzar login
          localStorage.removeItem(OPERADOR_KEY);
        }

        // ðŸ‘‰ RedirecciÃ³n inmediata por rol
        if (op?.role === 'cargaMensuales') {
          localStorage.removeItem(REDIRECT_KEY); // landing fija para este rol
          navigate('/carga-mensuales', { replace: true });
          return;
        }

        // Caso general
        const redirectTo = localStorage.getItem(REDIRECT_KEY) || '/';
        localStorage.removeItem(REDIRECT_KEY);
        navigate(redirectTo, { replace: true });
      } else {
        setError(data.msg || 'Error en el login');
      }
    } catch (err) {
      setError('Hubo un problema con la conexiÃ³n');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="login">
      <div className="containerLogin">
        <div className="login-container">
          <h1>Iniciar SesiÃ³n</h1>
          <form onSubmit={handleSubmit}>
            <label className="input-label">
              <p>Usuario</p>
              <input
                type="text"
                placeholder="Ingresa tu usuario"
                className="input-field"
                value={username}
                onChange={(e) => setUsername(e.target.value)} 
              />
            </label>
            <label className="input-label">
              <p>ContraseÃ±a</p>
              <input
                type="password"
                placeholder="Ingresa tu contraseÃ±a"
                className="input-field"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
            </label>
            <button type="submit" className="login-button" disabled={loading}>
              {loading ? "Cargando..." : "Iniciar SesiÃ³n"}
            </button>
          </form>
          {error && <p className="error-message">{error}</p>}
        </div>
      </div>
    </div>
  );
}

export default Login;

Login.css:
.login {
    font-family: Manrope, "Noto Sans", sans-serif;
    background-color: #111a22;
    color: white;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}

.logo-container {
    display: flex;
    align-items: center;
    gap: 10px;
}
.logo svg {
    width: 30px;
    height: 30px;
    color: white;
}

h2 {
    font-size: 20px;
    font-weight: bold;
}


/* Formulario */
.login-container {
    text-align: center;
    padding: 30px 0;
}

h1 {
    font-size: 22px;
    font-weight: bold;
    margin-bottom: 20px;
}


/* Inputs */
.input-label {
    display: flex;
    flex-direction: column;
    text-align: left;
    margin-bottom: 15px;
}
.input-label p {
    margin-bottom: 5px;
    font-weight: 500;
}

.input-field {
    padding: 12px;
    border: 1px solid #344d65;
    background-color: #1a2632;
    color: white;
    border-radius: 10px;
    font-size: 16px;
}
.input-field::placeholder {
    color: #93adc8;
}


/* BotÃ³n */
.login-button {
    width: 100%;
    padding: 12px;
    background-color: #1980e6;
    color: white;
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 10px;
    cursor: pointer;
}
.login-button:hover {
    background-color: #1563b3;
}
.login-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

.success-message {
    color: green;
    margin-top: 10px;
    font-size: 14px;
}
.error-message {
    color: red;
    margin-top: 10px;
    font-size: 14px;
}

/* Link de "Forgot Password" */
.forgot-password {
    color: #93adc8;
    font-size: 14px;
    text-decoration: underline;
    margin-top: 10px;
}



Abono.jsx:
// Abono.jsx
import "./Abono.css";
import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
// â¬‡ï¸ Panel izquierdo (lista de clientes)
import DatosClientesAbono from "./DatosClientesAbono/DatosClientesAbonos";
import DatosAutoAbono from "./DatosAutoAbono/DatosAutoAbono";

function Abono() {
  const [datosVehiculo, setDatosVehiculo] = useState({
    patente: "",
    tipoVehiculo: "",
  });

  // â¬…ï¸ nuevo: guardo el cliente elegido para prellenar el form derecho
  const [clienteSeleccionado, setClienteSeleccionado] = useState(null);

  const [user, setUser] = useState(null);
  const navigate = useNavigate();

  // ===== Traer datos del usuario logueado (igual que antes) =====
  useEffect(() => {
    const fetchUser = async () => {
      const token = localStorage.getItem("token");

      if (!token) {
        navigate("/login");
        return;
      }

      try {
        const response = await fetch("http://localhost:5000/api/auth/profile", {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
        });

        const data = await response.json();

        if (response.ok) {
          setUser(data);
        } else {
          if (response.status === 401) {
            localStorage.removeItem("token");
            setUser(null);
            navigate("/login");
          }
        }
      } catch (error) {
        console.error("Error fetching user:", error);
      }
    };

    fetchUser();
  }, [navigate]);

  // ===== Cuando el usuario elige un cliente en la izquierda =====
  const handleElegirCliente = (cliente) => {
    // guardo el cliente elegido (para completar el formulario a la derecha)
    setClienteSeleccionado(cliente || null);

    // si el cliente tiene patente guardada, la llevamos al form derecho
    const patente = (cliente?.patente || "").toUpperCase().slice(0, 10);
    setDatosVehiculo((prev) => ({
      ...prev,
      patente,
      // tipoVehiculo lo dejÃ¡s a elecciÃ³n del operador en el form derecho
    }));
  };

  return (
    <div className="contenidoCentral">
      {/* â¬…ï¸ Lista de clientes (buscador + refresh + tabla) */}
      <div className="izquierdaAbono">
        <DatosClientesAbono onPickCliente={handleElegirCliente} />
      </div>

      {/* âž¡ï¸ Derecha: formulario (recibe datosVehiculo + clienteSeleccionado) */}
      <div className="derechaAbono">
        <DatosAutoAbono
          datosVehiculo={datosVehiculo}
          clienteSeleccionado={clienteSeleccionado}
          user={user}
        />
      </div>
    </div>
  );
}

export default Abono;


Abono.css:
.izquierdaAbono {
  display: flex;
  flex: 1;
  padding: 6px 10px 10px 10px;

  /* â¬‡ï¸ Asegura que el panel ocupe todo el alto disponible y no quede centrado */
  align-items: stretch;
  align-self: stretch;
  height: 100%;
  min-height: 100%;
}

.derechaAbono {
  display: flex;
  flex: 1.5;
  padding: 10px 10px 20px 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}



DatosClientesAbonos.jsx:
// DatosClientesAbonos.jsx
import React, {
  useCallback,
  useEffect,
  useMemo,
  useRef,
  useState,
  Fragment,
} from "react";
import { FaArrowRight } from "react-icons/fa";
import "./DatosClientesAbonos.css";

const BASE_URL = "http://localhost:5000";
const COOLDOWN_SECONDS = 5;

const normCocheraFront = (raw) => {
  const v = String(raw || "").trim().toLowerCase();
  if (v === "fija") return "Fija";
  if (v === "mÃ³vil" || v === "movil") return "MÃ³vil";
  return "";
};

// Formateador DNI con puntos
const formatDNI = (raw) => {
  const v = String(raw || "").replace(/\D/g, "");
  if (!v) return "";
  if (v.length <= 3) return v;

  const len = v.length;
  let firstGroupLen = len % 3;
  if (firstGroupLen === 0) firstGroupLen = 3;

  let result = v.slice(0, firstGroupLen);
  for (let i = firstGroupLen; i < len; i += 3) {
    result += "." + v.slice(i, i + 3);
  }
  return result;
};

export default function DatosClientesAbonos({ onPickCliente }) {
  const [clientes, setClientes] = useState([]);
  const [q, setQ] = useState("");
  const [loading, setLoading] = useState(false);

  const [isRefreshing, setIsRefreshing] = useState(false);
  const [cooldownLeft, setCooldownLeft] = useState(0);

  const [cocherasMap, setCocherasMap] = useState({});
  const [cocherasLoading, setCocherasLoading] = useState({});

  const cooldownTimerRef = useRef(null);

  const startCooldown = useCallback(() => {
    if (cooldownTimerRef.current) clearInterval(cooldownTimerRef.current);
    setCooldownLeft(COOLDOWN_SECONDS);
    cooldownTimerRef.current = setInterval(() => {
      setCooldownLeft((s) => {
        if (s <= 1) {
          clearInterval(cooldownTimerRef.current);
          cooldownTimerRef.current = null;
          return 0;
        }
        return s - 1;
      });
    }, 1000);
  }, []);

  useEffect(() => {
    return () => {
      if (cooldownTimerRef.current) clearInterval(cooldownTimerRef.current);
    };
  }, []);

  const fetchClientes = useCallback(async () => {
    setLoading(true);
    try {
      const res = await fetch(`${BASE_URL}/api/clientes`, { cache: "no-store" });
      if (!res.ok) throw new Error("No se pudo cargar la lista de clientes");
      const data = await res.json();
      setClientes(Array.isArray(data) ? data : []);
    } catch (e) {
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, []);

  const fetchCocherasByCliente = useCallback(async (cliente) => {
    const clienteId = cliente?._id;
    if (!clienteId) return;

    // Si ya cargamos las cocheras antes, no repetimos
    setCocherasMap((prev) => {
      if (prev[clienteId]) {
        // Ya estÃ¡ cargado, no hace falta seguir
        return prev;
      }
      return prev;
    });

    // Si ya se estÃ¡ cargando para este cliente, no duplicamos
    if (cocherasLoading[clienteId]) return;

    const cocherasRefs = Array.isArray(cliente.cocheras) ? cliente.cocheras : [];

    // Si el cliente no tiene cocheras asociadas, guardamos array vacÃ­o y salimos
    if (cocherasRefs.length === 0) {
      setCocherasMap((prev) => ({ ...prev, [clienteId]: [] }));
      return;
    }

    setCocherasLoading((prev) => ({ ...prev, [clienteId]: true }));

    try {
      const richCocheras = await Promise.all(
        cocherasRefs.map(async (ref) => {
          const id = ref?.cocheraId;
          if (!id) return null;

          try {
            const res = await fetch(`${BASE_URL}/api/cocheras/${id}`);
            if (!res.ok) return null;
            const data = await res.json();
            return data && data._id ? data : null;
          } catch (err) {
            console.error("[DatosClientesAbonos] error fetch cochera por id", err);
            return null;
          }
        })
      );

      const filtered = richCocheras.filter(Boolean);

      setCocherasMap((prev) => ({
        ...prev,
        [clienteId]: filtered,
      }));
    } catch (e) {
      console.error("[DatosClientesAbonos] error general fetch cocheras cliente", e);
      setCocherasMap((prev) => ({ ...prev, [clienteId]: [] }));
    } finally {
      setCocherasLoading((prev) => ({ ...prev, [clienteId]: false }));
    }
  }, [cocherasLoading]);

  const softRefresh = useCallback(
    async () => {
      if (isRefreshing || cooldownLeft > 0) return;
      setIsRefreshing(true);
      try {
        await fetchClientes();
        setCocherasMap({});
      } finally {
        setIsRefreshing(false);
        startCooldown();
      }
    },
    [fetchClientes, isRefreshing, cooldownLeft, startCooldown]
  );

  useEffect(() => {
    fetchClientes();
  }, [fetchClientes]);

  const filtered = useMemo(() => {
    const term = q.trim().toLowerCase();

    const base = !term
      ? clientes
      : clientes.filter((c) => {
          const nombre = String(c?.nombreApellido || "").toLowerCase();
          const dni = String(c?.dniCuitCuil || "").toLowerCase();
          const email = String(c?.email || "").toLowerCase();
          const patente = String(c?.patente || "").toLowerCase();
          return (
            nombre.includes(term) ||
            dni.includes(term) ||
            email.includes(term) ||
            patente.includes(term)
          );
        });

    const withCochera = [];
    const withoutCochera = [];

    const sortByNombre = (a, b) =>
      String(a?.nombreApellido || "").localeCompare(
        String(b?.nombreApellido || ""),
        "es",
        { sensitivity: "base" }
      );

    for (const c of base) {
      const id = c?._id;

      // 1) Si ya resolvimos cocherasMap, ESO manda.
      const resolved = id ? cocherasMap[id] : undefined;
      if (Array.isArray(resolved)) {
        (resolved.length > 0 ? withCochera : withoutCochera).push(c);
        continue;
      }

      // 2) Si todavÃ­a no resolvimos, consideramos "tiene cochera" SOLO si hay refs con cocheraId vÃ¡lido
      const refs = Array.isArray(c?.cocheras) ? c.cocheras : [];
      const hasValidRef = refs.some((r) => r?.cocheraId);

      (hasValidRef ? withCochera : withoutCochera).push(c);
    }

    withCochera.sort(sortByNombre);
    withoutCochera.sort(sortByNombre);

    return [...withCochera, ...withoutCochera];
  }, [clientes, q, cocherasMap]);


  const showSkeleton = loading || isRefreshing;

  const buildCocheraLabel = (k) => {
    const tipo = normCocheraFront(k?.tipo) || "â€”";
    const piso = k?.piso ? ` â€¢ NÂ° ${k.piso}` : "";
    const exclusiva = k?.exclusiva ? " â€¢ Exclusiva" : "";
    return `${tipo}${piso}${exclusiva}`;
  };

  const handlePickCochera = (cliente, cocheraSnap) => {
    if (!onPickCliente) return;
    const cocheraNorm = normCocheraFront(cocheraSnap?.tipo);
    const payload = {
      ...cliente,
      cochera: cocheraNorm,
      piso: cocheraSnap?.piso || "",
      exclusiva: !!cocheraSnap?.exclusiva,
      cocheraSeleccionadaId: cocheraSnap?._id || null,
    };
    onPickCliente(payload);
  };

  return (
    <div className="dca-wrap">
      <div className="dca-header">
        <input
          className="dca-search"
          placeholder="Buscar por nombre, DNI, email o patenteâ€¦"
          value={q}
          onChange={(e) => setQ(e.target.value)}
        />
        <button
          className={`dca-refresh ${isRefreshing ? "is-busy" : ""}`}
          onClick={softRefresh}
          disabled={isRefreshing || cooldownLeft > 0}
        >
          {isRefreshing
            ? "Actualizandoâ€¦"
            : cooldownLeft > 0
            ? `Refrescar (${cooldownLeft})`
            : "Refrescar"}
        </button>
      </div>

      <div className="dca-tablebox">
        <table className="dca-table">
          <colgroup>
            <col style={{ width: "34%" }} />
            <col style={{ width: "18%" }} />
            <col style={{ width: "38%" }} />
            <col style={{ width: "10%" }} />
          </colgroup>

          <thead>
            <tr>
              <th>Nombre</th>
              <th>DNI/CUIT</th>
              <th>Email</th>
              <th></th>
            </tr>
          </thead>

          <tbody>
            {showSkeleton ? (
              Array.from({ length: 8 }).map((_, i) => (
                <tr key={`sk-${i}`} className="dca-skel-row">
                  <td><div className="dca-skel dca-w60" /></td>
                  <td><div className="dca-skel dca-w40" /></td>
                  <td><div className="dca-skel dca-w70" /></td>
                  <td><div className="dca-skel dca-w20" /></td>
                </tr>
              ))
            ) : filtered.length === 0 ? (
              <tr>
                <td colSpan={4}>
                  <div className="dca-empty">No hay clientes que coincidan.</div>
                </td>
              </tr>
            ) : (
              filtered.map((c) => {
                const clienteId = c._id;
                const keyCliente = clienteId || `${c.dniCuitCuil}-${c.email}`;

                // Lazy load obligatorio para cada cliente, usando los cocheraId que trae el cliente
                if (clienteId && !cocherasMap[clienteId] && !cocherasLoading[clienteId]) {
                  fetchCocherasByCliente(c);
                }

                const cocheras = cocherasMap[clienteId] || [];
                const isCocheraLoading = cocherasLoading[clienteId];

                return (
                  <Fragment key={keyCliente}>
                    <tr className="dca-client-row">
                      <td>{c?.nombreApellido || "â€”"}</td>
                      <td>{formatDNI(c?.dniCuitCuil)}</td>
                      <td className="dca-email">{c?.email || "â€”"}</td>
                      <td></td>
                    </tr>

                    {isCocheraLoading ? (
                      <tr className="dca-cochera-row-empty">
                        <td></td>
                        <td></td>
                        <td className="dca-ellipsis dca-cochera-label-empty">
                          (Cargando cocherasâ€¦)
                        </td>
                        <td></td>
                      </tr>
                    ) : cocheras.length === 0 ? (
                      <tr className="dca-cochera-row-empty">
                        <td></td>
                        <td></td>
                        <td className="dca-ellipsis dca-cochera-label-empty">
                          (Sin cocheras registradas)
                        </td>
                        <td></td>
                      </tr>
                    ) : (
                      cocheras.map((k, idx) => {
                        const rowKey = k._id || `${keyCliente}-co-${idx}`;
                        return (
                          <tr key={rowKey} className="dca-cochera-row">
                            <td></td>
                            <td></td>
                            <td className="dca-ellipsis dca-cochera-label">
                              {buildCocheraLabel(k)}
                            </td>
                            <td>
                              <button
                                className="dca-pick"
                                onClick={() => handlePickCochera(c, k)}
                              >
                                <FaArrowRight />
                              </button>
                            </td>
                          </tr>
                        );
                      })
                    )}
                  </Fragment>
                );
              })
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}


DatosClientesAbonos.css:
/* DatosClientesAbonos.css */

.dca-wrap {
  display: flex;
  flex-direction: column;
  background-color: #2a2a38;
  color: #fff;
  width: 100%;
  border-radius: 6px;
  padding: 10px;
  gap: 10px;
  height: 100%;
  min-height: 100%;
}

/* Header */
.dca-header {
  display: flex;
  gap: 8px;
  align-items: center;
}

.dca-search {
  flex: 1;
  background-color: #1f1f28;
  border: 1px solid #444a5a;
  border-radius: 4px;
  padding: 0.45rem 0.55rem;
  color: #fff;
  outline: none;
  transition: border-color 0.2s ease;
}
.dca-search:focus {
  border-color: rgb(100, 108, 133);
}

.dca-refresh {
  background-color: #00bcd4;
  border: none;
  border-radius: 4px;
  padding: 0.5rem 0.7rem;
  color: white;
  font-weight: 600;
  cursor: pointer;
  min-width: 110px;
}
.dca-refresh:hover {
  background-color: #00a0b3;
}
.dca-refresh:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Tabla */
.dca-tablebox {
  background: #2a2a38;
  border: 1px solid #444a5a;
  border-radius: 6px;
  overflow: hidden;
  flex: 1;
  min-height: 0;
  overflow-y: auto;
}

.dca-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

.dca-table thead th {
  position: sticky;
  top: 0;
  background: #262634;
  color: #ddd;
  font-weight: 700;
  font-size: 0.85rem;
  padding: 8px 10px;
  border-bottom: 1px solid #3a3f50;
}

.dca-table tbody td {
  padding: 7px 8px;
  font-size: 0.9rem;
  color: #eee;
  border-bottom: 1px solid #3a3f50;
}

/* Hover */
.dca-table tbody tr:hover {
  background: #343445;
}

/* Fila cochera */
.dca-cochera-row td {
  padding: 4px 10px;
  border-bottom: 1px solid #333645;
  box-shadow: inset 0 0.6px 0px rgba(0,0,0,0.35);
}

/* Variante vacÃ­o */
.dca-cochera-row-empty td {
  padding: 4px 10px;
  background: #20202a;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.4);
  border-bottom: 1px solid #333645;
}

/* BotÃ³n flecha */
.dca-pick {
  background-color: #00bcd4;
  border: none;
  border-radius: 6px;
  width: 34px;
  height: 20px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  cursor: pointer;
  font-size: 0.8rem;
  transition: background-color 0.2s ease, transform 0.05s ease;
}
.dca-pick:hover {
  background-color: #00a0b3;
}
.dca-pick:active {
  transform: translateY(1px);
}

.dca-ellipsis {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Skeletons */
.dca-skel-row .dca-skel {
  background: linear-gradient(90deg, #303043, #383853, #303043);
  background-size: 200% 100%;
  animation: dca-shimmer 1.4s ease-in-out infinite;
  border-radius: 4px;
  height: 12px;
}

.dca-w20 { width: 20px; }
.dca-w30 { width: 30px; }
.dca-w40 { width: 40px; }
.dca-w60 { width: 60px; }
.dca-w70 { width: 70px; }

@keyframes dca-shimmer {
  0% { background-position: 0% 50%; }
  100% { background-position: 200% 50%; }
}

/* Empty state */
.dca-empty {
  text-align: center;
  padding: 16px 0;
  color: #ccc;
}

/* Alinear */
.dca-table td,
.dca-table th {
  vertical-align: middle;
}

/* EMAIL â€” NUEVO  
   No cortar salvo que sea exageradamente largo */
.dca-email {
  min-width: 180px;     /* antes 260px fijo */
  max-width: 50%;       /* dinÃ¡mico, mucho mÃ¡s flexible */
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

/* Cochera: multilinea */
.dca-cochera-label,
.dca-cochera-label-empty {
  white-space: normal !important;
}

/* ==============================
   SCROLL ESTILIZADO
============================== */

/* Chrome / Edge / Safari */
.dca-tablebox::-webkit-scrollbar {
  width: 10px;
}

.dca-tablebox::-webkit-scrollbar-track {
  background: #1f1f28;
  border-left: 1px solid #2e2e3d;
}

.dca-tablebox::-webkit-scrollbar-thumb {
  background: linear-gradient(
    180deg,
    #00bcd4,
    #0097a7
  );
  border-radius: 6px;
  border: 2px solid #1f1f28;
}

.dca-tablebox::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(
    180deg,
    #00d5ef,
    #00a0b3
  );
}

/* Firefox */
.dca-tablebox {
  scrollbar-width: thin;
  scrollbar-color: #00bcd4 #1f1f28;
}


DatosAutoAbono.jsx:
// src/components/CargaMensuales/DatosAutoAbono.jsx
import React, { useState, useEffect, useRef } from "react";
import { FaCamera, FaCheckCircle } from "react-icons/fa";
import ModalMensaje from "../../ModalMensaje/ModalMensaje";
import "./DatosAutoAbono.css";

// ðŸ‘‡ USAMOS EL MISMO HOOK CENTRAL QUE EN DatosPago
import { useTarifasData } from "../../../hooks/tarifasService";

const BASE_URL = "http://localhost:5000";

// === Helpers de abono (tier segÃºn cochera/exclusiva) ===
const getTierName = (cochera, exclusiva) => {
  // Cochera puede venir como "Fija", "MÃ³vil", "fija", "movil"
  const c = String(cochera || "").trim().toLowerCase();
  if (c === "fija") return exclusiva ? "exclusiva" : "fija";
  // Default: todo lo que no sea "fija" se considera mÃ³vil
  return "mÃ³vil";
};

const getAbonoTierKeyCandidates = (cochera, exclusiva) => {
  const t = getTierName(cochera, exclusiva); // 'mÃ³vil' | 'fija' | 'exclusiva'
  if (t === "mÃ³vil") return ["mÃ³vil", "movil"]; // compat sin tilde en catÃ¡logos viejos
  return [t];
};

// === NormalizaciÃ³n ligera FRONT (el back tambiÃ©n normaliza) ===
// FRONT â†’ BACK: siempre "Fija" | "MÃ³vil"
const normCocheraFront = (raw) => {
  const v = String(raw || "").trim().toLowerCase();
  if (v === "fija") return "Fija";
  if (v === "mÃ³vil" || v === "movil") return "MÃ³vil";
  return "";
};

// SÃ³lo permite exclusiva si tipo === Fija
const normExclusivaFront = (exclusiva, cocheraRaw) =>
  normCocheraFront(cocheraRaw) === "Fija" ? Boolean(exclusiva) : false;

/* ===========================
   Modal simple inline (ConfirmaciÃ³n GENERAL)
=========================== */
const InlineConfirmModal = ({ open, titulo, mensaje, onConfirm, onCancel }) => {
  if (!open) return null;
  const lines = String(mensaje || "")
    .split("\n")
    .map((l) => l.trimEnd());

  return (
    <div className="modal-backdrop" onClick={onCancel}>
      <div
        className="modal-contenedor"
        onClick={(e) => e.stopPropagation()}
        style={{ width: 420, maxWidth: "92%" }}
      >
        <div className="modal-header">
          <h3 style={{ margin: 0 }}>{titulo || "Confirmar"}</h3>
          <button className="modal-cerrar" onClick={onCancel} title="Cerrar">
            Ã—
          </button>
        </div>

        <div className="modal-body">
          <div
            style={{
              display: "flex",
              flexDirection: "column",
              gap: 6,
              whiteSpace: "pre-wrap",
            }}
          >
            {lines.map((line, i) => {
              if (!line.trim()) {
                return <div key={`sep-${i}`} style={{ height: 6, opacity: 0.4 }} />;
              }
              return <div key={i} style={{ lineHeight: 1.25 }}>{line}</div>;
            })}
          </div>

          <div style={{ display: "flex", gap: 8, justifyContent: "center", marginTop: 12 }}>
            <button className="guardarWebcamBtn" onClick={onCancel}>
              Cancelar
            </button>
            <button className="guardarWebcamBtn" onClick={onConfirm}>
              Confirmar
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

function DatosAutoAbono({ datosVehiculo, clienteSeleccionado, user }) {
  const [formData, setFormData] = useState({
    nombreApellido: "",
    dniCuitCuil: "",
    domicilio: "",
    localidad: "",
    telefonoParticular: "",
    telefonoEmergencia: "",
    domicilioTrabajo: "",
    telefonoTrabajo: "",
    email: "",
    patente: datosVehiculo?.patente || "",
    tipoVehiculo: datosVehiculo?.tipoVehiculo || "",
    marca: "",
    modelo: "",
    color: "",
    anio: "",
    companiaSeguro: "",
    metodoPago: "Efectivo",
    factura: "CC",
    fotoSeguro: null,
    fotoDNI: null,
    fotoCedulaVerde: null,
    cochera: "",
    piso: "",
    exclusiva: false
  });

  const [fileUploaded, setFileUploaded] = useState({
    fotoSeguro: false,
    fotoDNI: false,
    fotoCedulaVerde: false,
  });

  const inputRefs = {
    fotoSeguro: useRef(null),
    fotoDNI: useRef(null),
    fotoCedulaVerde: useRef(null),
  };

  const [tiposVehiculo, setTiposVehiculo] = useState([]);

  // ðŸ”¹ Traemos AMBOS catÃ¡logos
  const [preciosEfectivo, setPreciosEfectivo] = useState({});
  const [preciosOtros, setPreciosOtros] = useState({});

  // Compat (algunos helpers esperan 'precios' a secas)
  const [precios, setPrecios] = useState({});

  /* ============================================================
   CARGA CENTRALIZADA DE CATÃLOGOS (TIPOS + PRECIOS EF/OTROS)
   ============================================================
   âš ï¸ ESTE ES EL ÃšNICO ORIGEN DE VERDAD PARA PRECIOS.
   âœ” MISMO HOOK QUE USA DatosPago
   âœ” SIN doble fetch
   âœ” SIN desfasajes
  ============================================================ */

  const {
    tiposVehiculo: tiposVehiculoHook,
    preciosEfectivo: preciosEfectivoHook,
    preciosOtros: preciosOtrosHook,
    lastUpdateToken,
  } = useTarifasData();

  // Sincronizamos el hook con los estados internos que usa este componente
  useEffect(() => {
    setTiposVehiculo(Array.isArray(tiposVehiculoHook) ? tiposVehiculoHook : []);
    setPreciosEfectivo(preciosEfectivoHook || {});
    setPreciosOtros(preciosOtrosHook || {});
    setPrecios(preciosEfectivoHook || {}); // compatibilidad
  }, [tiposVehiculoHook, preciosEfectivoHook, preciosOtrosHook, lastUpdateToken]);

  const [clientes, setClientes] = useState([]);
  const [loading, setLoading] = useState(false);

  // Upgrade flag para la descripciÃ³n del movimiento (derivado del preview del back)
  const [isUpgrade, setIsUpgrade] = useState(false);

  // Guardamos el Ãºltimo preview del back para usar montos exactos
  const [lastPreview, setLastPreview] = useState(null);

  // Modal informativo simple
  const [modal, setModal] = useState({ titulo: "", mensaje: "" });
  const closeModal = () => setModal({ titulo: "", mensaje: "" });
  const showModal = (titulo, mensaje) => setModal({ titulo, mensaje });

  // Modal â€œmÃ¡s caroâ€
  const [confirmModal, setConfirmModal] = useState({
    open: false,
    titulo: "",
    mensaje: "",
    onConfirm: null,
    onCancel: null,
  });

  // Modal confirmaciÃ³n general (abono)
  const [confirmAbono, setConfirmAbono] = useState({
    open: false,
    titulo: "",
    mensaje: "",
    onConfirm: null,
    onCancel: null,
  });

  // ===== Webcam =====
  const [selectedDeviceId, setSelectedDeviceId] = useState(null);
  const [modalCamAbierto, setModalCamAbierto] = useState(false);
  const [videoStream, setVideoStream] = useState(null);
  const [fotoPreview, setFotoPreview] = useState(null);
  const [capturingField, setCapturingField] = useState(null);
  const videoRef = useRef(null);

  useEffect(() => {
    (async () => {
      try {
        const r = await fetch(`${BASE_URL}/api/webcam`);
        if (r.ok) {
          const data = await r.json();
          if (data?.webcam) {
            setSelectedDeviceId(data.webcam);
            localStorage.setItem("webcamDeviceId", data.webcam);
            return;
          }
        }
      } catch (_) {}
      const ls = localStorage.getItem("webcamDeviceId");
      if (ls) setSelectedDeviceId(ls);
    })();
  }, []);

  const humanMediaError = (err) => {
    if (!err) return "Error desconocido de cÃ¡mara";
    if (err.name === "NotAllowedError" || err.name === "SecurityError")
      return "Permiso denegado. HabilitÃ¡ el acceso a la cÃ¡mara para este sitio.";
    if (err.name === "NotFoundError" || err.name === "OverconstrainedError")
      return "No se encontrÃ³ esa cÃ¡mara. ActualizÃ¡ la lista en Config o reconectÃ¡.";
    if (err.name === "NotReadableError")
      return "La cÃ¡mara estÃ¡ en uso por otra app. Cerrala y probÃ¡ de nuevo.";
    return `Fallo de cÃ¡mara: ${err.name || ""} ${err.message || ""}`;
  };

  const getStream = async () => {
    const tryList = [
      selectedDeviceId ? { video: { deviceId: { exact: selectedDeviceId } } } : null,
      { video: { facingMode: { ideal: "environment" } } },
      { video: true },
    ].filter(Boolean);

    let lastErr = null;
    for (const constraints of tryList) {
      try {
        return await navigator.mediaDevices.getUserMedia(constraints);
      } catch (e) {
        lastErr = e;
      }
    }
    throw lastErr || new Error("No se pudo abrir ninguna cÃ¡mara");
  };

  const abrirCamParaCampo = async (campo) => {
    setCapturingField(campo);
    setFotoPreview(null);
    setModalCamAbierto(true);
    try {
      const stream = await getStream();
      setVideoStream(stream);
    } catch (err) {
      setVideoStream(null);
      showModal("Error de cÃ¡mara", humanMediaError(err));
    }
  };

  const tomarFoto = () => {
    if (!videoRef.current) return;
    const canvas = document.createElement("canvas");
    canvas.width = videoRef.current.videoWidth || 1280;
    canvas.height = videoRef.current.videoHeight || 720;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(videoRef.current, 0, 0, canvas.width, canvas.height);
    setFotoPreview(canvas.toDataURL("image/png"));
  };

  const repetirFoto = async () => {
    setFotoPreview(null);
    if (videoStream) {
      videoStream.getTracks().forEach((t) => t.stop());
      setVideoStream(null);
    }
    try {
      const stream = await getStream();
      setVideoStream(stream);
    } catch (err) {
      setVideoStream(null);
      showModal("Error de cÃ¡mara", humanMediaError(err));
    }
  };

  const confirmarFoto = async () => {
    if (!capturingField || !fotoPreview) return;
    const res = await fetch(fotoPreview);
    const blob = await res.blob();
    const patente = (formData.patente || "SINPATENTE").replace(/\s+/g, "");
    const ts = Date.now();
    const filename = `${patente}_${capturingField}_${ts}.png`;
    const file = new File([blob], filename, { type: "image/png" });

    setFormData((prev) => ({ ...prev, [capturingField]: file }));
    setFileUploaded((prev) => ({ ...prev, [capturingField]: true }));
    cerrarModalCam();
  };

  const cerrarModalCam = () => {
    setModalCamAbierto(false);
    setCapturingField(null);
    setFotoPreview(null);
    if (videoStream) {
      try {
        videoStream.getTracks().forEach((t) => t.stop());
      } catch {}
      setVideoStream(null);
    }
  };

  useEffect(() => {
    if (videoRef.current && videoStream) videoRef.current.srcObject = videoStream;
  }, [videoStream]);

  useEffect(() => {
    return () => {
      if (videoStream) {
        try {
          videoStream.getTracks().forEach((t) => t.stop());
        } catch {}
      }
    };
  }, [videoStream]);

  const formatARS = (n) => {
    if (typeof n !== "number" || !isFinite(n)) return "â€”";
    try {
      return new Intl.NumberFormat("es-AR", { maximumFractionDigits: 0 }).format(n);
    } catch {
      return String(n);
    }
  };

  const fetchClientes = async () => {
    try {
      const res = await fetch(`${BASE_URL}/api/clientes`, { cache: "no-store" });
      if (res.ok) {
        const data = await res.json();
        setClientes(Array.isArray(data) ? data : []);
      } else {
        showModal("Error", "No se pudo cargar la lista de clientes.");
      }
    } catch (err) {
      console.error("Error al cargar clientes:", err);
      showModal("Error", "Error al cargar lista de clientes.");
    }
  };

  // si cambia la patente/tipoVehiculo que vienen por prop, los actualizo
  useEffect(() => {
    if (datosVehiculo) {
      setFormData((prev) => ({
        ...prev,
        patente: (datosVehiculo.patente || "").toUpperCase().slice(0, 10),
        tipoVehiculo: datosVehiculo.tipoVehiculo || "",
      }));
    }
  }, [datosVehiculo]);

  // si el usuario elige un cliente a la izquierda (flecha),
  // prellenamos datos + cochera si vino en el payload
  useEffect(() => {
    if (!clienteSeleccionado) return;

    setFormData((prev) => {
      const next = {
        ...prev,
        nombreApellido: clienteSeleccionado?.nombreApellido || prev.nombreApellido,
        dniCuitCuil: clienteSeleccionado?.dniCuitCuil || prev.dniCuitCuil,
        email: clienteSeleccionado?.email || prev.email,
        domicilio: clienteSeleccionado?.domicilio || prev.domicilio,
        localidad: clienteSeleccionado?.localidad || prev.localidad,
        telefonoParticular: clienteSeleccionado?.telefonoParticular || prev.telefonoParticular,
        telefonoEmergencia: clienteSeleccionado?.telefonoEmergencia || prev.telefonoEmergencia,
        domicilioTrabajo: clienteSeleccionado?.domicilioTrabajo || prev.domicilioTrabajo,
        telefonoTrabajo: clienteSeleccionado?.telefonoTrabajo || prev.telefonoTrabajo,
        patente: (clienteSeleccionado?.patente || prev.patente || "")
          .toUpperCase()
          .slice(0, 10),
      };

      // ðŸ‘‡ Datos de cochera traÃ­dos por la flecha (DatosClientesAbonos.handlePickCochera)
      const cocheraFromCliente = clienteSeleccionado?.cochera || "";
      const pisoFromCliente = clienteSeleccionado?.piso || "";
      const exclusivaFromCliente =
        typeof clienteSeleccionado?.exclusiva === "boolean"
          ? clienteSeleccionado.exclusiva
          : prev.exclusiva;

      // Si la flecha trae cochera, la usamos y tambiÃ©n piso/exclusiva
      if (cocheraFromCliente) {
        next.cochera = cocheraFromCliente;
        next.piso = pisoFromCliente;
        next.exclusiva = normExclusivaFront(exclusivaFromCliente, cocheraFromCliente);
      }

      return next;
    });
  }, [clienteSeleccionado]);

  useEffect(() => {
    fetchClientes();
  }, []);

  // ===== Helpers FRONT: abono por mÃ©todo + prorrateo =====

  const getAbonoPrecioByMetodo = (tipoVehiculo, metodoPago, cochera, exclusiva) => {
    const keyVehiculo = String(tipoVehiculo || "").trim().toLowerCase();
    if (!keyVehiculo) return null;

    const mapaBase = metodoPago === "Efectivo" ? preciosEfectivo : preciosOtros;
    if (!mapaBase || typeof mapaBase !== "object") return null;

    const mapa = mapaBase[keyVehiculo];
    if (!mapa || typeof mapa !== "object") return null;

    const candidates = getAbonoTierKeyCandidates(cochera, exclusiva);
    for (const tier of candidates) {
      const val = mapa[tier];
      if (typeof val === "number" && isFinite(val) && val > 0) {
        return val;
      }
    }

    return null;
  };

  const getUltimoDiaMesFront = (hoy = new Date()) => {
    const d = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
    d.setHours(23, 59, 59, 999);
    return d;
  };

  const prorratearMontoFront = (base, hoy = new Date()) => {
    const ultimo = getUltimoDiaMesFront(hoy);
    const total = ultimo.getDate();
    const dia = hoy.getDate();
    const diasRestantes = dia === 1 ? total : (total - dia + 1);
    const factor = diasRestantes / total;
    const proporcional = Math.round(Math.max(0, Number(base) || 0) * factor);
    return { proporcional, diasRestantes, totalDiasMes: total, factor };
  };

  // === Helper global simple ===
  const ucfirst = (s) => {
    const str = String(s || "").trim();
    return str ? str.charAt(0).toUpperCase() + str.slice(1) : "";
  };

  // === Dentro del mes actual (para abonos del cliente)
  const isDentroMesActual = (iso) => {
    if (!iso) return false;
    const d = new Date(iso);
    if (isNaN(d)) return false;
    const now = new Date();
    const inicio = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
    const fin = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
    return d >= inicio && d <= fin;
  };

  // ====== VALIDACIONES ======
  const validarDNI = (dni) => {
    const s = String(dni || "").replace(/\D+/g, "");
    return s.length >= 7 && s.length <= 11;
  };

  // ðŸ” ensureCliente por DNI (crea/actualiza si hace falta) â†’ ahora devuelve { id, isNew }
  const ensureCliente = async () => {
    const dni = (formData.dniCuitCuil || "").trim();
    if (!validarDNI(dni)) throw new Error("DNI/CUIT/CUIL invÃ¡lido");

    const encontrado = (clientes || []).find(
      (c) => String(c.dniCuitCuil || "").trim() === dni
    );

    const payloadBase = {
      nombreApellido: formData.nombreApellido,
      dniCuitCuil: formData.dniCuitCuil,
      domicilio: formData.domicilio,
      localidad: formData.localidad,
      telefonoParticular: formData.telefonoParticular,
      telefonoEmergencia: formData.telefonoEmergencia,
      domicilioTrabajo: formData.domicilioTrabajo,
      telefonoTrabajo: formData.telefonoTrabajo,
      email: formData.email
      // âŒ sin cochera, sin exclusiva, sin piso
    };

    if (encontrado && encontrado._id) {
      try {
        await fetch(`${BASE_URL}/api/clientes/${encontrado._id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payloadBase),
        }).catch(() => {});
      } catch {}
      return { id: encontrado._id, isNew: false };
    }

    // Crear nuevo cliente
    const nuevoClienteRes = await fetch(`${BASE_URL}/api/clientes`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        ...payloadBase,
        // retrocompat: usÃ¡s tipoVehiculo como "precioAbono" viejo
        precioAbono: formData.tipoVehiculo || "",
      }),
    });

    if (!nuevoClienteRes.ok) {
      const err = await nuevoClienteRes.json().catch(() => ({}));
      throw new Error(err?.message || "Error al crear cliente");
    }
    const nuevoCliente = await nuevoClienteRes.json();
    if (!nuevoCliente._id) throw new Error("No se pudo crear cliente");
    return { id: nuevoCliente._id, isNew: true };
  };

  // === Nuevo: pedir preview al back para decidir si es "Aumento de precio" o "Alta abono"
  const fetchPreviewAbono = async () => {
    const params = new URLSearchParams();
    const dni = (formData.dniCuitCuil || "").trim();
    const cocheraNorm = normCocheraFront(formData.cochera);
    const exclusivaNorm = normExclusivaFront(formData.exclusiva, formData.cochera);

    if (validarDNI(dni)) params.set("dniCuitCuil", dni);
    if (formData.tipoVehiculo) params.set("tipoVehiculo", formData.tipoVehiculo);

    params.set("metodoPago", formData.metodoPago || "Efectivo");
    // Siempre mandamos cochera normalizada
    params.set("cochera", cocheraNorm || "MÃ³vil");
    params.set("exclusiva", exclusivaNorm ? "true" : "false");
    params.set("mesesAbonar", "1");

    const url = `${BASE_URL}/api/abonos/preview?${params.toString()}`;
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) {
      const err = await r.json().catch(() => ({}));
      throw new Error(err?.error || "No se pudo obtener el preview de abono");
    }
    const data = await r.json();
    return data; // incluye: baseActual, baseNuevo, diffBase, proporcionalMesActual, diasRestantes, totalDiasMes, ...
  };

  // === CÃ¡lculo LOCAL del â€œmÃ¡s caroâ€ (usado sÃ³lo como fallback si falla el preview del back)
  const calcularUpgradeLocal = (clienteExistente) => {
    const metodoNuevo = formData.metodoPago;
    const tipoNorm = normCocheraFront(formData.cochera || "MÃ³vil"); // 'Fija' | 'MÃ³vil'
    const pisoNorm = String(formData.piso || "").trim().toLowerCase();
    const exclNueva = tipoNorm === "Fija" ? !!formData.exclusiva : false;

    const baseNuevo =
      getAbonoPrecioByMetodo(
        formData.tipoVehiculo,
        metodoNuevo,
        tipoNorm,
        exclNueva
      ) || 0;

    let baseActual = 0;

    if (clienteExistente?.abonos?.length) {
      for (const a of clienteExistente.abonos) {
        if (!a?.activo) continue;
        if (!isDentroMesActual(a?.fechaExpiracion)) continue;

        // ðŸ”¥ FILTRO CRÃTICO: MISMA COCHERA + MISMO PISO
        const tipoAbo = normCocheraFront(a.cochera);
        const pisoAbo = String(a.piso || "").trim().toLowerCase();
        if (tipoAbo !== tipoNorm) continue;
        if (pisoAbo !== pisoNorm) continue;

        const metodoAbo = a.metodoPago || metodoNuevo;
        const exclAbo = tipoAbo === "Fija" ? !!a.exclusiva : false;

        const baseAbo = getAbonoPrecioByMetodo(
          a.tipoVehiculo,
          metodoAbo,
          tipoAbo,
          exclAbo
        );

        if (Number.isFinite(baseAbo) && baseAbo > baseActual) {
          baseActual = baseAbo;
        }
      }
    }

    const diffBase = Math.max(0, baseNuevo - baseActual);
    const { proporcional, diasRestantes, totalDiasMes } =
      prorratearMontoFront(diffBase);

    return {
      baseActual,
      baseNuevo,
      diffBase,
      montoHoy: proporcional,
      diasRestantes,
      totalDiasMes,
    };
  };

  /* ===========================================================
     ðŸ”— SincronizaciÃ³n VehÃ­culo â†” Cochera (Front)
     Reglas:
     - Si el cliente tiene cocheras[] (nuevo modelo):
         â€¢ Selecciona por coincidencia exacta de piso con formData.piso (cuando haya).
         â€¢ Si no hay match, usa la primera cochera.
       POST /api/clientes/asignarVehiculoACochera { clienteId, cocheraId, vehiculoId }
     - Si NO tiene cocheras[] (modelo histÃ³rico):
       POST /api/clientes/asignarVehiculoACochera { clienteId, cocheraId:null, vehiculoId, cochera:{tipo,exclusiva,piso} }
     - Silencioso: no rompe el flujo si falla.
  =========================================================== */
  const asignarVehiculoACocheraFront = async (clienteObj, vehiculoId) => {
    try {
      if (!clienteObj || !clienteObj._id || !vehiculoId) return;

      const clienteId = clienteObj._id;
      const cliente = clienteObj; // ahora usamos el cliente pasado, no el array viejo
      const token = localStorage.getItem("token");
      const authHeaders = token ? { Authorization: `Bearer ${token}` } : {};

      // 1) Nuevo modelo: array cocheras
      if (cliente && Array.isArray(cliente.cocheras) && cliente.cocheras.length > 0) {
        let cocheraDestino = null;

        if (formData.piso) {
          cocheraDestino = cliente.cocheras.find(
            (k) =>
              String(k?.piso || "").trim().toLowerCase() === String(formData.piso).trim().toLowerCase()
          ) || null;
        }
        if (!cocheraDestino) cocheraDestino = cliente.cocheras[0];

        // ðŸ©¹ FIX: usar cocheraId (ID real de la cochera) o _id como fallback
        if (cocheraDestino) {
          const cocheraIdPayload = cocheraDestino.cocheraId || cocheraDestino._id || null;
          if (cocheraIdPayload) {
            await fetch(`${BASE_URL}/api/clientes/asignarVehiculoACochera`, {
              method: "POST",
              headers: { "Content-Type": "application/json", ...authHeaders },
              body: JSON.stringify({
                clienteId,
                cocheraId: cocheraIdPayload,
                vehiculoId,
              }),
            }).catch(() => {});
            return;
          }
        }
      }

      // 2) Modelo histÃ³rico: snapshot desde formData
      const cocheraSimple = {
        tipo: normCocheraFront(formData.cochera) || "",
        exclusiva: normExclusivaFront(formData.exclusiva, formData.cochera),
        piso: String(formData.piso || "").trim(),
      };

      await fetch(`${BASE_URL}/api/clientes/asignarVehiculoACochera`, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeaders },
        body: JSON.stringify({
          clienteId,
          cocheraId: null,
          vehiculoId,
          cochera: cocheraSimple,
        }),
      }).catch(() => {});
    } catch (err) {
      console.warn("âš ï¸ asignarVehiculoACocheraFront:", err?.message || err);
    }
  };

  // ====== Flujo de guardado con dos confirmaciones ======
  const finalizarSubmit = async (previewOverride = null, decision = null) => {
    try {
      const patente = (formData.patente || "").toUpperCase();

      // âš ï¸ ahora necesito saber si el cliente es nuevo o existente
      const clienteInfo = await ensureCliente(); // { id, isNew }
      const clienteId = clienteInfo.id;
      const clienteEsNuevo = decision?.isNew ?? clienteInfo.isNew;

      // precio base del NUEVO abono (para etiquetas / info)
      const tierName = getTierName(formData.cochera || "MÃ³vil", formData.exclusiva);
      const baseMensual = getAbonoPrecioByMetodo(
        formData.tipoVehiculo,
        formData.metodoPago,
        formData.cochera || "MÃ³vil",
        formData.cochera === "Fija" ? formData.exclusiva : false
      );

      if (!Number.isFinite(baseMensual)) {
        throw new Error(
          `No hay precio cargado para "${(formData.tipoVehiculo || "").toLowerCase()}" en tier "${tierName}" (${formData.metodoPago}).`
        );
      }

      // DecisiÃ³n final de "upgrade" (aumento)
      const esUpgradeDecision =
        !!decision?.upgrade ||
        (
          previewOverride &&
          Number(previewOverride.baseNuevo) > Number(previewOverride.baseActual)
        );

      // DeclaraciÃ³n correcta de nueva cochera (antes de usarla)
      const esNuevaCocheraDecision = !!(decision && decision.nuevaCochera);

      // Id de cochera resuelto en el front (si existe)
      const cocheraIdForBack = decision?.cocheraId || null;

      let proporcionalHoy = 0;
      let diasRestantes = 0;
      let totalDiasMes = 0;

      // ðŸŸ© Caso 1 â€” Cliente NUEVO
      if (clienteEsNuevo) {
        const pr = prorratearMontoFront(baseMensual);
        proporcionalHoy = pr.proporcional;
        diasRestantes = pr.diasRestantes;
        totalDiasMes = pr.totalDiasMes;
      }

      // ðŸŸ© Caso 2 â€” Upgrade (mÃ¡s caro)
      else if (esUpgradeDecision) {
        if (previewOverride && Number.isFinite(previewOverride.proporcionalMesActual)) {
          proporcionalHoy = Number(previewOverride.proporcionalMesActual);
          diasRestantes = Number(previewOverride.diasRestantes);
          totalDiasMes = Number(previewOverride.totalDiasMes);
        } else {
          const diff = Math.max(
            0,
            (previewOverride?.baseNuevo || baseMensual) -
              (previewOverride?.baseActual || 0)
          );
          const pr = prorratearMontoFront(diff);
          proporcionalHoy = pr.proporcional;
          diasRestantes = pr.diasRestantes;
          totalDiasMes = pr.totalDiasMes;
        }
      }

      // ðŸŸ© Caso 3 â€” Nueva cochera (cliente existente)
      else if (esNuevaCocheraDecision) {
        const pr = prorratearMontoFront(baseMensual);
        proporcionalHoy = pr.proporcional;
        diasRestantes = pr.diasRestantes;
        totalDiasMes = pr.totalDiasMes;
      }

      // ðŸŸ© Caso 4 â€” No se cobra nada
      else {
        const pr = prorratearMontoFront(0);
        proporcionalHoy = 0;
        diasRestantes = pr.diasRestantes;
        totalDiasMes = pr.totalDiasMes;
      }

      // Para el back (info referencial â€” no rompe si no la usa)
      const fd = new FormData();
      Object.entries(formData).forEach(([k, v]) => {
        if (v !== null && v !== undefined) fd.append(k, v);
      });
      fd.set("patente", patente);
      fd.set("cliente", clienteId);
      fd.set("operador", user?.nombre || "Sistema");
      fd.set("exclusiva", formData.exclusiva ? "true" : "false");

      // ðŸŸ¢ Si ya tenemos una cochera real resuelta, se la avisamos al back
      if (cocheraIdForBack) {
        fd.set("cocheraId", String(cocheraIdForBack));
      }

      fd.set("precio", String(baseMensual)); // precio de catÃ¡logo
      fd.set("precioProrrateadoHoy", String(proporcionalHoy));
      fd.set("tierAbono", getTierName(formData.cochera || "MÃ³vil", formData.exclusiva));

      // 1) Registrar Abono SIEMPRE
      const token = localStorage.getItem("token");
      const authHeaders = token ? { Authorization: `Bearer ${token}` } : {};
      const resp = await fetch(`${BASE_URL}/api/abonos/registrar-abono`, {
        method: "POST",
        headers: authHeaders,
        body: fd,
      });
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        throw new Error(err?.error || err?.message || "Error al registrar abono.");
      }

      const debeCobrar =
        clienteEsNuevo ||
        esUpgradeDecision ||
        esNuevaCocheraDecision;

      // 2) (condicional) Crear Ticket en DB (tipo ABONO) sÃ³lo si se cobra algo
      let ticketNumber = null;
      if (debeCobrar && proporcionalHoy > 0) {
        try {
          const payloadTicketAbono = {
            tipo: "abono",
            patente,
            cliente: clienteId,
            operador: user?.username || user?.nombre || "Sistema",
            metodoPago: formData.metodoPago,
            factura: formData.factura,
            tierAbono: getTierName(formData.cochera || "MÃ³vil", formData.exclusiva),
            baseMensual: baseMensual,
            montoProporcional: proporcionalHoy, // si es upgrade: diff prorrateado
            tipoVehiculo: formData.tipoVehiculo,
            fecha: new Date().toISOString(),
          };
          const ticketRes = await fetch(`${BASE_URL}/api/tickets`, {
            method: "POST",
            headers: { "Content-Type": "application/json", ...(token ? { Authorization: `Bearer ${token}` } : {}) },
            body: JSON.stringify(payloadTicketAbono),
          });
          const tj = await ticketRes.json().catch(() => null);
          ticketNumber = tj?.ticket ?? tj?.data?.ticket ?? tj?.result?.ticket ?? tj?._id ?? null;
        } catch (e) {
          console.warn("âš ï¸ No se pudo crear/leer el ticket ABONO en DB:", e);
        }
      }

      // 3) (condicional) Imprimir ticket sÃ³lo si se cobra algo
      if (debeCobrar && proporcionalHoy > 0) {
        try {
          await fetch(`${BASE_URL}/api/tickets/imprimir-abono`, {
            method: "POST",
            headers: { "Content-Type": "application/json", ...(token ? { Authorization: `Bearer ${token}` } : {}) },
            body: JSON.stringify({
              proporcional: `${formatARS(proporcionalHoy)}`,
              valorMensual: `${formatARS(baseMensual)}`,
              baseMensual,
              proporcionalRaw: proporcionalHoy,
              nombreApellido: formData.nombreApellido,
              metodoPago: formData.metodoPago,
              tipoVehiculo: formData.tipoVehiculo,
              marca: formData.marca,
              modelo: formData.modelo,
              patente,
              cochera: formData.cochera,
              piso: formData.piso,
              exclusiva: !!formData.exclusiva,
              diasRestantes,
            }),
          }).catch(() => {});
        } catch (e) {
          console.warn("âš ï¸ ImpresiÃ³n:", e);
        }
      }

      // 4) (condicional) Registrar movimiento
      if (debeCobrar && proporcionalHoy > 0) {
        let descripcion = "";
        if (clienteEsNuevo) descripcion = "Alta abono";
        else if (esNuevaCocheraDecision) descripcion = "Nueva Cochera";
        else if (esUpgradeDecision) descripcion = "Aumento de Precio";
        else descripcion = "Abono mensual";
        try {
          const movBody = {
            patente,
            tipoVehiculo: formData.tipoVehiculo,
            metodoPago: formData.metodoPago,
            factura: formData.factura,
            monto: proporcionalHoy, // si es upgrade: diff prorrateado; si es nuevo: prorrateo base
            descripcion,
            tipoTarifa: "abono",
            cliente: clienteId,
            operador: user || null,
            ...(ticketNumber ? { ticket: ticketNumber } : {}),
          };
          await fetch(`${BASE_URL}/api/movimientos/registrar`, {
            method: "POST",
            headers: { "Content-Type": "application/json", ...(token ? { Authorization: `Bearer ${token}` } : {}) },
            body: JSON.stringify(movBody),
          }).catch(() => {});
        } catch (e) {
          console.warn("âš ï¸ movimiento:", e);
        }
      }

      // 5) ðŸ”— Vincular VehÃ­culo â†” Cochera (robusto y silencioso)
      try {
        // Primero intento obtener el vehiculoId por endpoint directo
        let vehiculoId = null;
        try {
          const r = await fetch(`${BASE_URL}/api/vehiculos/patente/${encodeURIComponent(patente)}`, { cache: "no-store" });
          if (r.ok) {
            const v = await r.json().catch(() => null);
            if (v && (v._id || v?.data?._id)) vehiculoId = v._id || v?.data?._id;
          }
        } catch {}

        // Fallback: por si el endpoint devuelve array
        if (!vehiculoId) {
          try {
            const r2 = await fetch(`${BASE_URL}/api/vehiculos?patente=${encodeURIComponent(patente)}`, { cache: "no-store" });
            if (r2.ok) {
              const arr = await r2.json().catch(() => null);
              if (Array.isArray(arr) && arr.length) vehiculoId = arr[0]?._id || null;
            }
          } catch {}
        }

        if (vehiculoId) {
          let clienteFresh = null;
          try {
            const r = await fetch(`${BASE_URL}/api/clientes/${clienteId}`);
            if (r.ok) clienteFresh = await r.json();
          } catch {}

          // ðŸ”¥ Pasamos el clienteFresh a la funciÃ³n de asignaciÃ³n
          await asignarVehiculoACocheraFront(clienteFresh || clienteSeleccionado, vehiculoId);
        }
      } catch (errLink) {
        console.warn("âš ï¸ VinculaciÃ³n vehÃ­culoâ†”cochera:", errLink?.message || errLink);
      }

      await fetchClientes();
      fetch(`${BASE_URL}/api/sync/run-now`, { method: "POST" }).catch(() => {});

      let msgOk = "";
      if (clienteEsNuevo) {
        msgOk = `Abono registrado y cobrado para ${patente} (cliente nuevo). Sincronizado con cochera.`;
      } else if (esUpgradeDecision) {
        msgOk = `Abono agregado y diferencia cobrada para ${patente} (aumento de precio). Sincronizado con cochera.`;
      } else if (esNuevaCocheraDecision) {
        msgOk = `Abono registrado y cobrado para ${patente} (nueva cochera). Sincronizado con cochera.`;
      } else {
        msgOk = `Abono agregado para ${patente} (sin cargos). Sincronizado con cochera.`;
      }

      showModal("Ã‰xito", msgOk);

      // Reset UI
      setFormData({
        nombreApellido: "",
        dniCuitCuil: "",
        domicilio: "",
        localidad: "",
        telefonoParticular: "",
        telefonoEmergencia: "",
        domicilioTrabajo: "",
        telefonoTrabajo: "",
        email: "",
        patente: datosVehiculo?.patente || "",
        tipoVehiculo: datosVehiculo?.tipoVehiculo || "",
        marca: "",
        modelo: "",
        color: "",
        anio: "",
        companiaSeguro: "",
        metodoPago: "Efectivo",
        factura: "CC",
        fotoSeguro: null,
        fotoDNI: null,
        fotoCedulaVerde: null,
        cochera: "",
        piso: "",
        exclusiva: false,
      });
      setFileUploaded({
        fotoSeguro: false,
        fotoDNI: false,
        fotoCedulaVerde: false,
      });
      setIsUpgrade(false);
      setLastPreview(null);
    } catch (error) {
      console.error(error);
      showModal("Error", error?.message || "OcurriÃ³ un error al guardar el abono.");
    }
  };

  const continuarFlujoDespuesDeConfirmacion = async () => {
    setConfirmAbono((s) => ({ ...s, open: false }));
    setLoading(true);
    try {
      // Â¿El DNI corresponde a un cliente existente?
      const dni = (formData.dniCuitCuil || "").trim();
      const clienteExistente = (clientes || []).find(
        (c) => String(c.dniCuitCuil || "").trim() === dni
      );
      const esClienteNuevo = !clienteExistente;
      // =======================================================
      // ðŸ”¥ REGLA DURA: COCHERA MÃ“VIL = SIEMPRE NUEVA COCHERA
      // =======================================================
      const tipoCocheraNorm =
        String(formData.cochera || '').toLowerCase() === 'fija'
          ? 'Fija'
          : 'MÃ³vil';

      // Si el cliente YA existe y la cochera es MÃ“VIL â†’ forzar nueva cochera
      if (!esClienteNuevo && tipoCocheraNorm === 'MÃ³vil') {
        const baseMensual = getAbonoPrecioByMetodo(
          formData.tipoVehiculo,
          formData.metodoPago,
          'MÃ³vil',
          false
        );

        const pr = prorratearMontoFront(baseMensual || 0);

        setConfirmModal({
          open: true,
          titulo: 'Nueva cochera mÃ³vil',
          mensaje: [
            'EstÃ¡s creando una NUEVA cochera MÃ“VIL.',
            'Regla del sistema: una cochera mÃ³vil no puede tener mÃ¡s de un vehÃ­culo.',
            '',
            `Precio mensual: $${formatARS(baseMensual)}`,
            `A cobrar hoy: $${formatARS(pr.proporcional)} (${pr.diasRestantes}/${pr.totalDiasMes})`,
            '',
            'Â¿DeseÃ¡s continuar?'
          ].join('\n'),
          onConfirm: async () => {
            setConfirmModal(s => ({ ...s, open: false }));
            setLoading(true);

            await finalizarSubmit(null, {
              isNew: false,
              upgrade: false,
              nuevaCochera: true,
              cocheraId: null // ðŸ”¥ CLAVE: NO reutilizar cochera
            });

            setLoading(false);
          },
          onCancel: () => {
            setConfirmModal(s => ({ ...s, open: false }));
            setLoading(false);
          }
        });

        return; // â›” cortar flujo normal
      }
      // === Detectar si esta cochera es nueva para este cliente existente
      //     y resolver el ID REAL de cochera ===
      let esNuevaCochera = false;
      let cocheraRealId = null;

      if (!esClienteNuevo && clienteExistente && Array.isArray(clienteExistente.cocheras)) {
        const tipoNorm = normCocheraFront(formData.cochera);
        const pisoNorm = String(formData.piso || "").trim();

        // ðŸ’¥ SoluciÃ³n: comparar contra cocheraId REAL
        if (clienteExistente.cocheras.length > 0) {
          // Busco la cochera REAL del sistema por tipo+piso
          let cocheraReal = null;

          try {
            const r = await fetch(`${BASE_URL}/api/cocheras`);
            const cocherasSistema = await r.json();

            cocheraReal = cocherasSistema.find((c) => {
              return (
                normCocheraFront(c.tipo) === tipoNorm &&
                String(c.piso || "").trim() === pisoNorm
              );
            });
          } catch (err) {
            console.warn("âš ï¸ No se pudo cargar catÃ¡logo de cocheras", err);
          }

          if (cocheraReal) {
            cocheraRealId = cocheraReal._id;

            const yaLaTiene = clienteExistente.cocheras.some(
              (c) => String(c.cocheraId || c._id) === String(cocheraRealId)
            );

            esNuevaCochera = !yaLaTiene;
          } else {
            // fallback defensivo: si no encontramos la cochera en el catÃ¡logo, asumimos que es nueva
            esNuevaCochera = true;
            cocheraRealId = null;
          }
        }
      }

      // 1) Intentamos preview del back (mÃ¡s preciso)
      let preview = null;
      try {
        preview = await fetchPreviewAbono();
      } catch (e) {
        console.warn("âš ï¸ preview back fallÃ³, uso cÃ¡lculo local si puedo:", e?.message || e);
      }

      // Regla: JAMÃS mostrar modal de aumento si estoy creando cliente nuevo
      const upgradePorBack = !esClienteNuevo &&
        preview &&
        Number(preview.baseActual) > 0 &&
        Number(preview.diffBase) > 0;

      if (upgradePorBack) {
        const vehiculoPretty = (() => {
          const s = String(formData.tipoVehiculo || "").trim();
          return s ? s.charAt(0).toUpperCase() + s.slice(1) : "";
        })();

        setConfirmModal({
          open: true,
          titulo: "VehÃ­culo mÃ¡s caro",
          mensaje:
            [
              `EstÃ¡s pasando a "${vehiculoPretty}".`,
              ``,
              `Base actual: $${formatARS(previewLike.baseActual)}` +
                (clienteExistente?.abonos?.length
                  ? ` (VehÃ­culo anterior: ${ucfirst(clienteExistente.abonos.find(a => a.activo)?.tipoVehiculo || "-" )})`
                  : ""),
              `Base nueva: $${formatARS(previewLike.baseNuevo)}`,
              `Diferencia mensual: $${formatARS(previewLike.diffBase)}`,
              ``,
              `A cobrar HOY: $${formatARS(previewLike.proporcionalMesActual)} (${previewLike.diasRestantes}/${previewLike.totalDiasMes})`,
              ``,
              `Â¿DeseÃ¡s continuar?`
            ].join("\n"),
          onConfirm: async () => {
            setConfirmModal((s) => ({ ...s, open: false }));
            setLoading(true);
            await finalizarSubmit(preview, {
              isNew: esClienteNuevo,
              upgrade: true,
              nuevaCochera: false,
              cocheraId: cocheraRealId,
            });
            setLoading(false);
          },
          onCancel: () => {
            setConfirmModal((s) => ({ ...s, open: false }));
            setIsUpgrade(false);
            setLastPreview(null);
            setLoading(false);
          },
        });
        return;
      }

      // 2) Si el back no pudo o no marcÃ³ upgrade, intentamos heurÃ­stica local (sÃ³lo si NO es cliente nuevo)
      if (!esClienteNuevo) {
        const { baseActual, baseNuevo, diffBase, montoHoy, diasRestantes, totalDiasMes } =
          calcularUpgradeLocal(clienteExistente);

        if (baseActual > 0 && diffBase > 0) {
          setIsUpgrade(true);
          const vehiculoPretty = (() => {
            const s = String(formData.tipoVehiculo || "").trim();
            return s ? s.charAt(0).toUpperCase() + s.slice(1) : "";
          })();
          const previewLike = {
            baseActual,
            baseNuevo,
            diffBase,
            proporcionalMesActual: montoHoy,
            diasRestantes,
            totalDiasMes
          };

          setConfirmModal({
            open: true,
            titulo: "VehÃ­culo mÃ¡s caro",
            mensaje:
              [
                `EstÃ¡s pasando a "${vehiculoPretty}".`,
                ``,
                `Base actual: $${formatARS(previewLike.baseActual)}` +
                  (clienteExistente?.abonos?.length
                    ? ` (VehÃ­culo anterior: ${ucfirst(clienteExistente.abonos.find(a => a.activo)?.tipoVehiculo || "-" )})`
                    : ""),
                `Base nueva: $${formatARS(previewLike.baseNuevo)}`,
                `Diferencia mensual: $${formatARS(previewLike.diffBase)}`,
                ``,
                `A cobrar HOY: $${formatARS(previewLike.proporcionalMesActual)} (${previewLike.diasRestantes}/${previewLike.totalDiasMes})`,
                ``,
                `Â¿DeseÃ¡s continuar?`
              ].join("\n"),
            onConfirm: async () => {
              setConfirmModal((s) => ({ ...s, open: false }));
              setLoading(true);
              await finalizarSubmit(preview, {
                isNew: esClienteNuevo,
                upgrade: true,
                nuevaCochera: false,
                cocheraId: cocheraRealId,
              });
              setLoading(false);
            },
            onCancel: () => {
              setConfirmModal((s) => ({ ...s, open: false }));
              setIsUpgrade(false);
              setLastPreview(null);
              setLoading(false);
            },
          });
          return;
        }
      }

      // === Si no es upgrade, verificar si es NUEVA COCHERA ===
      if (!esClienteNuevo && esNuevaCochera) {
        // calculo local (fallback si preview fue null)
        const baseMensualNC = getAbonoPrecioByMetodo(
          formData.tipoVehiculo,
          formData.metodoPago,
          formData.cochera || "MÃ³vil",
          formData.cochera === "Fija" ? formData.exclusiva : false
        );

        const prNC = prorratearMontoFront(baseMensualNC);

        setConfirmModal({
          open: true,
          titulo: "Nueva Cochera",
          mensaje:
            [
              `EstÃ¡s agregando una NUEVA COCHERA para este cliente.`,
              ``,
              `Cochera: ${formData.cochera}`,
              `NÃºmero: ${formData.piso || "-"}`,
              `Exclusiva: ${formData.exclusiva ? "SÃ­" : "No"}`,
              ``,
              `Precio mensual: $${formatARS(baseMensualNC)}`,
              `A cobrar HOY: $${formatARS(prNC.proporcional)} (${prNC.diasRestantes}/${prNC.totalDiasMes})`,
              ``,
              `Â¿DeseÃ¡s continuar?`
            ].join("\n"),
          onConfirm: async () => {
            setConfirmModal((s) => ({ ...s, open: false }));
            await finalizarSubmit(preview || null, {
              isNew: esClienteNuevo,
              upgrade: false,
              nuevaCochera: true,
              cocheraId: cocheraRealId,
            });
          },
          onCancel: () => setConfirmModal((s) => ({ ...s, open: false }))
        });

        setLoading(false);
        return;
      }

      // 3) Alta normal (sin upgrade, sin nueva cochera)
      setIsUpgrade(false);
      setLastPreview(null);
      await finalizarSubmit(preview || null, {
        isNew: esClienteNuevo,
        upgrade: false,
        nuevaCochera: false,
        cocheraId: cocheraRealId,
      });
    } catch (error) {
      console.error(error);
      showModal("Error", error?.message || "OcurriÃ³ un error al guardar el abono.");
    } finally {
      setLoading(false);
    }
  };

  // === FUNCIÃ“N AUXILIAR NUEVA (debe ir arriba del handleSubmit) ===
  const abrirConfirmacionDeAbono = () => {
    const patente = (formData.patente || "").toUpperCase();
    const tipo = formData.tipoVehiculo;
    const metodo = formData.metodoPago;
    const factura = formData.factura;

    const tierName = getTierName(formData.cochera || "MÃ³vil", formData.exclusiva);
    const baseMensual = getAbonoPrecioByMetodo(
      tipo,
      metodo,
      formData.cochera || "MÃ³vil",
      formData.cochera === "Fija" ? formData.exclusiva : false
    );

    if (!Number.isFinite(baseMensual)) {
      return showModal(
        "Error",
        `No hay precio cargado para "${(tipo || "").toLowerCase()}" en tier "${tierName}" (${metodo}). `
      );
    }

    const { proporcional, diasRestantes, totalDiasMes } = prorratearMontoFront(baseMensual);

    const detalleCochera = [
      `Cochera: ${formData.cochera || "-"}`,
      `NÂ° de Cochera: ${formData.piso || "-"}`,
      `Exclusiva: ${formData.exclusiva ? "SÃ­" : "No"}`,
    ].join("\n");

    const ucfirst = (s) => {
      const str = String(s || "").trim();
      return str ? str.charAt(0).toLocaleUpperCase("es-AR") + str.slice(1) : "";
    };

    const tierPretty = ucfirst(tierName);
    const metodoCatalogo = ucfirst(metodo === "Efectivo" ? "efectivo" : "otros");

    const msg =
      `Vas a hacer un Abono\n` +
      `\n` +
      `Patente: ${patente}\n` +
      `Tipo: ${tipo}\n` +
      `MÃ©todo de pago: ${metodo}\n` +
      `Factura: ${factura}\n` +
      `\n` +
      `[${tierPretty}] (Precio Completo: ${metodoCatalogo}): $${formatARS(baseMensual)}\n` +
      `A cobrar HOY (${diasRestantes}/${totalDiasMes}): $${formatARS(proporcional)}\n` +
      `\n` +
      `${detalleCochera}`;

    setConfirmAbono({
      open: true,
      titulo: "Confirmar alta de Abono",
      mensaje: msg,
      onConfirm: continuarFlujoDespuesDeConfirmacion,
      onCancel: () => setConfirmAbono((s) => ({ ...s, open: false })),
    });
  };



  /* ========================================================================
    HANDLE SUBMIT COMPLETO CON modal DNI existente
  ========================================================================= */

  const handleSubmit = async (e) => {
    e.preventDefault();

    // 1) Validaciones locales rÃ¡pidas
    try {
      const patente = (formData.patente || "").trim();
      if (!patente) throw new Error("Debe ingresar la patente.");
      if (!formData.tipoVehiculo) throw new Error("Debe seleccionar el tipo de vehÃ­culo.");
      if (!formData.nombreApellido?.trim())
        throw new Error("Debe ingresar el nombre y apellido del cliente.");
      if (!validarDNI(formData.dniCuitCuil))
        throw new Error("DNI/CUIT/CUIL invÃ¡lido.");
      if (!formData.email?.trim()) throw new Error("Debe ingresar un email.");
      if (!formData.cochera && !clienteSeleccionado?.cocheras?.length)
        throw new Error("Debe seleccionar Cochera (Fija o MÃ³vil).");
    } catch (err) {
      return showModal("Error", err.message);
    }

    // 2) Nuevo: detectar si el DNI ya existe, mostrar modal antes de seguir
    try {
      const dni = (formData.dniCuitCuil || "").trim();
      const clienteExistente = (clientes || []).find(
        (c) => String(c.dniCuitCuil || "").trim() === dni
      );

      if (clienteExistente) {
        setConfirmAbono({
          open: true,
          titulo: "DNI ya existente",
          mensaje:
            `El DNI ${dni} ya estÃ¡ registrado a nombre de:\n\n` +
            `${clienteExistente.nombreApellido}\n\n` +
            `Â¿DeseÃ¡s continuar y actualizar su informaciÃ³n / agregar vehÃ­culo?`,
          onConfirm: () => {
            setConfirmAbono((s) => ({ ...s, open: false }));
            abrirConfirmacionDeAbono(); // << despuÃ©s sigue al modal de abono original
          },
          onCancel: () => setConfirmAbono((s) => ({ ...s, open: false })),
        });
        return; // esperamos confirmaciÃ³n
      }
    } catch (err) {
      return showModal("Error", err?.message || "No se pudo verificar el DNI.");
    }

    // 3) Si NO existe, abrimos directamente el modal de confirmaciÃ³n del abono
    try {
      abrirConfirmacionDeAbono();
    } catch (err) {
      return showModal("Error", err?.message || "No se pudo preparar la confirmaciÃ³n.");
    }
  };

  const handleChange = async (e) => {
    const { name, value, files, type, checked } = e.target;

    if (name === "cochera") {
      setFormData((prev) => {
        const next = { ...prev, cochera: value };
        if (normCocheraFront(value) !== "Fija") {
          next.exclusiva = false;
        }
        return next;
      });
      return;
    }
    if (name === "exclusiva" && type === "checkbox") {
      if (normCocheraFront(formData.cochera) === "Fija") {
        setFormData((prev) => ({ ...prev, exclusiva: Boolean(checked) }));
      }
      return;
    }

    if (name === "patente") {
      setFormData((prev) => ({ ...prev, patente: (value || "").toUpperCase().slice(0, 10) }));
      return;
    }
    if (files && files.length > 0) {
      setFormData((prev) => ({ ...prev, [name]: files[0] }));
      setFileUploaded((prev) => ({ ...prev, [name]: true }));
      return;
    }

    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  // ===== Render helpers =====

  const renderFileInput = (label, name) => (
    <div className="file-input-wrapper">
      <label className="file-visible-label">{label}</label>
      <label
        className="file-label"
        onClick={(e) => {
          e.preventDefault();
          abrirCamParaCampo(name);
        }}
      >
        <div className="icon-wrapper">
          <FaCamera className="icon" />
        </div>
        {fileUploaded[name] ? (
          <div className="file-uploaded">
            <FaCheckCircle size={20} />
          </div>
        ) : (
          <div className="file-text">
            <span>Sacar</span>
            <span>Foto</span>
          </div>
        )}
        <input
          ref={inputRefs[name]}
          type="file"
          name={name}
          accept="image/*"
          onChange={handleChange}
          style={{ display: "none" }}
        />
      </label>
    </div>
  );

  // ====== UI state derived ======
  const isCocheraFija = normCocheraFront(formData.cochera) === "Fija";

  return (
    <div className="abono-container">
      <form className="abono-form" onSubmit={handleSubmit} encType="multipart/form-data">
        {/* ===== FILA DE COCHERA / PISO / EXCLUSIVA ===== */}
        <div className="cochera-row">
          <div className="fullwidth">
            <label>Cochera</label>
            <select
              name="cochera"
              value={formData.cochera}
              onChange={handleChange}
              className="select-style-wide"
              required
            >
              <option value="">Seleccione</option>
              <option value="Fija">Cochera Fija</option>
              <option value="MÃ³vil">Cochera MÃ³vil</option>
            </select>
          </div>

          <div className="fullwidth">
            <label>NÂ° de Cochera</label>
            <input
              type="text"
              name="piso"
              value={formData.piso}
              onChange={handleChange}
              className="input-style-wide"
              disabled={!isCocheraFija}
              style={{
                opacity: !isCocheraFija ? 0.55 : 1,
                cursor: !isCocheraFija ? "not-allowed" : "text",
                backgroundColor: !isCocheraFija ? "#191a22" : undefined,
                borderColor: !isCocheraFija ? "#3b4050" : undefined,
              }}
            />
          </div>

          <div className="exclusiva-toggle">
            <input
              type="checkbox"
              id="exclusiva"
              name="exclusiva"
              checked={Boolean(formData.exclusiva)}
              onChange={handleChange}
              disabled={normCocheraFront(formData.cochera) !== "Fija"}
              title={normCocheraFront(formData.cochera) === "Fija" ? "Marcar como exclusiva" : "Disponible sÃ³lo para Cochera Fija"}
            />
            <label htmlFor="exclusiva">Exclusiva</label>
          </div>
        </div>

        <div className="grid-3cols">
          <div>
            <label>Nombre y Apellido</label>
            <input
              type="text"
              name="nombreApellido"
              value={formData.nombreApellido}
              onChange={handleChange}
              autoComplete="off"
              required
            />
          </div>
          <div>
            <label>DNI/CUIT/CUIL</label>
            <input
              type="text"
              name="dniCuitCuil"
              value={formData.dniCuitCuil}
              onChange={handleChange}
              required
            />
          </div>
          <div>
            <label>Email</label>
            <input
              type="email"
              name="email"
              value={formData.email}
              onChange={handleChange}
              required
            />
          </div>
          <div>
            <label>Domicilio</label>
            <input
              type="text"
              name="domicilio"
              value={formData.domicilio}
              onChange={handleChange}
              required
            />
          </div>
          <div>
            <label>Localidad</label>
            <input
              type="text"
              name="localidad"
              value={formData.localidad}
              onChange={handleChange}
              required
            />
          </div>
          <div>
            <label>Domicilio Trabajo</label>
            <input
              type="text"
              name="domicilioTrabajo"
              value={formData.domicilioTrabajo}
              onChange={handleChange}
            />
          </div>
          <div>
            <label>Tel. Particular</label>
            <input
              type="text"
              name="telefonoParticular"
              value={formData.telefonoParticular}
              onChange={handleChange}
            />
          </div>
          <div>
            <label>Tel. Emergencia</label>
            <input
              type="text"
              name="telefonoEmergencia"
              value={formData.telefonoEmergencia}
              onChange={handleChange}
            />
          </div>
          <div>
            <label>Tel. Trabajo</label>
            <input
              type="text"
              name="telefonoTrabajo"
              value={formData.telefonoTrabajo}
              onChange={handleChange}
            />
          </div>
        </div>

        <div className="grid-3cols fotos-grid">
          {renderFileInput("Foto Seguro", "fotoSeguro")}
          {renderFileInput("Foto DNI", "fotoDNI")}
          {renderFileInput("Foto CÃ©d. Verde", "fotoCedulaVerde")}
        </div>

        <div className="grid-3cols">
          <div>
            <label>Patente</label>
            <input
              type="text"
              name="patente"
              value={formData.patente}
              onChange={handleChange}
              maxLength={10}
              required
            />
          </div>
          <div>
            <label>Marca</label>
            <input type="text" name="marca" value={formData.marca} onChange={handleChange} />
          </div>
          <div>
            <label>Modelo</label>
            <input type="text" name="modelo" value={formData.modelo} onChange={handleChange} />
          </div>
          <div>
            <label>Color</label>
            <input type="text" name="color" value={formData.color} onChange={handleChange} />
          </div>
          <div>
            <label>AÃ±o</label>
            <input type="number" name="anio" value={formData.anio} onChange={handleChange} />
          </div>
          <div>
            <label>CompaÃ±Ã­a Seguro</label>
            <input
              type="text"
              name="companiaSeguro"
              value={formData.companiaSeguro}
              onChange={handleChange}
            />
          </div>
        </div>

        <div className="grid-3cols">
          <div>
            <label>MÃ©todo de Pago</label>
            <select
              name="metodoPago"
              value={formData.metodoPago}
              onChange={handleChange}
              className="select-style"
              required
            >
              <option value="Efectivo">Efectivo</option>
              <option value="Transferencia">Transferencia</option>
              <option value="DÃ©bito">DÃ©bito</option>
              <option value="CrÃ©dito">CrÃ©dito</option>
              <option value="QR">QR</option>
            </select>
          </div>
          <div>
            <label>Factura</label>
            <select
              name="factura"
              value={formData.factura}
              onChange={handleChange}
              className="select-style"
            >
              <option value="CC">CC</option>
              <option value="A">A</option>
              <option value="Final">Final</option>
            </select>
          </div>

          {/* ====== Select Tipo de VehÃ­culo (ABONO) ====== */}
          <div>
            <label>Tipo de VehÃ­culo</label>
            <select
              name="tipoVehiculo"
              value={formData.tipoVehiculo}
              onChange={handleChange}
              className="select-style"
              required
            >
              <option value="">Seleccione</option>
              {tiposVehiculo
                .filter((tipo) => tipo?.mensual === true)
                // ðŸ”¥ ORDEN: mÃ¡s caro arriba
                .sort((a, b) => {
                  const precioA = getAbonoPrecioByMetodo(
                    a.nombre,
                    formData.metodoPago,
                    formData.cochera || "MÃ³vil",
                    formData.cochera === "Fija" ? formData.exclusiva : false
                  ) || 0;

                  const precioB = getAbonoPrecioByMetodo(
                    b.nombre,
                    formData.metodoPago,
                    formData.cochera || "MÃ³vil",
                    formData.cochera === "Fija" ? formData.exclusiva : false
                  ) || 0;

                  return precioB - precioA; // â¬…ï¸ ahora el orden es DESC (caro â†’ barato)
                })
                .map((tipo) => {
                  const monthly = getAbonoPrecioByMetodo(
                    tipo.nombre,
                    formData.metodoPago,
                    formData.cochera || "MÃ³vil",
                    formData.cochera === "Fija" ? formData.exclusiva : false
                  );

                  const namePretty = tipo.nombre
                    ? tipo.nombre.charAt(0).toUpperCase() + tipo.nombre.slice(1)
                    : "";

                  const tierName = getTierName(formData.cochera || "MÃ³vil", formData.exclusiva);
                  const metodoCatalogo = formData.metodoPago === "Efectivo" ? "efectivo" : "otros";

                  return (
                    <option
                      key={tipo.nombre}
                      value={tipo.nombre}
                      title={`CatÃ¡logo (${metodoCatalogo}) â€¢ Tier: ${tierName}`}
                    >
                      {namePretty} â€” ${formatARS(monthly)}
                    </option>
                  );
                })}
            </select>
          </div>
        </div>

        <button type="submit" disabled={loading}>
          {loading ? "Guardando..." : "Guardar Abono"}
        </button>
      </form>

      {/* Modal informativo */}
      <ModalMensaje titulo={modal.titulo} mensaje={modal.mensaje} onClose={closeModal} />

      {/* Modal confirmaciÃ³n GENERAL */}
      <InlineConfirmModal
        open={confirmAbono.open}
        titulo={confirmAbono.titulo}
        mensaje={confirmAbono.mensaje}
        onConfirm={confirmAbono.onConfirm}
        onCancel={confirmAbono.onCancel}
      />

      {/* Modal confirmaciÃ³n â€œmÃ¡s caroâ€ */}
      {confirmModal.open && (
        <ModalMensaje
          titulo={confirmModal.titulo}
          mensaje={confirmModal.mensaje}
          onClose={confirmModal.onCancel}
        >
          <div style={{ display: "flex", gap: 8, justifyContent: "center", marginTop: 12 }}>
            <button className="guardarWebcamBtn" onClick={confirmModal.onCancel}>
              Cancelar
            </button>
            <button className="guardarWebcamBtn" onClick={confirmModal.onConfirm}>
              Aceptar y continuar
            </button>
          </div>
        </ModalMensaje>
      )}

      {/* Modal de CÃ¡mara */}
      {modalCamAbierto && (
        <ModalMensaje
          titulo="Webcam"
          mensaje={
            capturingField
              ? `Tomar foto para: ${capturingField.replace("foto", "Foto ")}`
              : "Vista previa de la cÃ¡mara"
          }
          onClose={cerrarModalCam}
        >
          <div style={{ textAlign: "center" }}>
            {!fotoPreview ? (
              <>
                <video
                  ref={videoRef}
                  autoPlay
                  playsInline
                  style={{ width: "320px", height: "240px", borderRadius: "6px", background: "#222" }}
                />
                <button className="guardarWebcamBtn" style={{ marginTop: "1rem" }} onClick={tomarFoto}>
                  Tomar Foto
                </button>
              </>
            ) : (
              <>
                <img src={fotoPreview} alt="Foto tomada" style={{ width: "320px", borderRadius: "6px" }} />
                <div style={{ display: "flex", gap: 8, justifyContent: "center", marginTop: 12 }}>
                  <button className="guardarWebcamBtn" onClick={repetirFoto}>
                    Repetir
                  </button>
                  <button className="guardarWebcamBtn" onClick={confirmarFoto}>
                    Confirmar
                  </button>
                </div>
              </>
            )}
          </div>
        </ModalMensaje>
      )}
    </div>
  );
}

export default DatosAutoAbono;



DatosAutoAbono.css:
.abono-container {
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #2a2a38;
  height: 600px;
  padding: 10px;
}
.abono-container h2 {
  color: rgb(255, 255, 255);
  font-size: 2rem;
  margin: 0;
  text-align: center;
}

.abono-form {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  height: 100%;
  justify-content: center;
}
.abono-form label {
  font-size: 0.8rem;
  color: #ccc;
  margin-bottom: 0rem;
  min-width: 104px;
}
.abono-form input[type="text"],
.abono-form input[type="email"],
.abono-form input[type="number"] {
  background-color: #1f1f28;
  border: 1px solid #444a5a;
  border-radius: 4px;
  padding: 0.4rem 0.5rem;
  color: white;
  width: 90%;
  outline: none;
  transition: border-color 0.3s;
}
.abono-form input:focus {
  border-color: rgb(100, 108, 133);
}
.abono-form input[type="number"] {
  background-color: #1f1f28;
  border: 1px solid #444a5a;
  border-radius: 4px;
  padding: 0.4rem 0.5rem;
  color: white;
  width: 90%;
  outline: none;
  transition: border-color 0.3s;
  -moz-appearance: textfield;
  appearance: textfield;
}
.abono-form input[type="number"]::-webkit-outer-spin-button,
.abono-form input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none; 
  margin: 0;
}
.abono-form button {
  background-color: #4caf50;
  border: none;
  border-radius: 4px;
  padding: 0.6rem;
  color: white;
  font-weight: bold;
  cursor: pointer;
  align-self: center;
  width: 50%;
  transition: background-color 0.3s;
}
.abono-form button:hover {
  background-color: #43a047;
}

.grid-3cols {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.4rem 1rem;
}

.grid-4cols {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
}

/* ---------- Subida de archivos / CÃ¡mara ---------- */
.file-label {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  padding: 0.2rem 0.7rem;
  background-color: #1f1f28;
  color: white;
  border: 1px solid #444a5a;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.85rem;
  transition: border-color 0.3s;
  width: fit-content;
  min-height: 2.5rem;
}
.file-label:hover { border-color: #888; }
.file-label input[type="file"] { display: none; }
.icon-wrapper { display: flex; align-items: center; justify-content: center; }
.icon { font-size: 1.3rem; color: #ccc; }
.file-text { display: flex; flex-direction: column; line-height: 1; justify-content: center; }
.file-input-wrapper { display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 0.3rem; width: 100%; }
.file-visible-label { font-size: 0.8rem; color: #ccc; margin-bottom: 0.1rem; text-align: center; }
.file-uploaded { display: flex; align-items: center; gap: 0.5rem; color: #4caf50; }
.file-name { font-size: 0.75rem; margin-top: 0.3rem; }

/* ---------- Grid especÃ­fico de fotos centradas ---------- */
.fotos-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr)); /* eran 4, ahora 3 */
  gap: 1rem;
  justify-items: center;
  align-items: center;
}

.select-style {
  background-color: #1f1f28;
  border: 1px solid #444a5a;
  border-radius: 4px;
  padding: 0.4rem 0.5rem;
  color: white;
  width: 90%;
  outline: none;
  appearance: none;
  font-size: 0.9rem;
}
.select-style:focus { border-color: rgb(100, 108, 133); }
.selectorTarifa{ display: flex; justify-content: center; }

.select-style-tarifa {
  background-color: #1f1f28;
  border: 1px solid #444a5a;
  border-radius: 4px;
  padding: 0.4rem 2.5rem 0.4rem 0.5rem;
  color: white;
  width: 90%;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  font-size: 1rem;
  font-weight: 600;
  text-align: center;
  text-align-last: center;
  background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  background-size: 1.5rem;
}
.select-style-tarifa:focus { border-color: rgb(100, 108, 133); }

.sugerencias-lista {
  list-style: none;
  margin: 0;
  padding: 0;
  max-height: 150px;
  overflow-y: auto;
  position: absolute;
  background: #444a5a;
  z-index: 10;
  width: 10%;
  font-size: 13px;
}
.sugerencia-item { padding: 3px; cursor: pointer; }
.sugerencia-item:hover { background-color:rgb(81, 87, 105); }

@media (max-height: 642px) { .abono-form { gap: 0.5rem; } }

/* ============================= */
/* NUEVO: barra superior cochera */
/* ============================= */

.cochera-row {
  --label-h: 18px; /* altura estÃ¡ndar del label para calcular el centrado */
  display: grid;
  grid-template-columns: 1fr 0.6fr auto;
  gap: 1rem;
  width: 100%;
  align-items: stretch; /* todas las celdas, misma altura */
}

.cochera-row .fullwidth {
  display: flex;
  flex-direction: column; /* label arriba, control abajo */
  min-width: 0;           /* permite encoger el contenido sin overflow */
}

.cochera-row .fullwidth label {
  display: block;
  height: var(--label-h);
  line-height: var(--label-h);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.cochera-row .fullwidth select,
.cochera-row .fullwidth input {
  width: 100%; /* ancho completo en esta fila */
}

/* Reutiliza tu estÃ©tica */
.select-style-wide {
  background-color: #1f1f28;
  border: 1px solid #444a5a;
  border-radius: 4px;
  padding: 0.4rem 0.5rem;
  color: white;
  width: 100%;
  outline: none;
  appearance: none;
  font-size: 0.9rem;
}
.select-style-wide:focus { border-color: rgb(100, 108, 133); }

.input-style-wide {
  background-color: #1f1f28;
  border: 1px solid #444a5a;
  border-radius: 4px;
  padding: 0.4rem 0.5rem;
  color: white;
  width: 100%;
  outline: none;
  transition: border-color 0.3s;
}
.input-style-wide:focus { border-color: rgb(100, 108, 133); }

/* Toggle "Exclusiva": centrado respecto del input (no del label) */
.exclusiva-toggle {
  display: flex;
  height: 100%;
  align-items: center;        /* centro vertical del contenedor */
  justify-content: flex-end;  /* alineado a la derecha */
  gap: 0.5rem;
  user-select: none;

  /* Desfase = 1/2 altura del label para que el centro coincida con el centro del input */
  padding-top: calc(var(--label-h) / 2);
}
.exclusiva-toggle input[type="checkbox"] {
  width: 1rem;
  height: 1rem;
  accent-color: #4caf50; /* modern browsers */
}
.exclusiva-toggle label { margin: 0; }

/* --- Fix overflow en fila de Cochera/Piso/Exclusiva --- */
.cochera-row .fullwidth .input-style-wide,
.cochera-row .fullwidth .select-style-wide {
  box-sizing: border-box;  /* incluye padding/borde en el 100% */
  max-width: 100%;
}
/* si el selector global de inputs (90%) te pisa el 100%, refuerza la especificidad */
.abono-form .cochera-row .fullwidth .input-style-wide { width: 100%; }

/* Responsive suave */
@media (max-width: 900px) {
  .cochera-row {
    grid-template-columns: 1fr 0.8fr 0.6fr;
    gap: 0.6rem;
  }
}
@media (max-width: 640px) {
  .cochera-row { grid-template-columns: 1fr; }
  .exclusiva-toggle {
    justify-content: flex-start; /* en mÃ³vil a la izquierda */
    padding-top: 0;              /* en mÃ³vil, apoya junto al label */
  }
}











